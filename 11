<!doctype html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è¸è©©éŠå”</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: 'Noto Serif TC', 'KaiTi', 'STKaiti', serif;
      background: linear-gradient(135deg, #a8d5e2 0%, #b3e5d8 100%);
      color: #2d5a5a;
      height: 100%;
      width: 100%;
      overflow: hidden;
    }

    .scene {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.8s ease, visibility 0s 0.8s;
    }

    .scene.active {
      opacity: 1;
      visibility: visible;
      transition: opacity 0.8s ease, visibility 0s 0s;
    }

    /* å°é¢å ´æ™¯ */
    .scene-cover {
      background: linear-gradient(135deg, #87CEEB 0%, #B0E0E6 100%);
    }

    .cover-title {
      font-size: 6em;
      color: #2d5a5a;
      margin-bottom: 80px;
      letter-spacing: 0.3em;
      text-shadow: 2px 2px 10px rgba(0,0,0,0.2);
      font-weight: bold;
    }

    .menu-buttons {
      display: flex;
      flex-direction: column;
      gap: 20px;
      align-items: center;
    }

    .menu-btn {
      padding: 15px 60px;
      font-size: 1.8em;
      background: linear-gradient(135deg, #5a8a8a 0%, #4a9d9d 100%);
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      letter-spacing: 0.3em;
      box-shadow: 0 5px 20px rgba(90,138,138,0.5);
      transition: all 0.3s ease;
    }

    .menu-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(90,138,138,0.7);
    }

    .menu-btn.secondary {
      background: linear-gradient(135deg, rgba(90,138,138,0.7) 0%, rgba(74,157,157,0.7) 100%);
    }

    /* é–‹å ´å ´æ™¯ */
    .scene-opening {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      flex-direction: column;
      padding: 40px;
    }

    .opening-text {
      max-width: 900px;
      padding: 40px;
      background: linear-gradient(135deg, rgba(139,69,19,0.8) 0%, rgba(101,67,33,0.8) 100%);
      border: 4px solid #d4af37;
      border-radius: 20px;
      margin-bottom: 30px;
      font-size: 1.8em;
      color: #e0f7fa;
      line-height: 2.5;
      text-align: justify;
      text-indent: 2em;
      letter-spacing: 0.15em;
    }

    /* æ—ç™½å‹•ç•« */
    .narration {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(135deg, rgba(0,0,0,0.85) 0%, rgba(20,20,20,0.85) 100%);
      color: #ffd700;
      padding: 25px 40px;
      border-radius: 15px;
      border: 3px solid #d4af37;
      font-size: 1.6em;
      max-width: 80%;
      text-align: center;
      z-index: 2500;
      pointer-events: none;
      letter-spacing: 0.15em;
      line-height: 1.8;
      box-shadow: 0 10px 40px rgba(0,0,0,0.8);
      animation: narrationFade 4s ease forwards;
    }

    @keyframes narrationFade {
      0% { opacity:0; transform: translate(-50%,20px); }
      10% { opacity:1; transform: translate(-50%,0); }
      85% { opacity:1; transform: translate(-50%,0); }
      100% { opacity:0; transform: translate(-50%,-20px); }
    }
  </style>
</head>
<body>

  <!-- å°é¢å ´æ™¯ -->
  <div class="scene scene-cover active">
    <div class="cover-title">è©©å¿ƒç©¿å”</div>
    <div class="menu-buttons">
      <button id="start-btn" class="menu-btn">é–‹å§‹éŠæˆ²</button>
      <button id="load-btn" class="menu-btn secondary">è®€æª”</button>
    </div>
  </div>

  <!-- é–‹å ´å ´æ™¯ -->
  <div class="scene scene-opening">
    <div class="opening-text">
      ä½ ç©¿è¶Šå›äº†å¤§å”ï¼Œé»ƒé¶´æ¨“çš„æ™¨å…‰æ˜ å…¥çœ¼ç°¾â€¦â€¦
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const startBtn = document.getElementById('start-btn');
      const loadBtn = document.getElementById('load-btn');

      const coverScene = document.querySelector('.scene-cover');
      const openingScene = document.querySelector('.scene-opening');

      startBtn.addEventListener('click', () => {
        coverScene.classList.remove('active');
        openingScene.classList.add('active');
        showNarration("ä½ ç©¿è¶Šå›äº†å¤§å”ï¼Œé»ƒé¶´æ¨“çš„æ™¨å…‰æ˜ å…¥çœ¼ç°¾â€¦â€¦");
      });

      loadBtn.addEventListener('click', () => {
        loadGame();
      });

      function showNarration(text) {
        const narrationEl = document.createElement('div');
        narrationEl.className = 'narration';
        narrationEl.textContent = text;
        document.body.appendChild(narrationEl);
        setTimeout(() => {
          narrationEl.remove();
        }, 4000);
      }

      function loadGame() {
        console.log("è®€æª”åŠŸèƒ½åŸ·è¡Œä¸­...");
        showNarration("å­˜æª”å·²è®€å–ï¼Œä½ å›åˆ°ä¸Šæ¬¡çš„ä½ç½®ã€‚");
      }
    });
  </script>

</body>
</html>
  /* åœ°åœ–å ´æ™¯ */
    .map-scene {
      padding: 2%;
      overflow-y: auto;
    }

    .map-container {
      max-width: 95%;
      width: 1600px;
      margin: 0 auto;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.08) 100%);
      border: 4px solid #5a8a8a;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .map-title {
      text-align: center;
      font-size: 3em;
      color: #2d5a5a;
      margin: 0 0 30px 0;
      letter-spacing: 0.3em;
      text-shadow: 0 2px 5px rgba(255, 255, 255, 0.5);
    }

    .map-svg {
      width: 100%;
      height: auto;
      min-height: 600px;
    }

    .location-marker {
      cursor: pointer;
      transition: transform 0.2s ease;
    }

    .location-marker:hover {
      transform: scale(1.08);
    }

    .location-marker circle {
      fill: #5a8a8a;
      stroke: #2d5a5a;
      stroke-width: 2;
      transition: all 0.3s ease;
    }

    .location-marker:hover circle {
      fill: #4a9d9d;
      filter: drop-shadow(0 0 8px rgba(74, 157, 157, 0.8));
    }

    .location-marker text {
      fill: #fff;
      font-size: 18px;
      font-weight: bold;
      text-anchor: middle;
      pointer-events: none;
    }

    /* åŸå¸‚é¸æ“‡åœ°åœ– */
    .city-select-container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .region-name {
      font-size: 3.5em;
      color: #2d5a5a;
      text-align: center;
      letter-spacing: 0.3em;
      text-shadow: 0 2px 10px rgba(255, 255, 255, 0.5);
      margin: 0 0 40px 0;
    }

    .city-select-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 30px;
      margin: 40px 0;
    }

    .city-select-card {
      height: 180px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .city-select-card:hover {
      transform: translateY(-8px);
    }

    .city-select-icon {
      font-size: 5em;
      margin-bottom: 15px;
    }

    .city-select-name {
      font-size: 2em;
      color: #2d5a5a;
      letter-spacing: 0.3em;
      text-align: center;
      text-shadow: 0 2px 5px rgba(255, 255, 255, 0.8);
    }

    /* åŸå¸‚åœ°åœ– */
    .city-map-container {
      max-width: 1600px;
      margin: 0 auto;
    }

    .city-map-header {
      text-align: center;
      margin-bottom: 30px;
    }

    .city-name {
      font-size: 3.5em;
      color: #2d5a5a;
      letter-spacing: 0.3em;
      text-shadow: 0 2px 10px rgba(255, 255, 255, 0.5);
      margin: 0 0 20px 0;
    }

    .city-locations {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 25px;
      margin: 40px 0;
    }

    .location-card {
      height: 180px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .location-card:hover {
      transform: translateY(-8px);
    }

    .location-card.locked {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .location-icon {
      font-size: 4em;
      margin-bottom: 15px;
    }

    .location-label {
      font-size: 1.6em;
      color: #2d5a5a;
      letter-spacing: 0.2em;
      text-align: center;
      text-shadow: 0 2px 5px rgba(255, 255, 255, 0.8);
    }

    .location-note {
      font-size: 1em;
      color: #666;
      margin-top: 8px;
      text-align: center;
    }

    /* è¡—å¸‚å ´æ™¯ */
    .market-scene {
      padding: 3%;
      overflow-y: auto;
    }

    .market-container {
      max-width: 1600px;
      margin: 0 auto;
    }

    .market-title {
      font-size: 3em;
      color: #2d5a5a;
      text-align: center;
      margin-bottom: 40px;
      letter-spacing: 0.3em;
      text-shadow: 0 2px 10px rgba(255, 255, 255, 0.5);
    }

    .market-shops {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 25px;
      margin: 40px 0;
    }

    .market-shop-card {
      height: 180px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .market-shop-card:hover {
      transform: translateY(-8px);
    }

    /* å•†åº—å ´æ™¯ */
    .shop-scene {
      padding: 3%;
      overflow-y: auto;
    }

    .shop-container {
      max-width: 1000px;
      margin: 0 auto;
      background: linear-gradient(135deg, rgba(139, 69, 19, 0.7) 0%, rgba(101, 67, 33, 0.7) 100%);
      border: 4px solid #d4af37;
      border-radius: 20px;
      padding: 40px;
    }

    .shop-title {
      font-size: 3em;
      color: #ffd700;
      text-align: center;
      margin-bottom: 20px;
      letter-spacing: 0.3em;
    }

    .shop-description {
      text-align: center;
      color: #b3e5d8;
      font-size: 1.4em;
      line-height: 1.8;
      margin-bottom: 25px;
      padding: 15px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 10px;
    }

    .money-display {
      text-align: center;
      font-size: 1.6em;
      color: #ffd700;
      margin: 20px 0;
      padding: 12px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 10px;
    }

    .shop-items {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 20px;
      margin: 30px 0;
    }

    .shop-item {
      background: rgba(0, 0, 0, 0.3);
      border: 2px solid #d4af37;
      border-radius: 10px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .shop-item:hover {
      background: rgba(212, 175, 55, 0.2);
      transform: scale(1.05);
    }

    .shop-item-icon {
      font-size: 3em;
      margin-bottom: 10px;
    }

    .shop-item-name {
      font-size: 1.4em;
      color: #b3e5d8;
      margin-bottom: 10px;
    }

    .shop-item-price {
      font-size: 1.2em;
      color: #ffd700;
    }

    /* è©©è©   å‹•å ´æ™¯ */
    .poetry-scene {
      padding: 3%;
      overflow-y: auto;
    }

    .poetry-container {
      max-width: 1000px;
      margin: 0 auto;
    }

    .poetry-description {
      background: linear-gradient(135deg, rgba(90, 138, 138, 0.4) 0%, rgba(74, 157, 157, 0.4) 100%);
      border: 3px solid #5a8a8a;
      border-radius: 15px;
      padding: 30px;
      margin-bottom: 30px;
      color: #e0f7fa;
      font-size: 1.7em;
      line-height: 2.2;
      text-align: center;
      letter-spacing: 0.12em;
    }

    .poetry-choices {
      display: flex;
      gap: 20px;
      margin-top: 30px;
      flex-wrap: wrap;
    }

    .choice-btn {
      flex: 1;
      min-width: 200px;
      padding: 25px;
      font-size: 1.7em;
      background: linear-gradient(135deg, rgba(90, 138, 138, 0.4) 0%, rgba(74, 157, 157, 0.4) 100%);
      border: 3px solid #5a8a8a;
      color: #e0f7fa;
      border-radius: 12px;
      cursor: pointer;
      font-family: 'Noto Serif TC', 'KaiTi', serif;
      letter-spacing: 0.2em;
      transition: all 0.3s ease;
      text-align: center;
    }

    .choice-btn:hover {
      background: linear-gradient(135deg, #5a8a8a 0%, #4a9d9d 100%);
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(90, 138, 138, 0.7);
    }

    /* ç™½å¹•è©©è©é¡¯ç¤º */
    .poetry-reveal-scene {
      background: #ffffff;
    }

    .poetry-reveal-container {
      max-width: 900px;
      text-align: center;
      padding: 40px;
    }

    .poetry-reveal-title {
      font-size: 3.2em;
      color: #2d5a5a;
      margin-bottom: 25px;
      letter-spacing: 0.3em;
      opacity: 0;
    }

    .poetry-reveal-author {
      font-size: 2em;
      color: #5a8a8a;
      margin-bottom: 50px;
      opacity: 0;
    }

    .poetry-reveal-verse {
      font-size: 2.6em;
      color: #2d5a5a;
      line-height: 2.8;
      letter-spacing: 0.35em;
      margin: 35px 0;
      opacity: 0;
    }

    .poetry-reveal-verse.show {
      animation: fadeInVerse 2.5s ease forwards;
    }

    @keyframes fadeInVerse {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .continue-btn {
      margin-top: 50px;
      padding: 20px 60px;
      font-size: 1.8em;
      background: linear-gradient(135deg, #5a8a8a 0%, #4a9d9d 100%);
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-family: 'Noto Serif TC', 'KaiTi', serif;
      letter-spacing: 0.2em;
      transition: all 0.3s ease;
      box-shadow: 0 5px 20px rgba(90, 138, 138, 0.5);
    }

    .continue-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(90, 138, 138, 0.7);
    }

    .back-btn {
      margin-top: 30px;
      padding: 18px 50px;
      font-size: 1.6em;
      background: linear-gradient(135deg, rgba(90, 90, 90, 0.8) 0%, rgba(70, 70, 70, 0.8) 100%);
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-family: 'Noto Serif TC', 'KaiTi', serif;
      letter-spacing: 0.2em;
      transition: all 0.3s ease;
    }

    .back-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
    }

    .input-error {
      color: #ff6b6b;
      font-size: 1.2em;
      margin-top: 15px;
      text-align: center;
    }

    /* åº—å°äºŒå‘½åå ´æ™¯ */
    .scene-naming {
      background: linear-gradient(135deg, #8b7355 0%, #6b5742 100%);
      flex-direction: column;
    }

    .naming-container {
      max-width: 800px;
      padding: 40px;
      background: linear-gradient(135deg, rgba(245, 222, 179, 0.95) 0%, rgba(222, 184, 135, 0.95) 100%);
      border: 4px solid #8b6f47;
      border-radius: 20px;
    }

    .waiter-scene-content {
      display: flex;
      align-items: center;
      gap: 30px;
      margin-bottom: 30px;
    }

    .waiter-character {
      width: 200px;
      height: 280px;
      flex-shrink: 0;
    }

    .waiter-dialogue {
      flex: 1;
      font-size: 1.8em;
      color: #2d5a5a;
      line-height: 2.2;
      letter-spacing: 0.15em;
      text-align: left;
      padding: 25px;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 15px;
      border: 3px solid #8b6f47;
    }

    @media (max-width: 768px) {
      .quest-panel {
        width: 220px;
      }

      .round-button {
        width: 60px;
        height: 60px;
      }

      .city-locations, .city-select-grid, .market-shops {
        grid-template-columns: repeat(3, 1fr);
      }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body><!-- éŠæˆ²UIç–ŠåŠ å±¤ -->
  <div class="game-ui-overlay" id="gameUI" style="display: none;">
   <div class="top-bar">
    <div class="info-box" id="seasonDisplay">
     æ˜¥å­£ ä¸Šæ—¬
    </div>
    <div class="info-box" id="actionDisplay">
     è¡Œå‹•é»: 5/5
    </div>
    <div class="info-box" id="moneyDisplay">
     ğŸ’° 100å…©
    </div>
   </div>
   <div class="quest-panel">
    <div class="quest-title">
     ä»»å‹™
    </div>
    <div class="quest-section">
     <div class="quest-section-header" onclick="toggleQuestSection('main')"><span>ğŸ¯ ä¸»ç·šä»»å‹™</span> <span id="mainToggle">â–¼</span>
     </div>
     <div class="quest-list" id="mainQuestList"></div>
    </div>
    <div class="quest-section">
     <div class="quest-section-header" onclick="toggleQuestSection('side')"><span>ğŸ“‹ æ”¯ç·šä»»å‹™</span> <span id="sideToggle">â–¼</span>
     </div>
     <div class="quest-list" id="sideQuestList"></div>
    </div>
   </div>
   <div class="bottom-buttons">
    <div class="round-button save" onclick="openSaveModal()">
     <div class="button-icon">
      ğŸ’¾
     </div>
     <div class="button-label">
      å­˜æª”
     </div>
    </div>
    <div class="round-button" onclick="openInventory()">
     <div class="button-icon">
      ğŸ’
     </div>
     <div class="button-label">
            
     </div>
    </div>
   </div>
  </div><!-- å­˜æª”æ¨¡æ…‹æ¡† -->
  <div class="modal-overlay" id="saveModal">
   <div class="modal-content"><button class="modal-close" onclick="closeSaveModal()">Ã—</button>
    <h2 class="modal-title">å­˜æª”</h2>
    <div class="save-input-group"><label class="save-input-label">å­˜æª”åç¨±ï¼š</label> <input type="text" class="save-input" id="saveNameInput" placeholder="è¼¸å…¥å­˜æª”åç¨±..." maxlength="30">
    </div>
    <div class="modal-buttons"><button class="modal-btn" onclick="confirmSave()">ç¢ºèªå­˜æª”</button> <button class="modal-btn cancel" onclick="closeSaveModal()">   æ¶ˆ</button>
    </div>
   </div>
  </div><!-- è®€æª”æ¨¡æ…‹æ¡† -->
  <div class="modal-overlay" id="loadModal">
   <div class="modal-content"><button class="modal-close" onclick="closeLoadModal()">Ã—</button>
    <h2 class="modal-title">è®€å–å­˜æª”</h2>
    <div class="save-list" id="saveList"></div>
    <div class="modal-buttons"><button class="modal-btn cancel" onclick="closeLoadModal()">å–æ¶ˆ</button>
    </div>
   </div>
  </div><!-- åŒ…è¢±æ¨¡æ…‹æ¡† -->
  <div class="modal-overlay" id="inventoryModal">
   <div class="modal-content"><button class="modal-close" onclick="closeInventory()">Ã—</button>
    <h2 class="modal-title">åŒ…è¢±</h2>
    <div class="money-display">
     æŒæœ‰éŠ€å…©ï¼š<span id="modalMoneyDisplay">100</span> å…©
    </div>
    <h3 style="color: #ffd700; font-size: 1.8em; margin: 20px 0;">èº«ä¸Šç‰©å“</h3>
    <div class="inventory-grid" id="inventoryGrid"></div>
    <div style="text-align: center; margin-top: 30px;"><button class="continue-btn" onclick="closeInventory()">é—œé–‰</button>
    </div>
   </div>
  </div>
  <div class="game-container" id="gameContainer"><!-- å ´æ™¯1: é–‹å ´åŠ‡æƒ… -->
   <div class="scene scene-opening" id="sceneOpening">
    <div class="opening-text">
     <p class="opening-paragraph">å¤§å”é–‹å…ƒç››ä¸–ï¼Œå¤©å¯¶å¹´é–“ã€‚é•·å®‰åŸå…§ç¹è¯å–§å›‚ï¼Œèƒ¡å•†çµ¡   ä¸çµ•ï¼Œå››æµ·è³“æœ‹é›²é›†ã€‚ä½ è‡ªå¹¼é£½è®€è©©æ›¸ï¼Œå¿ƒæ‡·éŠæ­·å¤©ä¸‹ã€çµäº¤åå£«ä¹‹å¿—ã€‚</p>
     <p class="opening-paragraph">æŸæ—¥ï¼Œä½ æ–¼æ›¸è‚†ä¸­å¶å¾—ã€Šå”è©©é¸é›†ã€‹æ®˜å·ï¼Œå…¶ä¸­è©©å¥é›‹æ°¸å‹•äººï¼Œä»¤ä½ å¿ƒé¦³ç¥å¾€ã€‚ä½ æ±ºæ„é›¢é–‹å®¶é„‰ï¼Œè¸ä¸Šè©©å¢ƒä¹‹æ—…ï¼Œå°‹è¨ªå¤§å”å„åœ°åå‹ï¼Œé«”æ‚Ÿè©©äººç­†ä¸‹çš„å±±å·é¢¨ç‰©â€¦â€¦</p>
     <p class="opening-paragraph">è‡¨è¡Œå‰ï¼Œæ¯è¦ªç‚ºä½ å‚™å¥½è¡Œå›Šï¼Œçˆ¶è¦ªè´ˆä½ ç™¾å…©éŠ€å­ã€‚ä½ èƒŒèµ·åŒ…è¢±ï¼Œè¸å‡ºå®¶é–€ï¼Œé–‹å•Ÿå±¬æ–¼è‡ªå·±çš„å‚³å¥‡ã€‚</p>
     <div style="text-align: center; margin-top: 30px;"><button class="continue-btn" onclick="goToNaming()">è¸ä¸Šæ—…é€”</button>
     </div>
    </div>
   </div><!-- å ´æ™¯2: åº—å°äºŒå‘½å -->
   <div class="scene scene-naming" id="sceneNaming">
    <div class="naming-container">
     <div class="waiter-scene-content"><!-- åº—å°äºŒè§’è‰² SVG -->
      <svg class="waiter-character" viewbox="0 0 200 280" xmlns="http://www.w3.org/2000/svg"><!-- èº«é«” --> <ellipse cx="100" cy="250" rx="50" ry="28" fill="#8B4513" /> <rect x="60" y="130" width="80" height="120" rx="12" fill="#D2691E" /> <!-- é ­éƒ¨ --> <circle cx="100" cy="60" r="35" fill="#FFE4C4" /> <!-- é ­é«®ï¼ˆé«®é«»ï¼‰ --> <circle cx="100" cy="35" r="18" fill="#2C1810" /> <rect x="92" y="28" width="16" height="10" fill="#2C1810" /> <!-- çœ¼ç› --> <circle cx="88" cy="58" r="4" fill="#000" /> <circle cx="112" cy="58" r="4" fill="#000" /> <!-- ç¬‘å®¹ --> <path d="M 85 72 Q 100 80 115 72" stroke="#000" stroke-width="3" fill="none" /> <!-- æ‰‹è‡‚ --> <rect x="35" y="140" width="20" height="60" rx="10" fill="#FFDAB9" /> <rect x="145" y="140" width="20" height="60" rx="10" fill="#FFDAB9" /> <!-- èŒ¶å£ºï¼ˆå·¦æ‰‹æ‹¿è‘—ï¼‰ --> <ellipse cx="30" cy="195" rx="15" ry="12" fill="#8B7355" /> <rect x="20" y="185" width="20" height="15" rx="3" fill="#A0826D" /> <path d="M 20 192 L 15 192 L 15 198 L 20 198" fill="#8B7355" /> <circle cx="30" cy="180" r="3" fill="#654321" /> <!-- èŒ¶æ¯ï¼ˆå³æ‰‹æ‹¿è‘—ï¼‰ --> <rect x="158" y="190" width="18" height="20" rx="2" fill="#FFF" stroke="#8B7355" stroke-width="2" /> <ellipse cx="167" cy="192" rx="9" ry="3" fill="#90EE90" /> <!--    è£™ --> <polygon points="70,140 130,140 135,250 65,250" fill="#FFF" opacity="0.7" stroke="#CCC" stroke-width="2" /> <!-- è…°å¸¶ --> <rect x="55" y="140" width="90" height="8" fill="#8B4513" />
      </svg>
      <div class="waiter-dialogue">
       ã€Œå®¢å®˜æ‚¨å¥½ï¼å°çš„æ˜¯é€™å®¢æ£§çš„åº—å°äºŒã€‚çœ‹æ‚¨é€™æ‰“æ‰®ï¼Œæ˜¯è¦å‡ºé é–€å§ï¼Ÿä¸çŸ¥å®¢å®˜å°Šå§“å¤§åï¼Ÿã€
      </div>
     </div>
     <div class="name-input-container"><input type="text" id="playerNameInput" class="name-input" placeholder="å‘Šè¨´åº—å°äºŒä½ çš„åå­—..." maxlength="10">
      <div id="nameError" class="input-error"></div>
      <div style="margin-top: 30px;"><button class="continue-btn" onclick="confirmName()">å‘Šè¨´åº—å°äºŒ</button>
      </div>
     </div>
    </div>
   </div><!-- å ´æ™¯3:    é¢é  -->
   <div class="scene scene-cover active" id="sceneCover">
    <h1 class="cover-title" id="gameTitle">è¸è©©éŠå”</h1>
    <div class="menu-buttons"><button class="menu-btn" onclick="startNewGame()">é–‹å§‹éŠæˆ²</button> <button class="menu-btn secondary" onclick="openLoadModal()">è®€å–å­˜æª”</button>
    </div>
   </div><!-- å…¶ä»–å ´æ™¯ä¿æŒä¸è®Š... -->
  </div>
  <script>
    // JavaScript code remains the same
    const defaultConfig = { game_title: "è¸è©©éŠå”" };
    // ... rest of JavaScript code ...
  </script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è¸è©©éŠå”</title>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <style>
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Noto Serif TC', 'KaiTi', 'STKaiti', serif;
      background: linear-gradient(135deg, #a8d5e2 0%, #b3e5d8 100%);
      color: #2d5a5a;
      height: 100%;
      width: 100%;
      overflow: hidden;
    }

    html {
      height: 100%;
    }

    .game-ui-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1000;
    }

    .top-bar {
      position: fixed;
      top: 20px;
      right: 20px;
      display: flex;
      gap: 15px;
      pointer-events: auto;
    }

    .info-box {
      background: linear-gradient(135deg, rgba(139, 69, 19, 0.9) 0%, rgba(101, 67, 33, 0.9) 100%);
      border: 3px solid #d4af37;
      border-radius: 12px;
      padding: 12px 20px;
      color: #ffd700;
      font-size: 1.3em;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
      letter-spacing: 0.1em;
    }

    .quest-panel {
      position: fixed;
      left: 20px;
      top: 20px;
      width: 280px;
      max-height: 80%;
      background: linear-gradient(135deg, rgba(139, 69, 19, 0.95) 0%, rgba(101, 67, 33, 0.95) 100%);
      border: 3px solid #d4af37;
      border-radius: 15px;
      padding: 20px;
      pointer-events: auto;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
      overflow-y: auto;
    }

    .quest-title {
      font-size: 1.8em;
      color: #ffd700;
      text-align: center;
      margin-bottom: 20px;
      letter-spacing: 0.2em;
      border-bottom: 2px solid #d4af37;
      padding-bottom: 10px;
    }

    .quest-section {
      margin: 15px 0;
    }

    .quest-section-header {
      font-size: 1.4em;
      color: #ffeb3b;
      margin-bottom: 10px;
      letter-spacing: 0.1em;
      cursor: pointer;
      padding: 10px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .quest-section-header:hover {
      background: rgba(212, 175, 55, 0.2);
    }

    .quest-list {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }

    .quest-list.expanded {
      max-height: 500px;
    }

    .quest-item {
      background: rgba(0, 0, 0, 0.3);
      padding: 10px;
      margin: 8px 0;
      border-radius: 8px;
      border-left: 3px solid #ffd700;
      font-size: 1.1em;
      color: #b3e5d8;
      line-height: 1.6;
    }

    .quest-item.completed {
      opacity: 0.6;
      border-left-color: #4caf50;
    }

    .bottom-buttons {
      position: fixed;
      right: 20px;
      bottom: 20px;
      display: flex;
      gap: 15px;
      pointer-events: auto;
    }

    .round-button {
      width: 75px;
      height: 75px;
      background: linear-gradient(135deg, rgba(139, 69, 19, 0.9) 0%, rgba(101, 67, 33, 0.9) 100%);
      border: 3px solid #d4af37;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
      transition: all 0.3s ease;
    }

    .round-button:hover {
      transform: scale(1.1);
      box-shadow: 0 8px 25px rgba(212, 175, 55, 0.8);
    }

    .round-button.save {
      background: linear-gradient(135deg, rgba(90, 138, 138, 0.9) 0%, rgba(74, 157, 157, 0.9) 100%);
      border-color: #5a8a8a;
    }

    .button-icon {
      font-size: 2.2em;
    }

    .button-label {
      font-size: 0.95em;
      color: #ffd700;
      margin-top: 3px;
    }

    .narration {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(135deg, rgba(0, 0, 0, 0.85) 0%, rgba(20, 20, 20, 0.85) 100%);
      color: #ffd700;
      padding: 25px 40px;
      border-radius: 15px;
      border: 3px solid #d4af37;
      font-size: 1.6em;
      max-width: 80%;
      text-align: center;
      z-index: 2500;
      pointer-events: none;
      letter-spacing: 0.15em;
      line-height: 1.8;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.8);
      animation: narrationFade 4s ease forwards;
    }

    @keyframes narrationFade {
      0% { opacity: 0; transform: translate(-50%, 20px); }
      10% { opacity: 1; transform: translate(-50%, 0); }
      85% { opacity: 1; transform: translate(-50%, 0); }
      100% { opacity: 0; transform: translate(-50%, -20px); }
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      pointer-events: auto;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal-content {
      background: linear-gradient(135deg, rgba(139, 69, 19, 0.98) 0%, rgba(101, 67, 33, 0.98) 100%);
      border: 4px solid #d4af37;
      border-radius: 20px;
      padding: 40px;
      max-width: 900px;
      max-height: 85%;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.9);
      position: relative;
    }

    .modal-title {
      font-size: 2.5em;
      color: #ffd700;
      text-align: center;
      margin-bottom: 30px;
      letter-spacing: 0.3em;
    }

    .modal-close {
      position: absolute;
      top: 15px;
      right: 20px;
      font-size: 2.5em;
      color: #ffd700;
      cursor: pointer;
      background: none;
      border: none;
      padding: 5px 15px;
      line-height: 1;
    }

    .modal-close:hover {
      color: #fff;
    }

    .save-input-group {
      margin: 25px 0;
    }

    .save-input-label {
      display: block;
      color: #ffd700;
      font-size: 1.5em;
      margin-bottom: 10px;
      letter-spacing: 0.1em;
    }

    .save-input {
      width: 100%;
      padding: 15px;
      font-size: 1.4em;
      background: rgba(0, 0, 0, 0.3);
      border: 2px solid #d4af37;
      border-radius: 10px;
      color: #b3e5d8;
      font-family: 'Noto Serif TC', 'KaiTi', serif;
    }

    .save-list {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin: 20px 0;
      max-height: 400px;
      overflow-y: auto;
    }

    .save-item {
      background: rgba(0, 0, 0, 0.3);
      border: 2px solid #d4af37;
      border-radius: 10px;
      padding: 20px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .save-item:hover {
      background: rgba(212, 175, 55, 0.2);
      transform: translateX(5px);
    }

    .save-item-name {
      font-size: 1.6em;
      color: #ffd700;
      margin-bottom: 8px;
    }

    .save-item-info {
      font-size: 1.2em;
      color: #b3e5d8;
      line-height: 1.6;
    }

    .modal-buttons {
      display: flex;
      gap: 20px;
      justify-content: center;
      margin-top: 30px;
    }

    .modal-btn {
      padding: 15px 40px;
      font-size: 1.6em;
      background: linear-gradient(135deg, #5a8a8a 0%, #4a9d9d 100%);
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-family: 'Noto Serif TC', 'KaiTi', serif;
      letter-spacing: 0.2em;
      transition: all 0.3s ease;
    }

    .modal-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(90, 138, 138, 0.7);
    }

    .modal-btn.cancel {
      background: linear-gradient(135deg, rgba(90, 90, 90, 0.8) 0%, rgba(70, 70, 70, 0.8) 100%);
    }

    .inventory-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }

    .inventory-item {
      background: rgba(0, 0, 0, 0.3);
      border: 2px solid #d4af37;
      border-radius: 10px;
      padding: 15px;
      text-align: center;
    }

    .item-icon {
      font-size: 2.5em;
      margin-bottom: 10px;
    }

    .item-name {
      font-size: 1.2em;
      color: #b3e5d8;
      margin-bottom: 5px;
    }

    .item-value {
      font-size: 1em;
      color: #ffd700;
    }

    .game-container {
      width: 100%;
      height: 100%;
      position: relative;
      transition: background 1s ease;
    }

    .scene {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.8s ease, visibility 0s 0.8s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .scene.active {
      opacity: 1;
      visibility: visible;
      transition: opacity 0.8s ease, visibility 0s 0s;
    }

    /* é–‹å ´å ´æ™¯ */
    .scene-opening {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      flex-direction: column;
    }

    .opening-text {
      max-width: 900px;
      padding: 40px;
      background: linear-gradient(135deg, rgba(139, 69, 19, 0.8) 0%, rgba(101, 67, 33, 0.8) 100%);
      border: 4px solid #d4af37;
      border-radius: 20px;
      margin-bottom: 30px;
    }

    .opening-paragraph {
      font-size: 1.8em;
      color: #e0f7fa;
      line-height: 2.5;
      letter-spacing: 0.15em;
      margin: 25px 0;
      text-align: justify;
      text-indent: 2em;
    }

    .name-input-container {
      text-align: center;
      margin-top: 30px;
    }

    .name-input-label {
      font-size: 2em;
      color: #ffd700;
      margin-bottom: 20px;
      letter-spacing: 0.2em;
      display: block;
    }

    .name-input {
      padding: 20px 30px;
      font-size: 2em;
      background: rgba(0, 0, 0, 0.4);
      border: 3px solid #d4af37;
      border-radius: 10px;
      color: #ffd700;
      font-family: 'Noto Serif TC', 'KaiTi', serif;
      text-align: center;
      letter-spacing: 0.2em;
      min-width: 300px;
    }

    /* å°é¢é  */
    .scene-cover {
      background: linear-gradient(135deg, #87CEEB 0%, #B0E0E6 100%);
      flex-direction: column;
    }

    .cover-title {
      font-size: 6em;
      color: #2d5a5a;
      margin-bottom: 80px;
      letter-spacing: 0.3em;
      text-shadow: 2px 2px 10px rgba(0, 0, 0, 0.2);
      font-weight: bold;
    }

    .menu-buttons {
      display: flex;
      flex-direction: column;
      gap: 20px;
      align-items: center;
    }

    .menu-btn {
      padding: 15px 60px;
      font-size: 1.8em;
      background: linear-gradient(135deg, #5a8a8a 0%, #4a9d9d 100%);
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-family: 'Noto Serif TC', 'KaiTi', serif;
      letter-spacing: 0.3em;
      transition: all 0.3s ease;
      box-shadow: 0 5px 20px rgba(90, 138, 138, 0.5);
    }

    .menu-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(90, 138, 138, 0.7);
    }

    .menu-btn.secondary {
      background: linear-gradient(135deg, rgba(90, 138, 138, 0.7) 0%, rgba(74, 157, 157, 0.7) 100%);
    }

    /*   åœ–å ´æ™¯ */
    .map-scene {
      padding: 2%;
      overflow-y: auto;
    }

    .map-container {
      max-width: 95%;
      width: 1600px;
      margin: 0 auto;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.08) 100%);
      border: 4px solid #5a8a8a;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .map-title {
      text-align: center;
      font-size: 3em;
      color: #2d5a5a;
      margin: 0 0 30px 0;
      letter-spacing: 0.3em;
      text-shadow: 0 2px 5px rgba(255, 255, 255, 0.5);
    }

    .map-svg {
      width: 100%;
      height: auto;
      min-height: 600px;
    }

    .location-marker {
      cursor: pointer;
      transition: transform 0.2s ease;
    }

    .location-marker:hover {
      transform: scale(1.08);
    }

    .location-marker circle {
      fill: #5a8a8a;
      stroke: #2d5a5a;
      stroke-width: 2;
      transition: all 0.3s ease;
    }

    .location-marker:hover circle {
      fill: #4a9d9d;
      filter: drop-shadow(0 0 8px rgba(74, 157, 157, 0.8));
    }

    .location-marker text {
      fill: #fff;
      font-size: 18px;
      font-weight: bold;
      text-anchor: middle;
      pointer-events: none;
    }

    /* åŸå¸‚é¸æ“‡åœ°   */
    .city-select-container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .region-name {
      font-size: 3.5em;
      color: #2d5a5a;
      text-align: center;
      letter-spacing: 0.3em;
      text-shadow: 0 2px 10px rgba(255, 255, 255, 0.5);
      margin: 0 0 40px 0;
    }

    .city-select-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 30px;
      margin: 40px 0;
    }

    .city-select-card {
      height: 180px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .city-select-card:hover {
      transform: translateY(-8px);
    }

    .city-select-icon {
      font-size: 5em;
      margin-bottom: 15px;
    }

    .city-select-name {
      font-size: 2em;
      color: #2d5a5a;
      letter-spacing: 0.3em;
      text-align: center;
      text-shadow: 0 2px 5px rgba(255, 255, 255, 0.8);
    }

    /* åŸå¸‚åœ°åœ– */
    .city-map-container {
      max-width: 1600px;
      margin: 0 auto;
    }

    .city-map-header {
      text-align: center;
      margin-bottom: 30px;
    }

    .city-name {
      font-size: 3.5em;
      color: #2d5a5a;
      letter-spacing: 0.3em;
      text-shadow: 0 2px 10px rgba(255, 255, 255, 0.5);
      margin: 0 0 20px 0;
    }

    .city-locations {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 25px;
      margin: 40px 0;
    }

    .location-card {
      height: 180px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .location-card:hover {
      transform: translateY(-8px);
    }

    .location-card.locked {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .location-icon {
      font-size: 4em;
      margin-bottom: 15px;
    }

    .location-label {
      font-size: 1.6em;
      color: #2d5a5a;
      letter-spacing: 0.2em;
      text-align: center;
      text-shadow: 0 2px 5px rgba(255, 255, 255, 0.8);
    }

    .location-note {
      font-size: 1em;
      color: #666;
      margin-top: 8px;
      text-align: center;
    }

    /* è¡—å¸‚å ´æ™¯ */
    .market-scene {
      padding: 3%;
      overflow-y: auto;
    }

    .market-container {
      max-width: 1600px;
      margin: 0 auto;
    }

    .market-title {
      font-size: 3em;
      color: #2d5a5a;
      text-align: center;
      margin-bottom: 40px;
      letter-spacing: 0.3em;
      text-shadow: 0 2px 10px rgba(255, 255, 255, 0.5);
    }

    .market-shops {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 25px;
      margin: 40px 0;
    }

    .market-shop-card {
      height: 180px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .market-shop-card:hover {
      transform: translateY(-8px);
    }

    /* å•†åº—å ´æ™¯ */
    .shop-scene {
      padding: 3%;
      overflow-y: auto;
    }

    .shop-container {
      max-width: 1000px;
      margin: 0 auto;
      background: linear-gradient(135deg, rgba(139, 69, 19, 0.7) 0%, rgba(101, 67, 33, 0.7) 100%);
      border: 4px solid #d4af37;
      border-radius: 20px;
      padding: 40px;
    }

    .shop-title {
      font-size: 3em;
      color: #ffd700;
      text-align: center;
      margin-bottom: 20px;
      letter-spacing: 0.3em;
    }

    .shop-description {
      text-align: center;
      color: #b3e5d8;
      font-size: 1.4em;
      line-height: 1.8;
      margin-bottom: 25px;
      padding: 15px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 10px;
    }

    .money-display {
      text-align: center;
      font-size: 1.6em;
      color: #ffd700;
      margin: 20px 0;
      padding: 12px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 10px;
    }

    .shop-items {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 20px;
      margin: 30px 0;
    }

    .shop-item {
      background: rgba(0, 0, 0, 0.3);
      border: 2px solid #d4af37;
      border-radius: 10px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .shop-item:hover {
      background: rgba(212, 175, 55, 0.2);
      transform: scale(1.05);
    }

    .shop-item-icon {
      font-size: 3em;
      margin-bottom: 10px;
    }

    .shop-item-name {
      font-size: 1.4em;
      color: #b3e5d8;
      margin-bottom: 10px;
    }

    .shop-item-price {
      font-size: 1.2em;
      color: #ffd700;
    }

    /* è©©è©äº’å‹•å ´æ™¯ */
    .poetry-scene {
      padding: 3%;
      overflow-y: auto;
    }

    .poetry-container {
      max-width: 1000px;
      margin: 0 auto;
    }

    .poetry-description {
      background: linear-gradient(135deg, rgba(90, 138, 138, 0.4) 0%, rgba(74, 157, 157, 0.4) 100%);
      border: 3px solid #5a8a8a;
      border-radius: 15px;
      padding: 30px;
      margin-bottom: 30px;
      color: #e0f7fa;
      font-size: 1.7em;
      line-height: 2.2;
      text-align: center;
      letter-spacing: 0.12em;
    }

    .poetry-choices {
      display: flex;
      gap: 20px;
      margin-top: 30px;
      flex-wrap: wrap;
    }

    .choice-btn {
      flex: 1;
      min-width: 200px;
      padding: 25px;
      font-size: 1.7em;
      background: linear-gradient(135deg, rgba(90, 138, 138, 0.4) 0%, rgba(74, 157, 157, 0.4) 100%);
      border: 3px solid #5a8a8a;
      color: #e0f7fa;
      border-radius: 12px;
      cursor: pointer;
      font-family: 'Noto Serif TC', 'KaiTi', serif;
      letter-spacing: 0.2em;
      transition: all 0.3s ease;
      text-align: center;
    }

    .choice-btn:hover {
      background: linear-gradient(135deg, #5a8a8a 0%, #4a9d9d 100%);
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(90, 138, 138, 0.7);
    }

    /* ç™½å¹•è©©è©é¡¯ç¤º */
    .poetry-reveal-scene {
      background: #ffffff;
    }

    .poetry-reveal-container {
      max-width: 900px;
      text-align: center;
      padding: 40px;
    }

    .poetry-reveal-title {
      font-size: 3.2em;
      color: #2d5a5a;
      margin-bottom: 25px;
      letter-spacing: 0.3em;
      opacity: 0;
    }

    .poetry-reveal-author {
      font-size: 2em;
      color: #5a8a8a;
      margin-bottom: 50px;
      opacity: 0;
    }

    .poetry-reveal-verse {
      font-size: 2.6em;
      color: #2d5a5a;
      line-height: 2.8;
      letter-spacing: 0.35em;
      margin: 35px 0;
      opacity: 0;
    }

    .poetry-reveal-verse.show {
      animation: fadeInVerse 2.5s ease forwards;
    }

    @keyframes fadeInVerse {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .continue-btn {
      margin-top: 50px;
      padding: 20px 60px;
      font-size: 1.8em;
      background: linear-gradient(135deg, #5a8a8a 0%, #4a9d9d 100%);
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-family: 'Noto Serif TC', 'KaiTi', serif;
      letter-spacing: 0.2em;
      transition: all 0.3s ease;
      box-shadow: 0 5px 20px rgba(90, 138, 138, 0.5);
    }

    .continue-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(90, 138, 138, 0.7);
    }

    .back-btn {
      margin-top: 30px;
      padding: 18px 50px;
      font-size: 1.6em;
      background: linear-gradient(135deg, rgba(90, 90, 90, 0.8) 0%, rgba(70, 70, 70, 0.8) 100%);
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-family: 'Noto Serif TC', 'KaiTi', serif;
      letter-spacing: 0.2em;
      transition: all 0.3s ease;
    }

    .back-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
    }

    .input-error {
      color: #ff6b6b;
      font-size: 1.2em;
      margin-top: 15px;
      text-align: center;
    }

    /* åº—å°äºŒå‘½åå ´æ™¯ */
    .scene-naming {
      background: linear-gradient(135deg, #8b7355 0%, #6b5742 100%);
      flex-direction: column;
    }

    .naming-container {
      max-width: 800px;
      padding: 40px;
      background: linear-gradient(135deg, rgba(245, 222, 179, 0.95) 0%, rgba(222, 184, 135, 0.95) 100%);
      border: 4px solid #8b6f47;
      border-radius: 20px;
    }

    .waiter-scene-content {
      display: flex;
      align-items: center;
      gap: 30px;
      margin-bottom: 30px;
    }

    .waiter-character {
      width: 200px;
      height: 280px;
      flex-shrink: 0;
    }

    .waiter-dialogue {
      flex: 1;
      font-size: 1.8em;
      color: #2d5a5a;
      line-height: 2.2;
      letter-spacing: 0.15em;
      text-align: left;
      padding: 25px;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 15px;
      border: 3px solid #8b6f47;
    }

    @media (max-width: 768px) {
      .quest-panel {
        width: 220px;
      }

      .round-button {
        width: 60px;
        height: 60px;
      }

      .city-locations, .city-select-grid, .market-shops {
        grid-template-columns: repeat(3, 1fr);
      }
    }
  </style> <!-- éŠæˆ²UIç–ŠåŠ å±¤ -->
  <div class="game-ui-overlay" id="gameUI" style="display: none;">
   <div class="top-bar">
    <div class="info-box" id="seasonDisplay">
     æ˜¥å­£ ä¸Šæ—¬
    </div>
    <div class="info-box" id="actionDisplay">
     è¡Œå‹•é»: 5/5
    </div>
    <div class="info-box" id="moneyDisplay">
     ğŸ’° 100   
    </div>
   </div>
   <div class="quest-panel">
    <div class="quest-title">
       å‹™
    </div>
    <div class="quest-section">
     <div class="quest-section-header" onclick="toggleQuestSection('main')"><span>ğŸ¯ ä¸»ç·šä»»å‹™</span> <span id="mainToggle">â–¼</span>
     </div>
     <div class="quest-list" id="mainQuestList"></div>
    </div>
    <div class="quest-section">
     <div class="quest-section-header" onclick="toggleQuestSection('side')"><span>ğŸ“‹ æ”¯ç·šä»»å‹™</span> <span id="sideToggle">â–¼</span>
     </div>
     <div class="quest-list" id="sideQuestList"></div>
    </div>
   </div>
   <div class="bottom-buttons">
    <div class="round-button save" onclick="openSaveModal()">
     <div class="button-icon">
      ğŸ’¾
     </div>
     <div class="button-label">
      å­˜æª”
     </div>
    </div>
    <div class="round-button" onclick="openInventory()">
     <div class="button-icon">
      ğŸ’
     </div>
     <div class="button-label">
      åŒ…è¢±
     </div>
    </div>
   </div>
  </div><!-- å­˜æª”æ¨¡æ…‹æ¡† -->
  <div class="modal-overlay" id="saveModal">
   <div class="modal-content"><button class="modal-close" onclick="closeSaveModal()">Ã—</button>
    <h2 class="modal-title">  æª”</h2>
    <div class="save-input-group"><label class="save-input-label">å­˜æª”åç¨±ï¼š</label> <input type="text" class="save-input" id="saveNameInput" placeholder="è¼¸å…¥å­˜æª”åç¨±..." maxlength="30">
    </div>
    <div class="modal-buttons"><button class="modal-btn" onclick="confirmSave()">ç¢ºèªå­˜æª”</button> <button class="modal-btn cancel" onclick="closeSaveModal()">å–æ¶ˆ</button>
    </div>
   </div>
  </div><!-- è®€æª”æ¨¡æ…‹æ¡† -->
  <div class="modal-overlay" id="loadModal">
   <div class="modal-content"><button class="modal-close" onclick="closeLoadModal()">Ã—</button>
    <h2 class="modal-title">è®€å–å­˜æª”</h2>
    <div class="save-list" id="saveList"></div>
    <div class="modal-buttons"><button class="modal-btn cancel" onclick="closeLoadModal()">å–æ¶ˆ</button>
    </div>
   </div>
  </div><!-- åŒ…è¢±æ¨¡æ…‹æ¡† -->
  <div class="modal-overlay" id="inventoryModal">
   <div class="modal-content"><button class="modal-close" onclick="closeInventory()">Ã—</button>
    <h2 class="modal-title">åŒ…è¢±</h2>
    <div class="money-display">
     æŒæœ‰éŠ€å…©ï¼š<span id="modalMoneyDisplay">100</span> å…©
    </div>
    <h3 style="color: #ffd700; font-size: 1.8em; margin: 20px 0;">èº«ä¸Šç‰©å“</h3>
    <div class="inventory-grid" id="inventoryGrid"></div>
    <div style="text-align: center; margin-top: 30px;"><button class="continue-btn" onclick="closeInventory()">é—œé–‰</button>
    </div>
   </div>
  </div>
  <div class="game-container" id="gameContainer"><!-- å ´æ™¯1: é–‹å ´åŠ‡æƒ… -->
   <div class="scene scene-opening" id="sceneOpening">
    <div class="opening-text">
     <p class="opening-paragraph">å¤§å”é–‹å…ƒç››ä¸–ï¼Œå¤©å¯¶å¹´é–“ã€‚é•·å®‰åŸå…§ç¹è¯å–§     èƒ¡å•†çµ¡ç¹¹ä¸çµ•ï¼Œå››æµ·è³“æœ‹é›²é›†ã€‚ä½   å¹¼é£½è®€è©©æ›¸ï¼Œå¿ƒæ‡·éŠæ­·å¤©ä¸‹ã€çµäº¤åå£«ä¹‹å¿—ã€‚</p>
     <p class="opening-paragraph">æŸæ—¥ï¼Œä½ æ–¼æ›¸è‚†ä¸­å¶å¾—ã€Šå”è©©é¸é›†ã€‹æ®˜å·ï¼Œå…¶ä¸­è©©å¥é›‹æ°¸å‹•äººï¼Œä»¤ä½ å¿ƒé¦³ç¥å¾€ã€‚ä½ æ±ºæ„é›¢é–‹å®¶é„‰ï¼Œè¸ä¸Šè©©å¢ƒä¹‹æ—…ï¼Œå°‹è¨ªå¤§å”å„åœ°åå‹ï¼Œé«”æ‚Ÿè©©äººç­†ä¸‹çš„å±±å·é¢¨ç‰©â€¦â€¦</p>
     <p class="opening-paragraph">è‡¨è¡Œå‰ï¼Œæ¯   ç‚ºä½ å‚™å¥½è¡Œ   ï¼Œçˆ¶è¦ªè´ˆä½ ç™¾å…©éŠ€å­ã€‚ä½ èƒŒèµ·åŒ…è¢±ï¼Œè¸å‡ºå®¶é–€ï¼Œé–‹å•Ÿå±¬æ–¼è‡ªå·±çš„å‚³å¥‡ã€‚</p>
     <div style="text-align: center; margin-top: 30px;"><button class="continue-btn" onclick="goToNaming()">è¸ä¸Šæ—…é€”</button>
     </div>
    </div>
   </div><!-- å ´æ™¯2: åº—å°äºŒå‘½å -->
   <div class="scene scene-naming" id="sceneNaming">
    <div class="naming-container">
     <div class="waiter-scene-content"><!-- åº—å°äºŒè§’è‰² SVG -->
      <svg class="waiter-character" viewbox="0 0 200 280" xmlns="http://www.w3.org/2000/svg"><!-- èº«é«” --> <ellipse cx="100" cy="250" rx="50" ry="28" fill="#8B4513" /> <rect x="60" y="130" width="80" height="120" rx="12" fill="#D2691E" /> <!-- é ­éƒ¨ --> <circle cx="100" cy="60" r="35" fill="#FFE4C4" /> <!-- é ­é«®ï¼ˆé«®   ï¼‰ --> <circle cx="100" cy="35" r="18" fill="#2C1810" /> <rect x="92" y="28" width="16" height="10" fill="#2C1810" /> <!-- çœ¼ç› --> <circle cx="88" cy="58" r="4" fill="#000" /> <circle cx="112" cy="58" r="4" fill="#000" /> <!-- ç¬‘å®¹ --> <path d="M 85 72 Q 100 80 115 72" stroke="#000" stroke-width="3" fill="none" /> <!-- æ‰‹è‡‚ --> <rect x="35" y="140" width="20" height="60" rx="10" fill="#FFDAB9" /> <rect x="145" y="140" width="20" height="60" rx="10" fill="#FFDAB9" /> <!-- èŒ¶å£ºï¼ˆå·¦æ‰‹æ‹¿è‘—ï¼‰ --> <ellipse cx="30" cy="195" rx="15" ry="12" fill="#8B7355" /> <rect x="20" y="185" width="20" height="15" rx="3" fill="#A0826D" /> <path d="M 20 192 L 15 192 L 15 198 L 20 198" fill="#8B7355" /> <circle cx="30" cy="180" r="3" fill="#654321" /> <!-- èŒ¶æ¯ï¼ˆå³æ‰‹æ‹¿è‘—ï¼‰ --> <rect x="158" y="190" width="18" height="20" rx="2" fill="#FFF" stroke="#8B7355" stroke-width="2" /> <ellipse cx="167" cy="192" rx="9" ry="3" fill="#90EE90" /> <!-- åœè£™ --> <polygon points="70,140 130,140 135,250 65,250" fill="#FFF" opacity="0.7" stroke="#CCC" stroke-width="2" /> <!-- è…°å¸¶ --> <rect x="55" y="140" width="90" height="8" fill="#8B4513" />
      </svg>
      <div class="waiter-dialogue">
       ã€Œå®¢å®˜æ‚¨å¥½ï¼å°çš„æ˜¯é€™å®¢æ£§çš„åº—å°äºŒã€‚çœ‹æ‚¨é€™æ‰“æ‰®  æ˜¯è¦å‡ºé é–€å§ï¼Ÿä¸çŸ¥å®¢å®˜å°Šå§“å¤§åï¼Ÿã€
      </div>
     </div>
     <div class="name-input-container"><input type="text" id="playerNameInput" class="name-input" placeholder="å‘Šè¨´åº—å°äºŒä½ çš„åå­—..." maxlength="10">
      <div id="nameError" class="input-error"></div>
      <div style="margin-top: 30px;"><button class="continue-btn" onclick="confirmName()">å‘Šè¨´åº—å°äºŒ</button>
      </div>
     </div>
    </div>
   </div><!-- å ´æ™¯3: å°é¢é  -->
   <div class="scene scene-cover active" id="sceneCover">
    <div class="book-cover">
     <h1 class="book-title" id="gameTitle">   è©©éŠå”</h1>
     <div class="cover-illustration"><!-- æ—¥è½å¤ªé™½ -->
      <div class="cover-sun"></div><!-- é•·æ±Ÿæ°´é¢èˆ‡å€’å½± -->
      <div class="cover-river">
       <div class="cover-river-shimmer"></div>
      </div><!-- é»ƒé¶´æ¨“ SVG -->
      <svg class="cover-tower" viewbox="0 0 200 260" xmlns="http://www.w3.org/2000/svg"><!-- æ¨“èº«ç¬¬ä¸€å±¤ --> <polygon points="45,220 155,220 145,180 55,180" fill="#8B4513" stroke="#654321" stroke-width="2" /> <!-- æ¨“èº«ç¬¬äºŒå±¤ --> <polygon points="40,180 160,180 150,140 50,140" fill="#A0522D" stroke="#654321" stroke-width="2" /> <!-- æ¨“èº«ç¬¬ä¸‰å±¤ --> <polygon points="35,140 165,140 155,100 45,100" fill="#8B4513" stroke="#654321" stroke-width="2" /> <!-- å±‹é ‚ç¬¬ä¸€å±¤ --> <polygon points="25,100 175,100 185,75 15,75" fill="#CD5C5C" stroke="#8B3A3A" stroke-width="2" /> <!-- å±‹é ‚ç¬¬äºŒå±¤ --> <polygon points="20,75 180,75 190,50 10,50" fill="#DC143C" stroke="#8B3A3A" stroke-width="2" /> <!-- å±‹é ‚ç¬¬ä¸‰å±¤ --> <polygon points="15,50 185,50 195,25 5,25" fill="#CD5C5C" stroke="#8B3A3A" stroke-width="2" /> <!-- å¡”å°– --> <polygon points="80,25 120,25 100,0" fill="#FFD700" stroke="#DAA520" stroke-width="2" /> <!-- çª—æˆ¶ --> <rect x="70" y="150" width="25" height="25" fill="#FFF8DC" stroke="#654321" stroke-width="2" /> <rect x="105" y="150" width="25" height="25" fill="#FFF8DC" stroke="#654321" stroke-width="2" /> <rect x="75" y="110" width="20" height="20" fill="#FFF8DC" stroke="#654321" stroke-width="2" /> <rect x="105" y="110" width="20" height="20" fill="#FFF8DC" stroke="#654321" stroke-width="2" />
      </svg><!-- ç©¿è¶Šè€…å°‘å¥³å°‘å¹´åœ¨ç•«é¢ä¸­   -->
      <div class="cover-travelers"><!-- å°‘å¥³ -->
       <svg class="cover-traveler" viewbox="0 0 120 160" xmlns="http://www.w3.org/2000/svg"><!-- è£™   --> <ellipse cx="60" cy="140" rx="35" ry="20" fill="#FFB6C1" /> <!-- èº«é«” --> <rect x="35" y="75" width="50" height="65" rx="10" fill="#FFC0CB" /> <!-- é ­éƒ¨ --> <circle cx="60" cy="40" r="25" fill="#FFE4C4" /> <!-- é ­é«® --> <path d="M 35 40 Q 35 15 60 12 Q 85 15 85 40 L 80 48 Q 60 30 40 48 Z" fill="#2C1810" /> <!-- çœ¼ç› --> <circle cx="50" cy="40" r="4" fill="#000" /> <circle cx="70" cy="40" r="4" fill="#000" /> <!-- å¾®ç¬‘ --> <path d="M 48 50 Q 60 56 72 50" stroke="#000" stroke-width="2" fill="none" /> <!-- æ‰‹è‡‚ --> <rect x="22" y="80" width="12" height="40" rx="6" fill="#FFDAB9" /> <rect x="86" y="80" width="12" height="40" rx="6" fill="#FFDAB9" /> <!-- æ›¸å· --> <rect x="16" y="110" width="22" height="30" rx="3" fill="#F5DEB3" stroke="#8B6914" stroke-width="2" /> <line x1="20" y1="120" x2="34" y2="120" stroke="#8B6914" stroke-width="1" /> <line x1="20" y1="125" x2="34" y2="125" stroke="#8B6914" stroke-width="1" />
       </svg><!-- å°‘å¹´ -->
       <svg class="cover-traveler" viewbox="0 0 120 160" xmlns="http://www.w3.org/2000/svg"><!-- è…³éƒ¨ --> <ellipse cx="60" cy="140" rx="35" ry="20" fill="#87CEEB" /> <!-- èº«é«” --> <rect x="35" y="75" width="50" height="65" rx="10" fill="#87CEFA" /> <!-- é ­éƒ¨ --> <circle cx="60" cy="40" r="25" fill="#FFE4C4" /> <!-- é ­é«® --> <path d="M 38 35 Q 40 18 60 15 Q 80 18 82 35 L 78 42 Q 60 25 42 42 Z" fill="#2C1810" /> <!-- çœ¼ç› --> <circle cx="50" cy="40" r="4" fill="#000" /> <circle cx="70" cy="40" r="4" fill="#000" /> <!-- å¾®ç¬‘ --> <path d="M 48 50 Q 60 56 72 50" stroke="#000" stroke-width="2" fill="none" /> <!-- æ‰‹è‡‚ --> <rect x="22" y="80" width="12" height="40" rx="6" fill="#FFDAB9" /> <rect x="86" y="80" width="12" height="40" rx="6" fill="#FFDAB9" /> <!--   å­ --> <path d="M 90 105 Q 105 95 105 115 Q 105 95 90 125 Z" fill="#FFF" stroke="#000" stroke-width="2" /> <line x1="90" y1="105" x2="90" y2="125" stroke="#000" stroke-width="2" />
       </svg>
      </div><!-- é£›èˆçš„æ›¸å· -->
      <div class="cover-scrolls">
       <svg class="cover-scroll" width="70" height="40" viewbox="0 0 70 40" xmlns="http://www.w3.org/2000/svg"><rect x="5" y="5" width="60" height="30" rx="4" fill="#F5DEB3" stroke="#8B6914" stroke-width="2" /> <line x1="10" y1="15" x2="60" y2="15" stroke="#8B6914" stroke-width="1" /> <line x1="10" y1="20" x2="55" y2="20" stroke="#8B6914" stroke-width="1" /> <line x1="10" y1="25" x2="50" y2="25" stroke="#8B6914" stroke-width="1" />
       </svg>
       <svg class="cover-scroll" width="70" height="40" viewbox="0 0 70 40" xmlns="http://www.w3.org/2000/svg"><rect x="5" y="5" width="60" height="30" rx="4" fill="#F5DEB3" stroke="#8B6914" stroke-width="2" /> <line x1="10" y1="15" x2="60" y2="15" stroke="#8B6914" stroke-width="1" /> <line x1="10" y1="20" x2="55" y2="20" stroke="#8B6914" stroke-width="1" /> <line x1="10" y1="25" x2="50" y2="25" stroke="#8B6914" stroke-width="1" />
       </svg>
       <svg class="cover-scroll" width="70" height="40" viewbox="0 0 70 40" xmlns="http://www.w3.org/2000/svg"><rect x="5" y="5" width="60" height="30" rx="4" fill="#F5DEB3" stroke="#8B6914" stroke-width="2" /> <line x1="10" y1="15" x2="60" y2="15" stroke="#8B6914" stroke-width="1" /> <line x1="10" y1="20" x2="55" y2="20" stroke="#8B6914" stroke-width="1" /> <line x1="10" y1="25" x2="50" y2="25" stroke="#8B6914" stroke-width="1" />
       </svg>
       <svg class="cover-scroll" width="70" height="40" viewbox="0 0 70 40" xmlns="http://www.w3.org/2000/svg"><rect x="5" y="5" width="60" height="30" rx="4" fill="#F5DEB3" stroke="#8B6914" stroke-width="2" /> <line x1="10" y1="15" x2="60" y2="15" stroke="#8B6914" stroke-width="1" /> <line x1="10" y1="20" x2="55" y2="20" stroke="#8B6914" stroke-width="1" /> <line x1="10" y1="25" x2="50" y2="25" stroke="#8B6914" stroke-width="1" />
       </svg>
      </div>
     </div>
    </div>
    <div class="menu-buttons"><button class="menu-btn" onclick="startNewGame()">é–‹å§‹éŠæˆ²</button> <button class="menu-btn secondary" onclick="openLoadModal()">è®€å–å­˜æª”</button>
    </div>
   </div><!-- å ´æ™¯4: å¤§å”åé“åœ°åœ– -->
   <div class="scene map-scene" id="sceneRegionMap">
    <div class="map-container">
     <h2 class="map-title">å¤§å”åé“</h2>
     <svg class="map-svg" viewbox="0 0 1200 800" xmlns="http://www.w3.org/2000/svg"><rect x="0" y="0" width="1200" height="800" fill="rgba(245, 235, 220, 0.2)" /> <path d="M 200 320 Q 280 290 360 310 Q 440 330 520 300 Q 600 270 680 295" fill="rgba(139, 90, 60, 0.5)" stroke="rgba(100, 60, 40, 0.6)" stroke-width="1" /> <path d="M 150 250 Q 300 240 450 255 Q 600 270 750 260" fill="none" stroke="rgba(100, 180, 200, 0.7)" stroke-width="3" /> <path d="M 100 520 Q 300 515 500 530 Q 700 545 900 535" fill="none" stroke="rgba(100, 180, 200, 0.7)" stroke-width="3" /> <g class="location-marker" onclick="enterRegion('guannei')">
       <circle cx="350" cy="280" r="32" />
       <text x="350" y="290">
        é—œå…§
       </text>
      </g> <g class="location-marker" onclick="enterRegion('hebei')">
       <circle cx="620" cy="200" r="32" />
       <text x="620" y="210">
        æ²³åŒ—
       </text>
      </g> <g class="location-marker" onclick="enterRegion('hedong')">
       <circle cx="480" cy="240" r="32" />
       <text x="480" y="250">
        æ²³æ±
       </text>
      </g> <g class="location-marker" onclick="enterRegion('henan')">
       <circle cx="550" cy="360" r="32" />
       <text x="550" y="370">
        æ²³å—
       </text>
      </g> <g class="location-marker" onclick="enterRegion('shannan')">
       <circle cx="500" cy="480" r="32" />
       <text x="500" y="490">
        å±±å—
       </text>
      </g> <g class="location-marker" onclick="enterRegion('huainan')">
       <circle cx="680" cy="430" r="32" />
       <text x="680" y="440">
        æ·®å—
       </text>
      </g> <g class="location-marker" onclick="enterRegion('jiangnan')">
       <circle cx="820" cy="540" r="32" />
       <text x="820" y="550">
        æ±Ÿå—
       </text>
      </g> <g class="location-marker" onclick="enterRegion('jiannan')">
       <circle cx="280" cy="480" r="32" />
       <text x="280" y="490">
        åŠå—
       </text>
      </g> <g class="location-marker" onclick="enterRegion('longright')">
       <circle cx="200" cy="300" r="32" />
       <text x="200" y="310">
           å³
       </text>
      </g> <g class="location-marker" onclick="enterRegion('lingnan')">
       <circle cx="700" cy="680" r="32" />
       <text x="700" y="690">
        å¶ºå—
       </text>
      </g>
     </svg>
    </div>
   </div><!-- å ´æ™¯5: åŸå¸‚é¸æ“‡ -->
   <div class="scene map-scene" id="sceneCitySelect">
    <div class="city-select-container">
     <h2 class="region-name" id="currentRegionName">é—œå…§é“</h2>
     <div class="city-select-grid" id="citySelectGrid"></div>
     <div style="text-align: center; margin-top: 40px;"><button class="continue-btn" onclick="backToRegionMap()">è¿”å›åé“åœ°åœ–</button>
     </div>
    </div>
   </div><!-- å ´æ™¯6: åŸå¸‚åœ°åœ– -->
   <div class="scene map-scene" id="sceneCityMap">
    <div class="city-map-container">
     <div class="city-map-header">
      <h2 class="city-name" id="currentCityName">é•·å®‰</h2>
     </div>
     <div class="city-locations" id="cityLocations"></div>
     <div style="text-align: center; margin-top: 40px;"><button class="continue-btn" onclick="backToCitySelect()">è¿”å›åŸå¸‚é¸æ“‡</button>
     </div>
    </div>
   </div><!-- å ´æ™¯7: è¡—å¸‚å ´æ™¯ -->
   <div class="scene market-scene" id="sceneMarket">
    <div class="market-container">
     <h2 class="market-title" id="marketTitle">è¡—å¸‚</h2>
     <div class="market-shops" id="marketShops"></div>
     <div style="text-align: center; margin-top: 40px;"><button class="continue-btn" onclick="backToCityMap()">è¿”å›åŸå¸‚</button>
     </div>
    </div>
   </div><!-- å ´æ™¯8: å•†åº—å ´æ™¯ -->
   <div class="scene shop-scene" id="sceneShop">
    <div class="shop-container" id="shopContainer"></div>
   </div><!-- å ´æ™¯9: è©©è©äº’å‹•å ´æ™¯ -->
   <div class="scene poetry-scene" id="scenePoetry">
    <div class="poetry-container" id="poetryContainer"></div>
   </div><!-- å ´æ™¯10: ç™½å¹•è©©è©   ç¤º -->
   <div class="scene poetry-reveal-scene" id="scenePoetryReveal">
    <div class="poetry-reveal-container" id="poetryRevealContainer"></div>
   </div><!-- å ´æ™¯11: çš‡   å…§éƒ¨ï¼ˆå«è¯   æ± ï¼‰ -->
   <div class="scene map-scene" id="scenePalace">
    <div class="city-map-container">
     <div class="city-map-header">
      <h2 class="city-name">å¤§æ˜å®®</h2>
     </div>
     <div class="city-locations" id="palaceLocations"></div>
     <div style="text-align: center; margin-top: 40px;"><button class="continue-btn" onclick="backToCityMapFromPalace()">è¿”å›é•·å®‰</button>
     </div>
    </div>
   </div>
  </div>
  <script>
    const defaultConfig = { game_title: "è¸è©©éŠå”" };

    let gameState = {
      playerName: '',
      money: 100,
      season: 'spring',
      day: 1,
      actionPoints: 5,
      maxActionPoints: 5,
      currentRegion: '',
      currentCity: '',
      bridgeSleepCount: 0,
      inventory: [],
      mainQuests: [
        { id: 'q1', text: 'æ¢ç´¢å¤§å”å„é“åŸå¸‚', progress: 0, target: 5, completed: false },
        { id: 'q2', text: 'æ”¶é›†è©©  ', progress: 0, target: 10, completed: false },
        { id: 'q3', text: 'çµäº¤æç™½', completed: false }
      ],
      sideQuests: [
        { id: 's1', text: 'èˆ‡èƒ¡å§¬å°è©±', completed: false },
        { id: 's2', text: 'è³¼è²·ä¸€å¥—è¯æœ', completed: false },
        { id: 's3', text: 'å“åšå„åœ°ç¾é£Ÿ', progress: 0, target: 3, completed: false }
      ],
      visitedPoetry: [],
      completedPoetry: [],
      completedEvents: [],
      merchantInvestments: [],
      visitedCities: []
    };

    let allSaveRecords = [];
    let currentPoetryKey = null;
    let currentPoetryStage = 1;
    let currentShopType = '';

    const seasons = ['spring', 'summer', 'autumn', 'winter'];
    const seasonNames = { spring: 'æ˜¥å­£', summer: 'å¤å­£', autumn: 'ç§‹å­£', winter: 'å†¬å­£' };

    // å€åŸŸèˆ‡åŸå¸‚è³‡æ–™
    const regionData = {
      guannei: {
        name: 'é—œå…§é“',
        cities: {
          changan: {
            name: 'é•·å®‰',
            hasMarket: true,
            attractions: ['æ›²æ±Ÿæ± ', 'èŠ™è“‰åœ’'],
            hasPalace: true,
            bridge: true,
            priceMultiplier: 1.3
          },
          luoyang: {
            name: 'æ´›é™½',
            hasMarket: true,
            attractions: ['ç™½é¦¬å¯º', 'é¾é–€çŸ³çªŸ', 'ç‰¡ä¸¹åœ’'],
            bridge: true,
            priceMultiplier: 1.2
          }
        }
      },
      hebei: {
        name: 'æ²³åŒ—é“',
        cities: {
          youzhou: {
            name: 'å¹½å·',
            hasMarket: true,
            attractions: ['å¹½å·å°', 'èƒ¡äººé…’è‚†', 'ç‡•å±±'],
            bridge: true,
            priceMultiplier: 0.9
          }
        }
      },
      hedong: {
        name: 'æ²³æ±é“',
        cities: {
          taiyuan: {
            name: 'å¤ªåŸ',
            hasMarket: true,
            attractions: ['æ™‰ç¥ ', 'å¤©é¾å±±'],
            bridge: true,
            priceMultiplier: 1.0
          }
        }
      },
      henan: {
        name: 'æ²³å—é“',
        cities: {
          mengjin: {
            name: 'å­Ÿæ´¥',
            hasMarket: true,
            attractions: ['é»ƒæ²³  å£', 'é¾é–€å±±'],
            bridge: true,
            priceMultiplier: 1.0
          },
          xingyang: {
            name: 'æ»é™½',
            hasMarket: true,
            attractions: ['è™ç‰¢é—œ', '  æ¾¤'],
            bridge: true,
            priceMultiplier: 1.0
          },
          yanshi: {
            name: '   å¸«',
            hasMarket: true,
            attractions: ['äºŒé‡Œé ­', 'ç„å¥˜æ•…é‡Œ'],
            bridge: true,
            priceMultiplier: 1.0
          }
        }
      },
      shannan: {
        name: 'å±±å—é“',
        cities: {
          xiangyang: {
            name: 'è¥„é™½',
            hasMarket: true,
            attractions: ['è¥„é™½åŸ', 'éš†ä¸­'],
            bridge: true,
            priceMultiplier: 1.0
          }
        }
      },
      huainan: {
        name: 'æ·®å—é“',
        cities: {
          yangzhou: {
            name: 'æšå·',
            hasMarket: true,
            attractions: ['ç˜¦è¥¿æ¹–', '   åå››æ©‹', 'å¤§æ˜å¯º'],
            bridge: true,
            priceMultiplier: 1.2
          }
        }
      },
      jiangnan: {
        name: 'æ±Ÿå—é“',
        cities: {
          suzhou: {
            name: 'è˜‡å·',
            hasMarket: true,
            attractions: ['å¯’å±±å¯º', 'è™ä¸˜', 'æ‹™æ”¿åœ’'],
            bridge: true,
            priceMultiplier: 1.2
          }
        }
      },
      jiannan: {
        name: 'åŠå—é“',
        cities: {
          chengdu: {
            name: 'æˆéƒ½',
            hasMarket: true,
            attractions: ['æœç”«è‰å ‚', 'æ­¦ä¾¯ç¥ ', 'é’åŸå±±'],
            bridge: true,
            priceMultiplier: 1.1
          }
        }
      },
      longright: {
        name: 'éš´å³é“',
        cities: {
          liangzhou: {
            name: 'æ¶¼å·',
            hasMarket: true,
            attractions: ['è‘¡è„åœ’', 'æ²™æ¼ ç¶ æ´²'],
            bridge: true,
            priceMultiplier: 0.8
          }
        }
      },
      lingnan: {
        name: 'å¶ºå—é“',
        cities: {
          guangzhou: {
            name: 'å»£å·',
            hasMarket: true,
            attractions: ['ç æ±Ÿ', 'å…‰å­å¯º'],
            bridge: true,
            priceMultiplier: 1.3
          }
        }
      }
    };

    // è©©è©è³‡æ–™åº«
    const poetryData = {
      changan_poverty: {
        location: 'é•·å®‰è¡—é ­',
        cost: 0,
        requiredCondition: () => gameState.money < 30,
        stage1: {
          description: 'ä½ èº«ä¸Šæ‰€å‰©éŠ€å…©ç„¡å¹¾ï¼Œ   é•·å®‰è¡—é ­å¾˜å¾Šã€‚æ°é€¢å®‰å²ä¹‹äº‚å¾Œï¼Œ     è•­ç‘Ÿï¼Œå¾€æ—¥ç¹è¯ä¸å†ã€‚ä½ çœ‹è¦‹ä¸€ä½ç™½é«®è€  ï¼Œæ­£å°è‘—æ®˜ç ´çš„å®®é—•è½æ·šâ€¦â€¦',
          choices: [
            { text: 'ğŸ‘€ ä¸Š  è©¢å•', action: 'ask' },
            { text: 'ğŸ’­ é»˜é»˜è§€å¯Ÿ', action: 'observe' }
          ]
        },
        stage2: {
          ask: 'è€è€…è¦‹ä½ è¡£è¡«è¥¤è¤¸ï¼Œå˜†æ¯é“ï¼šã€Œå¹´è¼•äººï¼Œä½ ä¹Ÿæ˜¯æˆ°äº‚ä¸­çš„æµæ°‘å—ï¼Ÿæ›¾ç¶“çš„é•·å®‰å•Šï¼Œå¦‚ä»Šåªå‰©ç ´æ•—â€¦â€¦ã€ä»–æŒ‡å‘é è™•çš„æ®˜å£æ–·å£ï¼Œçœ¼ä¸­æ»¿æ˜¯å“€å‚·ã€‚',
          observe: 'ä½ çœ‹è‘—è€è€…ï¼Œä»–çš„çœ¼æ·šæ»´è½åœ¨å¡µåœŸä¸Šã€‚çªç„¶ï¼Œä¸€ä½ä¸­å¹´æ–‡å£«èµ°ä¾†ï¼Œæ­£æ˜¯è©©è–æœç”«ã€‚ä»–çœ‹è‘—é€™ç‰‡å±±æ²³ï¼Œä½è²åŸèª¦â€¦â€¦'
        },
        stage3: {
          title: 'æ˜¥æœ›',
          author: 'æœç”«',
          verses: [
            'åœ‹ç ´å±±æ²³åœ¨',
            'åŸæ˜¥è‰æœ¨æ·±',
            'æ„Ÿæ™‚èŠ±     ',
            'æ¨åˆ¥é³¥é©šå¿ƒ'
          ]
        },
        stage4: {
          description: 'æœç”«åŸ   è©©ï¼Œçœ‹å‘ä½ ï¼šã€Œå¹´è¼•äººï¼Œå³   åœ¨äº‚ä¸–ä¸­ï¼Œä¹Ÿä¸è¦æ”¾æ£„å¸Œæœ›ã€‚ã€ä»–å¾æ‡·ä¸­æå‡ºäº›è¨±éŠ€å…©ï¼Œéçµ¦ä½ ï¼šã€Œæ‹¿è‘—å§ï¼Œå¸Œæœ›ä½ èƒ½çœ‹åˆ°å±±æ²³é‡  çš„é‚£ä¸€å¤©ã€‚ã€',
          choices: [
            { text: '   æ‹œè¬æœç”«', reward: { money: 50, quest: 'poetry' } }
          ]
        }
      },
      changan_palace: {
        location: 'å¤§æ˜å®®',
        cost: 1,
        requiredEvent: 'met_libai',
        stage1: {
          description: 'å¤šè™§æç™½å¼•è–¦ï¼Œä½ å¾—ä»¥é€²å…¥å¤§æ˜å®®ã€‚æ­£å€¼ç‰¡ä¸¹èŠ±ç››é–‹ï¼Œç„å®—çš‡å¸æ”œæ¥Šè²´å¦ƒåœ¨æ²‰é¦™äº­è³èŠ±ã€‚æç™½é†‰çœ¼æƒºå¿ªï¼Œè¢«å¬ä¸Šä¾†è³¦è©©â€¦â€¦',
          choices: [
            { text: 'ğŸ‘€ è§€çœ‹æç™½è³¦è©©', action: 'watch' },
            { text: 'ğŸ’­ æš—ä¸­è§€å¯Ÿè²´å¦ƒ', action: 'observe' }
          ]
        },
        stage2: {
          watch: 'æç™½å¤§æ­¥ä¸Š   ï¼Œçµ²æ¯«ä¸æ‡¼å¤©å¨ã€‚ç„å®—ç¬‘é“ï¼šã€Œæå¿ï¼Œä»Šæ—¥ç‚ºæœ•è³¦è©©åŠ©èˆˆï¼ã€æç™½æç­†ç–¾æ›¸ï¼Œç­†èµ°é¾è›‡â€¦â€¦',
          observe: 'æ¥Šè²´å¦ƒå¬Œç¾åœ°çœ‹   æ»¿åœ’ç‰¡ä¸¹ï¼Œåœ‹  å¤©é¦™ã€‚ç„å®—ç›®å…‰æº«æŸ”ï¼Œæç™½è¦‹æ­¤  æ™¯ï¼Œéˆæ„Ÿæ¹§ç¾â€¦â€¦'
        },
        stage3: {
          title: 'æ¸…å¹³èª¿Â·å…¶ä¸€',
          author: 'æç™½',
          verses: [
            'é›²æƒ³è¡£è£³èŠ±æƒ³å®¹',
            'æ˜¥é¢¨æ‹‚æª»éœ²è¯æ¿ƒ',
            'è‹¥éç¾¤ç‰å±±é ­è¦‹',
            'æœƒå‘ç‘¤å°æœˆä¸‹   '
          ]
        },
        stage4: {
          description: 'è©©ç•¢ï¼Œæ»¿   å–å½©ã€‚æ¥Šè²´å¦ƒå«£ç„¶ä¸€ç¬‘ï¼Œç„å®—å¤§æ‚…ï¼Œç•¶å ´è³è³œåƒé‡‘ã€‚æç™½é†‰çœ¼çœ‹å‘ä½ ï¼Œèˆ‰æ¯é“ï¼šã€Œä»Šæ—¥èˆ‡å›åŒéŠï¼Œä¸æ‰æ­¤ç”Ÿï¼ã€',
          choices: [
            { text: 'ğŸ· èˆ‡æç™½å…±é£²', reward: { money: 100, quest: 'poetry' } }
          ]
        }
      },
      changan_huaqingchi: {
        location: 'è¯æ¸…æ± ',
        cost: 1,
        requiredEvent: 'met_libai',
        stage1: {
          description: 'ä½ éš¨æç™½ä¾†åˆ°é©ªå±±è…³ä¸‹çš„è¯æ¸…æ± ï¼Œæº«æ³‰æ°¤æ°³ç¹šç¹ã€‚é€™è£¡æ˜¯çš‡å®¶è¡Œå®®ï¼Œæç™½å¼•ä½ å…¥å…§ã€‚ä½ çœ‹è¦‹æ± ç•”   ä¸¹ç››é–‹ï¼Œæå¦‚ä»™å¢ƒâ€¦â€¦',
          choices: [
            { text: 'ğŸµ è†è½æç™½è©©è©±', action: 'listen' },
            { text: 'â™¨ï¸ èµ°å‘æº«æ³‰', action: 'spring' }
          ]
        },
        stage2: {
          listen: 'æç™½é†‰çœ¼æƒºå¿ªï¼šã€Œç•¶å¹´ç„å®—èˆ‡è²´å¦ƒåœ¨æ­¤    å¥‰è©”è³¦è©©ï¼Œé‚£å¯æ˜¯åƒå¤ä½³è©±å•Š  ã€ä»–æç­†å¯«ä¸‹ç•¶å¹´çš„è©©   â€¦â€¦',
          spring: 'ä½ èµ°å‘æº«æ³‰ï¼Œç…™éœ§ä¸­  ä¹é‚„èƒ½çœ‹   ç•¶å¹´çš„èº«å½±ã€‚æç™½åœ¨ä½ èº«é‚Š  åŸèµ·èˆŠä½œâ€¦â€¦'
        },
        stage3: {
          title: 'æ¸…å¹³èª¿Â·å…¶äºŒ',
          author: 'æç™½',
          verses: [
            'ä¸€æç´…è‰·éœ²å‡é¦™',
            'é›²é›¨å·«å±±æ‰æ–·è…¸',
            'å€Ÿå•æ¼¢å®®èª°å¾—ä¼¼',
            'å¯  é£›ç‡•å€šæ–°å¦'
          ]
        },
        stage4: {
          description: 'è©©å¢ƒä¸­é‚£ç››ä¸–é¢¨è¯ä»¤ä½    å¾€ä¸å·²ã€‚æç™½æ‹è‘—ä½ çš„è‚©è†€ï¼šã€Œç››ä¸–å·²é€ï¼Œä½†è©©æ„æ°¸å­˜ã€‚ä¾†ï¼Œæˆ‘å€‘ç¹¼çºŒéŠæ­·å¤©ä¸‹ï¼ã€',
          choices: [
            { text: 'ğŸ“œ è¨˜éŒ„è©©ä½œ', reward: { money: 30, quest: 'poetry' } }
          ]
        }
      },
      changan_qujiangchi: {
        location: 'æ›²æ±Ÿæ± ',
        cost: 1,
        stage1: {
          description: 'ä½ ä¾†åˆ°é•·å®‰è‘—åçš„æ›²æ±Ÿæ± ï¼Œæ¹–å…‰å±±è‰²ç¾ä¸å‹æ”¶ã€‚æ˜¥æ—¥è£¡ï¼Œæ–‡äººé›…å£«èšé›†æ–¼æ­¤ï¼Œè©©é…’æµé€£ã€‚     è¦‹ä¸€ç¾¤å£«å­æ­£åœ¨æ¹–ç•”åŸè©©ä½œå°â€¦â€¦',
          choices: [
            { text: 'ğŸ“œ ä¸Šå‰è§€è³', action: 'watch' },
            { text: 'ğŸš¶ ç¨è‡ªæ¼«æ­¥', action: 'walk' }
          ]
        },
        stage2: {
          watch: 'ä¸€ä½é’å¹´æ‰ä¿Šæ­£åœ¨åŸè©©ï¼Œä»–çš„è©©å¥æ¸…æ–°è„«ä¿—ã€‚æ—äººè´Šå˜†ä¸å·²ï¼šã€Œæ­¤ä¹ƒæœç‰§æœå…¬å­ä¹‹ä½³ä½œï¼ã€',
          walk: 'ä½   è‘—æ¹–ç•”æ¼«æ­¥ï¼Œæ˜¥é¢¨æ‹‚  ã€‚çªç„¶è½è¦‹æœ‰äººåŸèª¦æœç‰§çš„è©©ä½œâ€¦â€¦'
        },
        stage3: {
          title: 'æ¸…æ˜',
          author: 'æœç‰§',
          verses: [
            'æ¸…æ˜æ™‚ç¯€é›¨ç´›   ',
            'è·¯ä¸Šè¡Œäººæ¬²æ–·é­‚',
            'å€Ÿå•é…’å®¶ä½•è™•æœ‰',
            'ç‰§ç«¥é™æŒ‡æèŠ±æ‘'
          ]
        },
        stage4: {
          description: 'è©©ä¸­é‚£ä»½æ¸…æ–°èˆ‡æƒ†æ‚µè®“ä½ æ·±æœ‰æ„Ÿè§¸ã€‚æ˜¥æ—¥çš„æ›²æ±Ÿæ± ï¼Œ   è­‰äº†å¤šå°‘æ–‡äººçš„   æƒ…èˆ‡æµªæ¼«â€¦â€¦',
          choices: [
            { text: 'ğŸ“œ è¨˜éŒ„æ­¤æ™¯', reward: { money: 25, quest: 'poetry' } }
          ]
        }
      },
      youzhou_jiulv: {
        location: 'èƒ¡äººé…’è‚†',
        cost: 1,
        stage1: {
          description: 'å¹½å·é‚Šå¡ä¹‹åœ°ï¼Œèƒ¡æ¼¢é›œè™•ã€‚ä½ èµ°é€²ä¸€å®¶èƒ¡äººé…’è‚†ï¼Œç¢§çœ¼é‡‘é«®çš„èƒ¡å§¬æ­£åœ¨èµ·èˆï¼ŒéŠ€éˆ´èˆ¬çš„ç¬‘è²è¿´ç›ªâ€¦â€¦',
          choices: [
            { text: 'ğŸ· é»ä¸€å£ºé…’', action: 'drink' },
            { text: 'ğŸ’ƒ è§€   èˆè¹ˆ', action: 'dance' }
          ]
        },
        stage2: {
          drink: 'ä½ é»äº†è‘¡è„é…’ï¼Œèƒ¡å§¬ç¬‘è‘—ç‚ºä½ æ–Ÿ  ã€‚å¥¹çš„æ¼¢èªé›–å¸¶å£éŸ³ï¼Œå»åˆ¥æœ‰é¢¨æƒ…ã€‚è§’è½è£¡æœ‰  å°‘å¹´éƒï¼Œæ­£å‡è¦–è‘—å¥¹â€¦â€¦',
          dance: 'èƒ¡å§¬èˆå§¿æ›¼å¦™ï¼Œç•°åŸŸé¢¨æƒ…æ¿ƒéƒã€‚ä½ æ³¨æ„åˆ°ä¸€ä½ç™½è¡£å°‘å¹´ï¼Œç›®ä¸è½‰ç›åœ°çœ‹è‘—å¥¹ï¼Œçœ¼ä¸­æ»¿æ˜¯æ„›æ…•â€¦â€¦'
        },
        stage3: {
          title: 'å°‘å¹´è¡Œ',
          author: '  ç™½',
          verses: [
            'äº”é™µå¹´å°‘é‡‘å¸‚   ',
            'éŠ€éç™½é¦¬åº¦æ˜¥é¢¨',
            'è½èŠ±è¸ç›¡éŠä½•è™•',
            'ç¬‘å…¥èƒ¡å§¬é…’è‚†ä¸­'
          ]
        },
        stage4: {
          description: 'å°‘å¹´éƒå¤§ç¬‘ï¼Œèˆ‰æ¯é‚€ä½ å…±é£²ã€‚èƒ¡å§¬ä¹Ÿç¬‘è‘—åŠ å…¥ã€‚é€™ä¸€åˆ»ï¼Œä½ æ·±æ·±æ„Ÿå—åˆ°å¤§å”çš„é–‹æ”¾èˆ‡åŒ…  â€¦â€¦',
          choices: [
            { text: 'ğŸ’¬ èˆ‡èƒ¡å§¬äº¤è«‡', reward: { money: 25, quest: 's1' } },
            { text: 'ğŸš¶ é›¢é–‹é…’è‚†', reward: { money: 15, quest: 'poetry' } }
          ]
        }
      },
      yangzhou_bridge: {
        location: 'äºŒåå››æ©‹',
        cost: 1,
        stage1: {
          description: 'æšå·æ˜æœˆå¤œï¼Œä½ ä¾†åˆ°è‘—åçš„äºŒåå››æ©‹ã€‚æœˆè‰²å¦‚æ°´ï¼Œæ©‹å½±å©†å¨‘ã€‚é è™•å‚³ä¾†æ‚ æšçš„ç°«è²â€¦â€¦',
          choices: [
            { text: 'ğŸµ å¾ªè²å°‹æ‰¾', action: 'find' },
            { text: 'ğŸŒ™ ç¨è‡ªè³æœˆ', action: 'moon' }
          ]
        },
        stage2: {
          find: 'ä½ èµ°è¿‘æ©‹é ­ï¼Œçœ‹è¦‹ä¸€ä½ç™½è¡£å¥³å­   åœ¨å¹ç°«ã€‚æ›²çµ‚ï¼Œå¥¹è¼•å˜†ä¸€è²  ä¼¼æœ‰å¿ƒäº‹â€¦â€¦',
          moon: 'ä½ å€šåœ¨æ©‹æ¬„ä¸Šè³æœˆï¼Œçªç„¶è½è¦‹æœ‰äººåŸè©©ï¼Œé‚£è²éŸ³å……æ»¿æ‡·å¿µâ€¦â€¦'
        },
        stage3: {
          title: 'å¯„æšå·éŸ“ç¶½åˆ¤å®˜',
          author: 'æœç‰§',
          verses: [
            'é’  éš±éš±æ°´è¿¢è¿¢',
            'ç§‹ç›¡æ±Ÿå—è‰æœªå‡‹',
            'äºŒåå››æ©‹æ˜æœˆå¤œ',
            'ç‰äººä½•è™•æ•™å¹ç°«'
          ]
        },
        stage4: {
          description: 'è©©ä¸­é‚£ä»½æ‡·å¿µèˆ‡æƒ†æ‚µï¼Œ   ä½ æƒ³èµ·äº†é æ–¹çš„æ•…é„‰ã€‚æœˆå…‰ä¸‹ï¼Œä½ é»˜é»˜è¨˜ä¸‹é€™ä¸€åˆ»â€¦â€¦',
          choices: [
            { text: 'ğŸ“œ è¨˜éŒ„æ­¤æ™¯', reward: { money: 30, quest: 'poetry' } }
          ]
        }
      },
      chengdu_caotang: {
        location: 'æœç”«è‰å ‚',
        cost: 1,
        stage1: {
          description: 'ä½ ä¾†åˆ°æˆéƒ½éƒŠå¤–çš„æœç”«è‰å ‚ã€‚é€™åº§ç°¡é™‹çš„èŒ…å±‹ï¼Œæ›¾æ˜¯è©©è–é¿é›£ä¹‹æ‰€ã€‚ç§‹é¢¨è•­ç‘Ÿï¼Œå±‹é ‚èŒ…è‰è¢«å¹å¾—ä¸ƒé›¶å…«è½â€¦â€¦',
          choices: [
            { text: 'ğŸ  é€²å…¥è‰å ‚', action: 'enter' },
            { text: 'ğŸ‚ åœ¨   è§€å¯Ÿ', action: 'watch' }
          ]
        },
        stage2: {
          enter: '   å ‚å…§ç°¡é™‹ç•°å¸¸ï¼Œä½†ä½ çœ‹è¦‹ç‰†ä¸Šæ›è‘—è¨±å¤šè©©ç¨¿ã€‚ç®¡ç†è€…å‘Šè¨´ä½ ï¼Œæœç”«åœ¨æ­¤å¯«ä¸‹è¨±å¤šåç¯‡â€¦â€¦',
          watch: 'çªç„¶ä¸€é™£ç‹‚é¢¨å¹ä¾†ï¼Œå±‹é ‚çš„èŒ…è‰ç´›ç´›é£›èˆã€‚ä½ å½·å½¿çœ‹è¦‹ç•¶å¹´æœç”«è¿½è¶•èŒ…è‰çš„èº«å½±ï¼Œå¿ƒä¸­æ„Ÿæ…¨è¬åƒâ€¦â€¦'
        },
        stage3: {
          title: 'èŒ…å±‹ç‚º  é¢¨æ‰€ç ´æ­Œ',
          author: 'æœç”«',
          verses: [
            'å…«æœˆç§‹é«˜é¢¨æ€’è™Ÿ',
            'å·æˆ‘å±‹ä¸Šä¸‰é‡èŒ…',
            'å®‰å¾—å»£å»ˆåƒè¬é–“',
            'å¤§åº‡å¤©ä¸‹å¯’å£«ä¿±æ­¡é¡'
          ]
        },
        stage4: {
          description: 'ã€Œå¤§åº‡å¤©ä¸‹å¯’å£«ä¿±æ­¡é¡ã€â€”â€”å³ä½¿è‡ªå·±å±…ç„¡å®šæ‰€ï¼Œæœç”«ä»å¿ƒç¹«å¤©ä¸‹ã€‚ä½ è¢«é€™ç¨®èƒ¸æ‡·æ·±æ·±æ‰“å‹•â€¦â€¦',
          choices: [
            { text: 'ğŸ™ ç¥­æ‹œè©©è–', reward: { money: 35, quest: 'poetry' } }
          ]
        }
      }
    };

    // è¡—å¸‚çµ±ä¸€å•†åº—é…ç½®
    const marketShops = [
      { name: 'æˆ  é‹ª', icon: 'ğŸ‘˜' },
      { name: 'å°åƒ   ', icon: 'ğŸœ' },
      { name: 'ç•¶é‹ª', icon: 'ğŸ¦' },
      { name: 'å®¢æ£§', icon: 'ğŸ¨' },
      { name: 'é¦–é£¾é‹ª', icon: 'ğŸ’' },
      { name: 'æœè”¬æ”¤', icon: 'ğŸ¥¬' },
      { name: 'æ›¸åº—', icon: 'ğŸ“š' },
      { name: 'é›œç³§é‹ª', icon: 'ğŸŒ¾' },
      { name: 'éµé‹ª', icon: 'âš’ï¸' }
    ];

    // å•†åº—å•†å“è³‡æ–™
    const shopData = {
      'æˆè¡£é‹ª': {
        description: 'ã€Œå®¢å®˜è£¡   è«‹ï¼å°   å°ˆç‡Ÿå„å¼æˆè¡£ï¼Œå¾æ£‰   åˆ°éŒ¦ç¶¢æ‡‰æœ‰ç›¡æœ‰ã€‚æ‚¨æƒ³çœ‹é»ä»€éº¼ï¼Ÿã€',
        items: [
          { id: 'cloth1', name: 'æ£‰å¸ƒè¡£', icon: 'ğŸ‘˜', basePrice: 15, desc: 'å°‹å¸¸ç™¾å§“ç©¿è‘—' },
          { id: 'cloth2', name: 'çµ²ç¶¢è¢', icon: 'ğŸ¥»', basePrice: 50, desc: 'å¯Œæˆ¶äººå®¶å–œæ„›' },
          { id: 'cloth3', name: 'éŒ¦ç¹¡è¯æœ', icon: 'ğŸ‘—', basePrice: 120, desc: 'å®˜å®¦åäºº   å±¬', quest: 's2', triggerLibai: true }
        ]
      },
      'é¦–é£¾é‹ª': {
        description: 'ã€Œæ­¡è¿å…‰è‡¨ï¼å°åº—çš„é¦–é£¾éƒ½æ˜¯ä¸Šç­‰è²¨è‰²ï¼Œé‡‘éŠ€ç‰çŸ³æ¨£æ¨£é½Šå…¨ã€‚å§‘å¨˜çœ‹ä¸­å“ªä»¶ï¼Ÿã€',
        items: [
          { id: 'jewelry1', name: 'éŠ€  ', icon: 'ğŸ“Œ', basePrice: 30, desc: 'ç´”éŠ€æ‰“é€ ' },
          { id: 'jewelry2', name: 'ç‰ä½©', icon: 'ğŸ’', basePrice: 80, desc: 'å’Œç”°ç¾ç‰' },
          { id: 'jewelry3', name: 'é‡‘é‡µ', icon: 'ğŸ‘‘', basePrice: 150, desc: 'èµ¤é‡‘é‘²å¯¶' }
        ]
      },
      'å°åƒæ”¤': {
        description: 'ã€Œä¾†ä¾†ä¾†  ç†±é¨°é¨°çš„å°åƒï¼Œä¿è­‰å¥½åƒ  å®¢å®˜æƒ³åšé»ä»€éº¼ï¼Ÿã€',
        items: [
          { id: 'food1', name: 'èƒ¡é¤…', icon: 'ğŸ¥™', basePrice: 5, desc: 'èŠéº»é¦™è„†', quest: 's3' },
          { id: 'food2', name: 'ç¾Šè‚‰æ³¡é¥ƒ', icon: '  ', basePrice: 8, desc: '  æ¿ƒè‚‰çˆ›', quest: 's3' },
          { id: 'food3', name: 'æ«»æ¡ƒç…', icon: 'ğŸ¡', basePrice: 12, desc: 'å®®å»·  å¿ƒ', quest: 's3' }
        ]
      },
      'ç•¶é‹ª': {
        description: 'ã€Œæœ¬åº—æ”¶è³¼å„é¡ç‰©å“ï¼Œåƒ¹æ ¼å…¬é“ç«¥åŸç„¡æ¬ºï¼ã€',
        items: []
      },
      'å®¢æ£§': {
        description: 'ã€Œæ­¡è¿å…¥ä½ï¼ä¸Šç­‰å®¢æˆ¿ï¼Œä¹¾æ·¨èˆ’é©ï¼Œä¸€æ™šåªéœ€å  éŠ€å­ã€‚ã€',
        items: [
          { id: 'inn1', name: 'ä½å®¿ä¸€æ™š', icon: 'ğŸ›ï¸', basePrice: 10, desc: 'æ¢å¾©   åŠ›' }
        ]
      },
      'æœè”¬æ”¤': {
        description: 'ã€Œæ–°é®®æœè”¬ï¼å‰›å¾åœ°è£¡æ‘˜  ï¼Œæ°´éˆè‘—å‘¢ï¼ã€',
        items: [
          { id: 'fruit1', name: 'æ™‚ä»¤é®®æœ', icon: 'ğŸ‘', basePrice: 3, desc: 'ç•¶å­£æ°´æœ' },
          { id: 'veg1', name: 'æ–°é®®è”¬èœ', icon: 'ğŸ¥¬', basePrice: 2, desc: 'ç¿ ç¶ æ¬²æ»´' }
        ]
      },
      'æ›¸åº—': {
        description: 'ã€Œ   åº—å°ˆè³£å„é¡æ›¸ç±ï¼Œ  å²å­é›†ã€è©©   æ­Œè³¦æ‡‰æœ‰ç›¡æœ‰ï¼ã€',
        items: [
          { id: 'book1', name: 'è©©è©   é›†', icon: 'ğŸ“–', basePrice: 20, desc: 'å”è©©ç²¾é¸' },
          { id: 'book2', name: 'éŠè¨˜é›œè«‡', icon: 'ğŸ“š', basePrice: 15, desc: 'å„åœ°é¢¨åœŸ' }
        ]
      },
      'é›œç³§é‹ª': {
        description: 'ã€Œäº”ç©€é›œç³§ï¼Œç±³éºµæ²¹é¹½ï¼Œå®¶ä¸­å¿…å‚™ï¼ã€',
        items: [
          { id: 'grain1', name: 'ç™½ç±³', icon: 'ğŸš', basePrice: 5, desc: 'ä¸Šç­‰å¥½ç±³' },
          { id: 'grain2', name: 'éºµç²‰', icon: 'ğŸŒ¾', basePrice: 4, desc: 'æ–°ç£¨éºµç²‰' }
        ]
      },
      'éµé‹ª': {
        description: 'ã€Œéµå™¨è¾²å…·ã€åˆ€åŠå…µå™¨ï¼Œæ¨£æ¨£ç²¾è‰¯ï¼ã€',
        items: [
          { id: 'iron1', name: 'çŸ­åˆ€', icon: 'ğŸ”ª', basePrice: 30, desc: 'é˜²èº«  ç”¨' },
          { id: 'iron2', name: 'è¾²å…·', icon: 'âš’ï¸', basePrice: 15, desc: 'è€•ç¨®å¿…å‚™' }
        ]
      }
    };

    // Data SDK è™•ç†
    const dataHandler = {
      onDataChanged(data) {
        allSaveRecords = data;
      }
    };

    async function initSDK() {
      if (window.dataSdk) {
        const result = await window.dataSdk.init(dataHandler);
        if (!result.isOk) {
          console.error('Data SDK åˆå§‹åŒ–å¤±æ•—');
        }
      }

      if (window.elementSdk) {
        window.elementSdk.init({
          defaultConfig,
          onConfigChange: async (config) => {
            document.getElementById('gameTitle').textContent = config.game_title || defaultConfig.game_title;
          },
          mapToCapabilities: () => ({
            recolorables: [],
            borderables: [],
            fontEditable: undefined,
            fontSizeable: undefined
          }),
          mapToEditPanelValues: (config) => new Map([
            ['game_title', config.game_title || defaultConfig.game_title]
          ])
        });
      }
    }

    function showNarration(text) {
      const existing = document.querySelector('.narration');
      if (existing) existing.remove();
      
      const narration = document.createElement('div');
      narration.className = 'narration';
      narration.textContent = text;
      document.body.appendChild(narration);
      setTimeout(() => narration.remove(), 4000);
    }

    function updateUI() {
      const xun = gameState.day <= 10 ? 'ä¸Šæ—¬' : gameState.day <= 20 ? 'ä¸­æ—¬' : 'ä¸‹æ—¬';
      document.getElementById('seasonDisplay').textContent = `${seasonNames[gameState.season]} ${xun}`;
      document.getElementById('actionDisplay').textContent = `è¡Œå‹•é»: ${gameState.actionPoints}/${gameState.maxActionPoints}`;
      document.getElementById('moneyDisplay').textContent = `ğŸ’° ${gameState.money}å…©`;
      document.getElementById('modalMoneyDisplay').textContent = gameState.money;
      
      updateBackground();
      updateQuests();
    }

    function updateBackground() {
      const container = document.getElementById('gameContainer');
      if (gameState.actionPoints >= 4) {
        container.style.background = 'linear-gradient(135deg, #87CEEB 0%, #E6E6FA 50%, #DEB887 100%)';
      } else if (gameState.actionPoints >= 2) {
        container.style.background = 'linear-gradient(135deg, #FF7F50 0%, #FF6B9D 50%, #FFA07A 100%)';
      } else {
        container.style.background = 'linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%)';
      }
    }

    function updateQuests() {
      const mainHTML = gameState.mainQuests.map(q => {
        const progressText = q.target ? ` (${q.progress}/${q.target})` : '';
        return `<div class="quest-item ${q.completed ? 'completed' : ''}">
          ${q.text}${progressText}
          ${q.completed ? '<div style="color: #4caf50; margin-top: 5px;">âœ“ å·²å®Œæˆ</div>' : ''}
        </div>`;
      }).join('');
      document.getElementById('mainQuestList').innerHTML = mainHTML;

      const sideHTML = gameState.sideQuests.map(q => {
        const progressText = q.target ? ` (${q.progress}/${q.target})` : '';
        return `<div class="quest-item ${q.completed ? 'completed' : ''}">
          ${q.text}${progressText}
          ${q.completed ? '<div style="color: #4caf50; margin-top: 5px;">âœ“ å·²å®Œæˆ</div>' : ''}
        </div>`;
      }).join('');
      document.getElementById('sideQuestList').innerHTML = sideHTML;
    }

    function toggleQuestSection(type) {
      const list = document.getElementById(type + 'QuestList');
      const toggle = document.getElementById(type + 'Toggle');
      if (list.classList.contains('expanded')) {
        list.classList.remove('expanded');
        toggle.textContent = 'â–¼';
      } else {
        list.classList.add('expanded');
        toggle.textContent = 'â–²';
      }
    }

    function consumeActionPoint() {
      gameState.actionPoints--;
      if (gameState.actionPoints <= 0) {
        gameState.actionPoints = gameState.maxActionPoints;
        gameState.day++;
        
        if (gameState.day > 30) {
          gameState.day = 1;
          const currentIndex = seasons.indexOf(gameState.season);
          gameState.season = seasons[(currentIndex + 1) % 4];
          showNarration(`å­£ç¯€  æ›¿ï¼Œç¾åœ¨æ˜¯${seasonNames[gameState.season]}äº†`);
        }
      }
      updateUI();
    }

    function switchScene(from, to) {
      const fromScene = document.getElementById(from);
      const toScene = document.getElementById(to);
      
      if (fromScene) {
        fromScene.classList.remove('active');
      }
      
      setTimeout(() => {
        if (toScene) {
          toScene.classList.add('active');
        }
      }, 100);
    }

    function goToNaming() {
      switchScene('sceneOpening', 'sceneNaming');
    }

    function confirmName() {
      const nameInput = document.getElementById('playerNameInput');
      const name = nameInput.value.trim();
      const errorDiv = document.getElementById('nameError');
      
      if (!name) {
        errorDiv.textContent = 'è«‹è¼¸å…¥ä½ çš„å§“åï¼';
        return;
      }
      
      if (name.length > 10) {
        errorDiv.textContent = 'å§“åä¸å¯  é10å€‹å­—ï¼';
        return;
      }
      
      gameState.playerName = name;
      document.getElementById('gameUI').style.display = 'block';
      updateUI();
      switchScene('sceneNaming', 'sceneRegionMap');
      showNarration(`åº—å°äºŒç¬‘é“ï¼šã€Œ${name}å®¢å®˜å¥½åå­—ï¼ç¥æ‚¨ä¸€è·¯å¹³å®‰ï¼ã€`);
    }

    function startNewGame() {
      // éš±è—å°é¢ï¼Œé¡¯ç¤ºé–‹å ´åŠ‡æƒ…
      const cover = document.getElementById('sceneCover');
      const opening = document.getElementById('sceneOpening');
      
      if (cover) cover.classList.remove('active');
      
      setTimeout(() => {
        if (opening) opening.classList.add('active');
      }, 100);
    }

    function enterRegion(regionKey) {
      const region = regionData[regionKey];
      if (!region) {
        showNarration('æ­¤é“è·¯å°šæœªé–‹é€šï¼Œè«‹ç¨å¾Œå†ä¾†ï¼');
        return;
      }

      gameState.currentRegion = regionKey;
      document.getElementById('currentRegionName').textContent = region.name;

      const cities = region.cities;
      let cityHTML = '';
      
      Object.keys(cities).forEach(cityKey => {
        const city = cities[cityKey];
        cityHTML += `
          <div class="city-select-card" onclick="enterCity('${cityKey}')">
            <div class="city-select-icon">ğŸ›ï¸</div>
            <div class="city-select-name">${city.name}</div>
          </div>
        `;
      });

      document.getElementById('citySelectGrid').innerHTML = cityHTML;
      switchScene('sceneRegionMap', 'sceneCitySelect');
    }

    function enterCity(cityKey) {
      const region = regionData[gameState.currentRegion];
      const city = region.cities[cityKey];
      if (!city) return;

      gameState.currentCity = cityKey;
      
      if (!gameState.visitedCities.includes(cityKey)) {
        gameState.visitedCities.push(cityKey);
        const quest = gameState.mainQuests.find(q => q.id === 'q1');
        if (quest && !quest.completed) {
          quest.progress++;
          if (quest.progress >= quest.target) {
            quest.completed = true;
            showNarration('ä¸»ç·šä»»å‹™å®Œæˆï¼šæ¢ç´¢å¤§å”å„é“åŸå¸‚ï¼');
          }
        }
      }

      if (cityKey === 'changan' && gameState.money < 30 && !gameState.completedPoetry.includes('changan_poverty')) {
        startPoetryInteraction('changan_poverty');
        return;
      }

      document.getElementById('currentCityName').textContent = city.name;

      let locationsHTML = '';
      
      if (city.hasMarket) {
        locationsHTML += `
          <div class="location-card" onclick="enterMarket()">
            <div class="location-icon">ğŸª</div>
            <div class="location-label">è¡—å¸‚</div>
          </div>
        `;
      }

      city.attractions.forEach(attr => {
        locationsHTML += `
          <div class="location-card" onclick="visitAttraction('${attr}')">
            <div class="location-icon">ğŸ›ï¸</div>
            <div class="location-label">${attr}</div>
          </div>
        `;
      });

      if (city.hasPalace) {
        const hasLibai = gameState.completedEvents.includes('met_libai');
        const lockedClass = hasLibai ? '' : 'locked';
        const clickHandler = hasLibai ? `enterPalace()` : `cannotEnterPalace()`;
        
        locationsHTML += `
          <div class="location-card ${lockedClass}" onclick="${clickHandler}">
            <div class="location-icon">ğŸ‘‘</div>
            <div class="location-label">çš‡å®®</div>
            ${!hasLibai ? '<div class="location-note">éœ€çµäº¤æç™½</div>' : ''}
          </div>
        `;
      }

      if (city.bridge) {
        locationsHTML += `
          <div class="location-card" onclick="sleepUnderBridge()">
            <div class="location-icon">ğŸŒ‰</div>
            <div class="location-label">æ©‹ä¸‹éå¤œ</div>
          </div>
        `;
      }

      document.getElementById('cityLocations').innerHTML = locationsHTML;
      switchScene('sceneCitySelect', 'sceneCityMap');
      updateUI();
    }

    function cannotEnterPalace() {
      showNarration('æ­¤è™•éœ€è¦ç†Ÿäººå¼•è–¦æ‰èƒ½é€²å…¥â€¦â€¦åœ¨è¡—å¸‚è³¼è²·è¯æœæˆ–è¨±èƒ½é‡åˆ°è²´äºº');
    }

    function enterPalace() {
      if (gameState.actionPoints <= 0) {
        showNarration('ä»Šæ—¥è¡Œå‹•é»å·²ç”¨   ï¼');
        return;
      }

      let palaceHTML = `
        <div class="location-card" onclick="startPoetryInteraction('changan_palace')">
          <div class="location-icon">ğŸ‘‘</div>
          <div class="location-label">å¤§æ˜å®®</div>
        </div>
        <div class="location-card" onclick="startPoetryInteraction('changan_huaqingchi')">
          <div class="location-icon">â™¨ï¸</div>
          <div class="location-label">è¯æ¸…æ± </div>
        </div>
      `;

      document.getElementById('palaceLocations').innerHTML = palaceHTML;
      switchScene('sceneCityMap', 'scenePalace');
    }

    function backToCityMapFromPalace() {
      switchScene('scenePalace', 'sceneCityMap');
    }

    function enterMarket() {
      const city = regionData[gameState.currentRegion].cities[gameState.currentCity];
      document.getElementById('marketTitle').textContent = `${city.name} è¡—å¸‚`;

      let shopsHTML = '';
      marketShops.forEach(shop => {
        shopsHTML += `
          <div class="market-shop-card" onclick="enterShop('${shop.name}')">
            <div class="location-icon">${shop.icon}</div>
            <div class="location-label">${shop.name}</div>
          </div>
        `;
      });

      document.getElementById('marketShops').innerHTML = shopsHTML;
      switchScene('sceneCityMap', 'sceneMarket');
    }

    function enterShop(shopName) {
      if (gameState.actionPoints <= 0) {
        showNarration('ä»Šæ—¥è¡Œå‹•  å·²ç”¨ç›¡ï¼');
        return;
      }

      currentShopType = shopName;

      if (shopName === 'ç•¶é‹ª') {
        showPawnShop();
        return;
      }

      if (shopName === 'å®¢æ£§') {
        showInn();
        return;
      }

      const shop = shopData[shopName];
      if (!shop) {
        showNarration('æ­¤åº—å°šæœªé–‹å¼µï¼Œè«‹ç¨å¾Œå†ä¾†ï¼');
        return;
      }

      const city = regionData[gameState.currentRegion].cities[gameState.currentCity];
      const multiplier = city.priceMultiplier;

      let html = `
        <h2 class="shop-title">${shopName}</h2>
        <div class="shop-description">${shop.description}</div>
        <div class="money-display">æŒæœ‰éŠ€å…©ï¼š<span id="shopMoneyDisplay">${gameState.money}</span> å…©</div>
        <div class="shop-items">
      `;

      if (shop.items.length > 0) {
        shop.items.forEach(item => {
          const price = Math.round(item.basePrice * multiplier);
          html += `
            <div class="shop-item" onclick='buyItem(${JSON.stringify({...item, price})})'>
              <div class="shop-item-icon">${item.icon}</div>
              <div class="shop-item-name">${item.name}</div>
              <div style="font-size: 1.1em; color: #b3e5d8; margin: 8px 0;">${item.desc}</div>
              <div class="shop-item-price">${price} å…©</div>
            </div>
          `;
        });
      } else {
        html += '<p style="color: #b3e5d8; text-align: center; grid-column: 1/-1;">æš«ç„¡å•†å“</p>';
      }

      html += `
        </div>
        <div style="text-align: center; margin-top: 30px;">
          <button class="back-btn" onclick="backToMarket()">è¿”å›è¡—å¸‚</button>
        </div>
      `;

      document.getElementById('shopContainer').innerHTML = html;
      switchScene('sceneMarket', 'sceneShop');
    }

    function showPawnShop() {
      let html = `
        <h2 class="shop-title">ç•¶é‹ª</h2>
        <div class="shop-description">ã€Œæœ¬åº—æ”¶è³¼å„é¡ç‰©å“ï¼Œåƒ¹æ ¼å…¬é“ç«¥åŸç„¡æ¬ºï¼ã€</div>
        <div class="money-display">æŒæœ‰éŠ€å…©ï¼š<span id="shopMoneyDisplay">${gameState.money}</span> å…©</div>
      `;

      if (gameState.inventory.length === 0) {
        html += '<p style="color: #b3e5d8; text-align: center; margin: 30px 0; font-size: 1.4em;">ä½ èº«ä¸Šæ²’æœ‰å¯ä»¥å…¸ç•¶çš„ç‰©å“</p>';
      } else {
        html += '<div class="shop-items">';
        gameState.inventory.forEach((item, index) => {
          html += `
            <div class="shop-item" onclick="sellItem(${index})">
              <div class="shop-item-icon">${item.icon}</div>
              <div class="shop-item-name">${item.name}</div>
              <div class="shop-item-price">è³£å‡º ${item.value} å…©</div>
            </div>
          `;
        });
        html += '</div>';
      }

      html += `
        <div style="text-align: center; margin-top: 30px;">
          <button class="back-btn" onclick="backToMarket()">è¿”å›è¡—å¸‚</button>
        </div>
      `;

      document.getElementById('shopContainer').innerHTML = html;
      switchScene('sceneMarket', 'sceneShop');
    }

    function sellItem(index) {
      const item = gameState.inventory[index];
      gameState.money += item.value;
      gameState.inventory.splice(index, 1);
      
      showNarration(`è³£å‡ºäº†${item.name}ï¼Œç²å¾—${item.value}å…©éŠ€å­  `);
      updateUI();
      
      setTimeout(() => {
        showPawnShop();
      }, 1500);
    }

    function showInn() {
      let html = `
        <h2 class="shop-title">å®¢æ£§</h2>
        <div class="shop-description">ã€Œæ­¡è¿å…¥ä½ï¼ä¸Šç­‰å®¢æˆ¿ï¼Œä¹¾æ·¨èˆ’é©ï¼Œä¸€æ™šåªéœ€åå…©éŠ€å­ã€‚ä½å®¿å¯æ¢å¾©æ‰€æœ‰è¡Œå‹•é»ï¼ã€</div>
        <div class="money-display">æŒæœ‰éŠ€å…©ï¼š<span id="shopMoneyDisplay">${gameState.money}</span> å…©</div>
        <div class="shop-items">
          <div class="shop-item" onclick="stayAtInn()">
            <div class="shop-item-icon">ğŸ›ï¸</div>
            <div class="shop-item-name">ä½å®¿ä¸€æ™š</div>
            <div style="font-size: 1.1em; color: #b3e5d8; margin: 8px 0;">æ¢å¾©æ‰€æœ‰è¡Œå‹•é»</div>
            <div class="shop-item-price">10 å…©</div>
          </div>
        </div>
        <div style="text-align: center; margin-top: 30px;">
          <button class="back-btn" onclick="backToMarket()">è¿”  è¡—å¸‚</button>
        </div>
      `;

      document.getElementById('shopContainer').innerHTML = html;
      switchScene('sceneMarket', 'sceneShop');
    }

    function stayAtInn() {
      if (gameState.money < 10) {
        showNarration('éŠ€å…©ä¸è¶³ï¼');
        return;
      }

      gameState.money -= 10;
      gameState.actionPoints = gameState.maxActionPoints;
      gameState.day++;

      if (gameState.day > 30) {
        gameState.day = 1;
        const currentIndex = seasons.indexOf(gameState.season);
        gameState.season = seasons[(currentIndex + 1) % 4];
        showNarration(`åœ¨å®¢æ£§ç¾ç¾ç¡äº†ä¸€è¦ºï¼Œ   ç¯€æ›´æ›¿ï¼Œç¾åœ¨æ˜¯${seasonNames[gameState.season]}äº†`);
      } else {
        showNarration('åœ¨å®¢æ£§ç¾ç¾ç¡äº†ä¸€è¦ºï¼Œç²¾ç¥ç…¥ç™¼ï¼');
      }

      updateUI();
      setTimeout(() => {
        backToMarket();
      }, 2000);
    }

    function buyItem(item) {
      if (gameState.money < item.price) {
        showNarration('éŠ€   ä¸è¶³ï¼');
        return;
      }

      gameState.money -= item.price;
      gameState.inventory.push({ id: item.id, name: item.name, icon: item.icon, value: Math.round(item.price * 0.6) });
      
      if (item.triggerLibai && !gameState.completedEvents.includes('met_libai')) {
        gameState.completedEvents.push('met_libai');
        const quest = gameState.mainQuests.find(q => q.id === 'q3');
        if (quest) quest.completed = true;
        showNarration('ä½ ç©¿ä¸Šè¯æœå¾Œæ°£è³ªéå‡¡ï¼Œåœ¨è¡—é ­å·§é‡æç™½ï¼æç™½å°ä½ ä¸€è¦‹å¦‚æ•…ï¼Œé‚€ä½ åŒéŠçš‡å®®ï¼');
      } else {
        showNarration(`è³¼è²·äº†${item.name}ï¼`);
      }

      consumeActionPoint();
      updateUI();

      if (item.quest) {
        const quest = [...gameState.mainQuests, ...gameState.sideQuests].find(q => q.id === item.quest);
        if (quest && !quest.completed) {
          if (quest.target) {
            quest.progress++;
            if (quest.progress >= quest.target) {
              quest.completed = true;
              showNarration(`ä»»å‹™å®Œæˆï¼š${quest.text}ï¼`);
            }
          } else {
            quest.completed = true;
            showNarration(`ä»»  å®Œæˆï¼š${quest.text}ï¼`);
          }
        }
      }

      document.getElementById('shopMoneyDisplay').textContent = gameState.money;
    }

    function visitAttraction(attraction) {
      if (gameState.actionPoints <= 0) {
        showNarration('ä»Šæ—¥è¡Œå‹•é»å·²ç”¨ç›¡ï¼');
        return;
      }

      const cityKey = gameState.currentCity;
      
      if (cityKey === 'changan' && attraction === 'æ›²æ±Ÿæ± ') {
        startPoetryInteraction('changan_qujiangchi');
        return;
      }
      if (cityKey === 'yangzhou' && attraction === 'äºŒåå››æ©‹') {
        startPoetryInteraction('yangzhou_bridge');
        return;
      }
      if (cityKey === 'youzhou' && attraction === 'èƒ¡äººé…’è‚†') {
        startPoetryInteraction('youzhou_jiulv');
        return;
      }
      if (cityKey === 'chengdu' && attraction === 'æœç”«è‰å ‚') {
        startPoetryInteraction('chengdu_caotang');
        return;
      }

      consumeActionPoint();
      showNarration(`ä½ æ¬£è³äº†${attraction}çš„ç¾æ™¯ï¼Œæš«ç„¡æ›´å¤šè©©è©æ•…äº‹ï¼Œæ•¬è«‹æœŸå¾…å¾ŒçºŒæ›´æ–°ï¼`);
    }

    function startPoetryInteraction(poetryKey) {
      currentPoetryKey = poetryKey;
      currentPoetryStage = 1;
      showPoetryStage1();
    }

    function showPoetryStage1() {
      const poetry = poetryData[currentPoetryKey];
      const stage = poetry.stage1;

      const choicesHTML = stage.choices.map(c => 
        `<button class="choice-btn" onclick="handlePoetryChoice('${c.action}')">${c.text}</button>`
      ).join('');

      document.getElementById('poetryContainer').innerHTML = `
        <div class="poetry-description">${stage.description}</div>
        <div class="poetry-choices">${choicesHTML}</div>
      `;
      
      const fromScene = document.querySelector('.scene.active').id;
      switchScene(fromScene, 'scenePoetry');
    }

    function handlePoetryChoice(action) {
      if (currentPoetryStage === 1) {
        showPoetryStage2(action);
      }
    }

    function showPoetryStage2(action) {
      currentPoetryStage = 2;
      const poetry = poetryData[currentPoetryKey];
      const text = poetry.stage2[action];

      document.getElementById('poetryContainer').innerHTML = `
        <div class="poetry-description">${text}</div>
        <div class="poetry-choices">
          <button class="choice-btn" onclick="revealPoetry()">âœï¸ è©©äººé–‹å§‹åŸè©©â€¦â€¦</button>
        </div>
      `;
    }

    function revealPoetry() {
      currentPoetryStage = 3;
      const poetry = poetryData[currentPoetryKey];
      const stage = poetry.stage3;

      const versesHTML = stage.verses.map((v, i) => 
        `<div class="poetry-reveal-verse" style="animation-delay: ${i * 1.8}s">${v}</div>`
      ).join('');

      document.getElementById('poetryRevealContainer').innerHTML = `
        <h2 class="poetry-reveal-title" style="animation: fadeInVerse 2s ease forwards;">ã€Š${stage.title}ã€‹</h2>
        <p class="poetry-reveal-author" style="animation: fadeInVerse 2s ease forwards; animation-delay: 0.8s;">ä½œè€…ï¼š${stage.author}</p>
        ${versesHTML}
        <button class="continue-btn" onclick="showPoetryStage4()" style="opacity: 0; animation: fadeInVerse 1.5s ease forwards; animation-delay: ${stage.verses.length * 1.8 + 1.5}s;">ç¹¼çºŒ</button>
      `;

      switchScene('scenePoetry', 'scenePoetryReveal');

      setTimeout(() => {
        document.querySelectorAll('.poetry-reveal-verse').forEach(v => v.classList.add('show'));
      }, 100);
    }

    function showPoetryStage4() {
      currentPoetryStage = 4;
      const poetry = poetryData[currentPoetryKey];
      const stage = poetry.stage4;

      const choicesHTML = stage.choices.map(c => 
        `<button class="choice-btn" onclick='completePoetry(${JSON.stringify(c.reward)})'>${c.text}</button>`
      ).join('');

      document.getElementById('poetryContainer').innerHTML = `
        <div class="poetry-description">${stage.description}</div>
        <div class="poetry-choices">${choicesHTML}</div>
      `;

      switchScene('scenePoetryReveal', 'scenePoetry');
    }

    function completePoetry(reward) {
      gameState.money += reward.money;

      if (reward.quest === 'poetry') {
        if (!gameState.completedPoetry.includes(currentPoetryKey)) {
          gameState.completedPoetry.push(currentPoetryKey);
          
          const quest = gameState.mainQuests.find(q => q.id === 'q2');
          if (quest && !quest.completed) {
            quest.progress++;
            if (quest.progress >= quest.target) {
              quest.completed = true;
              showNarration('ä¸»ç·šä»»å‹™å®Œæˆï¼šæ”¶é›†è©©è©ï¼');
            }
          }
        }
      } else if (reward.quest) {
        const quest = [...gameState.mainQuests, ...gameState.sideQuests].find(q => q.id === reward.quest);
        if (quest && !quest.completed) {
          if (quest.target) {
            quest.progress++;
            if (quest.progress >= quest.target) {
              quest.completed = true;
            }
          } else {
            quest.completed = true;
          }
          showNarration(`ä»»å‹™å®Œæˆï¼š${quest.text}ï¼`);
        }
      }

      consumeActionPoint();
      updateUI();
      showNarration(`ç²å¾— ${reward.money} å…©éŠ€å­ï¼`);
      
      setTimeout(() => {
        if (currentPoetryKey === 'changan_palace' || currentPoetryKey === 'changan_huaqingchi') {
          switchScene('scenePoetry', 'scenePalace');
        } else {
          switchScene('scenePoetry', 'sceneCityMap');
        }
      }, 2000);
    }

    function sleepUnderBridge() {
      if (gameState.actionPoints <= 0) {
        showNarration('ä»Šæ—¥è¡Œå‹•é»å·²ç”¨ç›¡ï¼');
        return;
      }

      if (gameState.season === 'winter') {
        gameState.bridgeSleepCount++;
        if (gameState.bridgeSleepCount >= 3) {
          showNarration('ä½ åœ¨å†¬å­£æ©‹æ´å—å‡é  ï¼Œä¸å¹¸ç—…é€â€¦â€¦éŠæˆ²çµæŸ');
          setTimeout(() => {
            document.getElementById('gameUI').style.display = 'none';
            switchScene('sceneCityMap', 'sceneCover');
          }, 3000);
          return;
        }
        showNarration('åœ¨å¯’å†·çš„   ä¸‹ç‘Ÿç‘Ÿç™¼æŠ–â€¦â€¦');
      } else {
        const random = Math.random();
        if (random < 0.3 && gameState.inventory.length > 0) {
          const lostItem = gameState.inventory.splice(Math.floor(Math.random() * gameState.inventory.length), 1)[0];
          showNarration(`å¤œè£¡é­é‡ç›œè³Šï¼Œå¤±å»äº†${lostItem.name}ï¼`);
        } else {
          showNarration('åœ¨æ©‹ä¸‹å‹‰å¼·åº¦   ä¸€å¤œ');
        }
      }

      consumeActionPoint();
      updateUI();
    }

    function openInventory() {
      const itemsHTML = gameState.inventory.length > 0 ? 
        gameState.inventory.map(item => `
          <div class="inventory-item">
            <div class="item-icon">${item.icon}</div>
            <div class="item-name">${item.name}</div>
            <div class="item-value">åƒ¹å€¼ ${item.value} å…©</div>
          </div>
        `).join('') : 
        '<p style="color: #b3e5d8; text-align: center; grid-column: 1/-1;">åŒ…è¢±ç©ºç©ºå¦‚ä¹Ÿ</p>';

      document.getElementById('inventoryGrid').innerHTML = itemsHTML;
      document.getElementById('inventoryModal').classList.add('active');
    }

    function closeInventory() {
      document.getElementById('inventoryModal').classList.remove('active');
    }

    function openSaveModal() {
      const timestamp = new Date().toLocaleString('zh-TW');
      document.getElementById('saveNameInput').value = `${gameState.playerName}çš„å­˜æª”_${timestamp}`;
      document.getElementById('saveModal').classList.add('active');
    }

    function closeSaveModal() {
      document.getElementById('saveModal').classList.remove('active');
    }

    async function confirmSave() {
      const saveName = document.getElementById('saveNameInput').value.trim();
      if (!saveName) {
        showNarration('è«‹è¼¸å…¥å­˜æª”  ç¨±ï¼');
        return;
      }

      if (allSaveRecords.length >= 999) {
        showNarration('å­˜æª”æ•¸é‡å·²é”ä¸Šé™ï¼ˆ999å€‹ï¼‰ï¼');
        return;
      }

      const saveData = {
        save_name: saveName,
        player_name: gameState.playerName,
        money: gameState.money,
        season: gameState.season,
        day: gameState.day,
        action_points: gameState.actionPoints,
        current_region: gameState.currentRegion,
        current_city: gameState.currentCity,
        bridge_sleep_count: gameState.bridgeSleepCount,
        inventory: JSON.stringify(gameState.inventory),
        main_quests: JSON.stringify(gameState.mainQuests),
        side_quests: JSON.stringify(gameState.sideQuests),
        visited_poetry: JSON.stringify(gameState.visitedPoetry),
        completed_poetry: JSON.stringify(gameState.completedPoetry),
        completed_events: JSON.stringify(gameState.completedEvents),
        merchant_investments: JSON.stringify(gameState.merchantInvestments),
        save_timestamp: new Date().toISOString()
      };

      const result = await window.dataSdk.create(saveData);
      if (result.isOk) {
        showNarration('å­˜æª”æˆåŠŸï¼');
        closeSaveModal();
      } else {
        showNarration('å­˜   å¤±æ•—ï¼Œè«‹ç¨å¾Œå†  ï¼');
      }
    }

    function openLoadModal() {
      if (allSaveRecords.length === 0) {
        showNarration('æ²’æœ‰å­˜æª”è¨˜éŒ„ï¼');
        return;
      }

      const savesHTML = allSaveRecords.map(save => {
        const saveDate = new Date(save.save_timestamp).toLocaleString('zh-TW');
        return `
          <div class="save-item" onclick='loadSaveFile(${JSON.stringify(save.__backendId)})'>
            <div class="save-item-name">${save.save_name}</div>
            <div class="save-item-info">
              ${save.player_name} | ğŸ’° ${save.money}å…© | ${seasonNames[save.season]}<br>
              ğŸ“… ${saveDate}
            </div>
          </div>
        `;
      }).join('');

      document.getElementById('saveList').innerHTML = savesHTML;
      document.getElementById('loadModal').classList.add('active');
    }

    function closeLoadModal() {
      document.getElementById('loadModal').classList.remove('active');
    }

    function loadSaveFile(backendId) {
      const save = allSaveRecords.find(s => s.__backendId === backendId);
      if (!save) return;

      gameState = {
        playerName: save.player_name,
        money: save.money,
        season: save.season,
        day: save.day,
        actionPoints: save.action_points,
        maxActionPoints: 5,
        currentRegion: save.current_region,
        currentCity: save.current_city,
        bridgeSleepCount: save.bridge_sleep_count,
        inventory: JSON.parse(save.inventory),
        mainQuests: JSON.parse(save.main_quests),
        sideQuests: JSON.parse(save.side_quests),
        visitedPoetry: JSON.parse(save.visited_poetry),
        completedPoetry: JSON.parse(save.completed_poetry),
        completedEvents: JSON.parse(save.completed_events || '[]'),
        merchantInvestments: JSON.parse(save.merchant_investments || '[]'),
        visitedCities: []
      };

      document.getElementById('gameUI').style.display = 'block';
      updateUI();
      closeLoadModal();
      switchScene('sceneCover', 'sceneRegionMap');
      showNarration('è®€  å­˜æª”æˆåŠŸï¼');
    }

    function backToMarket() {
      switchScene('sceneShop', 'sceneMarket');
    }

    function backToCityMap() {
      switchScene('sceneMarket', 'sceneCityMap');
    }

    function backToCitySelect() {
      switchScene('sceneCityMap', 'sceneCitySelect');
    }

    function backToRegionMap() {
      switchScene('sceneCitySelect', 'sceneRegionMap');
    }

    initSDK();
    updateUI();
  </script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è¸è©©éŠå”</title>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <style>
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Noto Serif TC', 'KaiTi', 'STKaiti', serif;
      background: linear-gradient(135deg, #a8d5e2 0%, #b3e5d8 100%);
      color: #2d5a5a;
      height: 100%;
      width: 100%;
      overflow: hidden;
    }

    html {
      height: 100%;
    }

    .game-ui-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1000;
    }

    .top-bar {
      position: fixed;
      top: 20px;
      right: 20px;
      display: flex;
      gap: 15px;
      pointer-events: auto;
    }

    .info-box {
      background: linear-gradient(135deg, rgba(139, 69, 19, 0.9) 0%, rgba(101, 67, 33, 0.9) 100%);
      border: 3px solid #d4af37;
      border-radius: 12px;
      padding: 12px 20px;
      color: #ffd700;
      font-size: 1.3em;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
      letter-spacing: 0.1em;
    }

    .quest-panel {
      position: fixed;
      left: 20px;
      top: 20px;
      width: 280px;
      max-height: 80%;
      background: linear-gradient(135deg, rgba(139, 69, 19, 0.95) 0%, rgba(101, 67, 33, 0.95) 100%);
      border: 3px solid #d4af37;
      border-radius: 15px;
      padding: 20px;
      pointer-events: auto;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
      overflow-y: auto;
    }

    .quest-title {
      font-size: 1.8em;
      color: #ffd700;
      text-align: center;
      margin-bottom: 20px;
      letter-spacing: 0.2em;
      border-bottom: 2px solid #d4af37;
      padding-bottom: 10px;
    }

    .quest-section {
      margin: 15px 0;
    }

    .quest-section-header {
      font-size: 1.4em;
      color: #ffeb3b;
      margin-bottom: 10px;
      letter-spacing: 0.1em;
      cursor: pointer;
      padding: 10px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .quest-section-header:hover {
      background: rgba(212, 175, 55, 0.2);
    }

    .quest-list {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }

    .quest-list.expanded {
      max-height: 500px;
    }

    .quest-item {
      background: rgba(0, 0, 0, 0.3);
      padding: 10px;
      margin: 8px 0;
      border-radius: 8px;
      border-left: 3px solid #ffd700;
      font-size: 1.1em;
      color: #b3e5d8;
      line-height: 1.6;
    }

    .quest-item.completed {
      opacity: 0.6;
      border-left-color: #4caf50;
    }

    .bottom-buttons {
      position: fixed;
      right: 20px;
      bottom: 20px;
      display: flex;
      gap: 15px;
      pointer-events: auto;
    }

    .round-button {
      width: 75px;
      height: 75px;
      background: linear-gradient(135deg, rgba(139, 69, 19, 0.9) 0%, rgba(101, 67, 33, 0.9) 100%);
      border: 3px solid #d4af37;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
      transition: all 0.3s ease;
    }

    .round-button:hover {
      transform: scale(1.1);
      box-shadow: 0 8px 25px rgba(212, 175, 55, 0.8);
    }

    .round-button.save {
      background: linear-gradient(135deg, rgba(90, 138, 138, 0.9) 0%, rgba(74, 157, 157, 0.9) 100%);
      border-color: #5a8a8a;
    }

    .button-icon {
      font-size: 2.2em;
    }

    .button-label {
      font-size: 0.95em;
      color: #ffd700;
      margin-top: 3px;
    }

    .narration {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(135deg, rgba(0, 0, 0, 0.85) 0%, rgba(20, 20, 20, 0.85) 100%);
      color: #ffd700;
      padding: 25px 40px;
      border-radius: 15px;
      border: 3px solid #d4af37;
      font-size: 1.6em;
      max-width: 80%;
      text-align: center;
      z-index: 2500;
      pointer-events: none;
      letter-spacing: 0.15em;
      line-height: 1.8;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.8);
      animation: narrationFade 4s ease forwards;
    }

    @keyframes narrationFade {
      0% { opacity: 0; transform: translate(-50%, 20px); }
      10% { opacity: 1; transform: translate(-50%, 0); }
      85% { opacity: 1; transform: translate(-50%, 0); }
      100% { opacity: 0; transform: translate(-50%, -20px); }
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      pointer-events: auto;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal-content {
      background: linear-gradient(135deg, rgba(139, 69, 19, 0.98) 0%, rgba(101, 67, 33, 0.98) 100%);
      border: 4px solid #d4af37;
      border-radius: 20px;
      padding: 40px;
      max-width: 900px;
      max-height: 85%;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.9);
      position: relative;
    }

    .modal-title {
      font-size: 2.5em;
      color: #ffd700;
      text-align: center;
      margin-bottom: 30px;
      letter-spacing: 0.3em;
    }

    .modal-close {
      position: absolute;
      top: 15px;
      right: 20px;
      font-size: 2.5em;
      color: #ffd700;
      cursor: pointer;
      background: none;
      border: none;
      padding: 5px 15px;
      line-height: 1;
    }

    .modal-close:hover {
      color: #fff;
    }

    .save-input-group {
      margin: 25px 0;
    }

    .save-input-label {
      display: block;
      color: #ffd700;
      font-size: 1.5em;
      margin-bottom: 10px;
      letter-spacing: 0.1em;
    }

    .save-input {
      width: 100%;
      padding: 15px;
      font-size: 1.4em;
      background: rgba(0, 0, 0, 0.3);
      border: 2px solid #d4af37;
      border-radius: 10px;
      color: #b3e5d8;
      font-family: 'Noto Serif TC', 'KaiTi', serif;
    }

    .save-list {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin: 20px 0;
      max-height: 400px;
      overflow-y: auto;
    }

    .save-item {
      background: rgba(0, 0, 0, 0.3);
      border: 2px solid #d4af37;
      border-radius: 10px;
      padding: 20px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .save-item:hover {
      background: rgba(212, 175, 55, 0.2);
      transform: translateX(5px);
    }

    .save-item-name {
      font-size: 1.6em;
      color: #ffd700;
      margin-bottom: 8px;
    }

    .save-item-info {
      font-size: 1.2em;
      color: #b3e5d8;
      line-height: 1.6;
    }

    .modal-buttons {
      display: flex;
      gap: 20px;
      justify-content: center;
      margin-top: 30px;
    }

    .modal-btn {
      padding: 15px 40px;
      font-size: 1.6em;
      background: linear-gradient(135deg, #5a8a8a 0%, #4a9d9d 100%);
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-family: 'Noto Serif TC', 'KaiTi', serif;
      letter-spacing: 0.2em;
      transition: all 0.3s ease;
    }

    .modal-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(90, 138, 138, 0.7);
    }

    .modal-btn.cancel {
      background: linear-gradient(135deg, rgba(90, 90, 90, 0.8) 0%, rgba(70, 70, 70, 0.8) 100%);
    }

    .inventory-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }

    .inventory-item {
      background: rgba(0, 0, 0, 0.3);
      border: 2px solid #d4af37;
      border-radius: 10px;
      padding: 15px;
      text-align: center;
    }

    .item-icon {
      font-size: 2.5em;
      margin-bottom: 10px;
    }

    .item-name {
      font-size: 1.2em;
      color: #b3e5d8;
      margin-bottom: 5px;
    }

    .item-value {
      font-size: 1em;
      color: #ffd700;
    }

    .game-container {
      width: 100%;
      height: 100%;
      position: relative;
      transition: background 1s ease;
    }

    .scene {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.8s ease, visibility 0s 0.8s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .scene.active {
      opacity: 1;
      visibility: visible;
      transition: opacity 0.8s ease, visibility 0s 0s;
    }

    /* é–‹å ´å ´æ™¯ */
    .scene-opening {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      flex-direction: column;
    }

    .opening-text {
      max-width: 900px;
      padding: 40px;
      background: linear-gradient(135deg, rgba(139, 69, 19, 0.8) 0%, rgba(101, 67, 33, 0.8) 100%);
      border: 4px solid #d4af37;
      border-radius: 20px;
      margin-bottom: 30px;
    }

    .opening-paragraph {
      font-size: 1.8em;
      color: #e0f7fa;
      line-height: 2.5;
      letter-spacing: 0.15em;
      margin: 25px 0;
      text-align: justify;
      text-indent: 2em;
    }

    .name-input-container {
      text-align: center;
      margin-top: 30px;
    }

    .name-input-label {
      font-size: 2em;
      color: #ffd700;
      margin-bottom: 20px;
      letter-spacing: 0.2em;
      display: block;
    }

    .name-input {
      padding: 20px 30px;
      font-size: 2em;
      background: rgba(0, 0, 0, 0.4);
      border: 3px solid #d4af37;
      border-radius: 10px;
      color: #ffd700;
      font-family: 'Noto Serif TC', 'KaiTi', serif;
      text-align: center;
      letter-spacing: 0.2em;
      min-width: 300px;
    }

    /* å°é¢é  */
    .scene-cover {
      background: linear-gradient(135deg, #FFB88C 0%, #FFA07A 30%, #FF8C69 60%, #87CEEB 100%);
      flex-direction: column;
    }

    .book-cover {
      width: 800px;
      height: 600px;
      background: linear-gradient(180deg, #FFD700 0%, #FFA500 20%, #FF8C69 40%, #87CEEB 70%, #4682B4 100%);
      border: 8px solid #D4A574;
      border-radius: 15px;
      position: relative;
      box-shadow: 0 30px 80px rgba(0, 0, 0, 0.4);
      overflow: hidden;
      margin-bottom: 30px;
    }

    .book-title {
      position: absolute;
      top: 30px;
      right: 40px;
      font-size: 3.5em;
      color: #8B4513;
      writing-mode: vertical-rl;
      letter-spacing: 0.3em;
      text-shadow: 2px 2px 8px rgba(255, 255, 255, 0.8);
      z-index: 10;
      font-weight: bold;
    }

    .cover-illustration {
      width: 100%;
      height: 100%;
      position: relative;
    }

    /* æ—¥è½å¤ªé™½ */
    .cover-sun {
      position: absolute;
      top: 8%;
      right: 15%;
      width: 100px;
      height: 100px;
      background: radial-gradient(circle, #FFF8DC 0%, #FFD700 50%, #FFA500 100%);
      border-radius: 50%;
      box-shadow: 0 0 60px rgba(255, 215, 0, 0.9);
      z-index: 1;
    }

    /* é•·æ±Ÿæ°´é¢æ•ˆæœ */
    .cover-river {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 40%;
      background: linear-gradient(180deg, rgba(135, 206, 235, 0.8) 0%, rgba(70, 130, 180, 0.9) 100%);
      z-index: 2;
    }

    .cover-river-shimmer {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(0deg, 
        rgba(255, 215, 0, 0.3) 0%, 
        rgba(255, 165, 0, 0.2) 30%, 
        transparent 60%);
      animation: shimmer 3s ease-in-out infinite;
    }

    @keyframes shimmer {
      0%, 100% { opacity: 0.5; }
      50% { opacity: 0.8; }
    }

    /*      æ¨“ */
    .cover-tower {
      position: absolute;
      bottom: 35%;
      left: 12%;
      width: 200px;
      height: 260px;
      z-index: 4;
    }

    /* ç©¿è¶Šè€…è§’è‰²å€‘ */
    .cover-travelers {
      position: absolute;
      bottom: 38%;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 30px;
      z-index: 5;
    }

    .cover-traveler {
      width: 120px;
      height: 160px;
    }

    /* é£›èˆçš„æ›¸å· */
    .cover-scrolls {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 6;
      pointer-events: none;
    }

    .cover-scroll {
      position: absolute;
      animation: floatScroll 10s ease-in-out infinite;
    }

    .cover-scroll:nth-child(1) {
      top: 15%;
      left: 15%;
      animation-delay: 0s;
    }

    .cover-scroll:nth-child(2) {
      top: 20%;
      right: 12%;
      animation-delay: 2.5s;
    }

    .cover-scroll:nth-child(3) {
      top: 45%;
      left: 8%;
      animation-delay: 5s;
    }

    .cover-scroll:nth-child(4) {
      top: 50%;
      right: 20%;
      animation-delay: 7.5s;
    }

    @keyframes floatScroll {
      0%, 100% { 
        transform: translateY(0) rotate(-8deg); 
        opacity: 0.7; 
      }
      50% { 
        transform: translateY(-25px) rotate(8deg); 
        opacity: 1; 
      }
    }

    .menu-buttons {
      display: flex;
      flex-direction: column;
      gap: 20px;
      align-items: center;
    }

    .menu-btn {
      padding: 15px 60px;
      font-size: 1.8em;
      background: linear-gradient(135deg, #5a8a8a 0%, #4a9d9d 100%);
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-family: 'Noto Serif TC', 'KaiTi', serif;
      letter-spacing: 0.3em;
      transition: all 0.3s ease;
      box-shadow: 0 5px 20px rgba(90, 138, 138, 0.5);
    }

    .menu-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(90, 138, 138, 0.7);
    }

    .menu-btn.secondary {
      background: linear-gradient(135deg, rgba(90, 138, 138, 0.7) 0%, rgba(74, 157, 157, 0.7) 100%);
    }

    /* åœ°åœ–å ´æ™¯ */
    .map-scene {
      padding: 2%;
      overflow-y: auto;
    }

    .map-container {
      max-width: 95%;
      width: 1600px;
      margin: 0 auto;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.08) 100%);
      border: 4px solid #5a8a8a;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .map-title {
      text-align: center;
      font-size: 3em;
      color: #2d5a5a;
      margin: 0 0 30px 0;
      letter-spacing: 0.3em;
      text-shadow: 0 2px 5px rgba(255, 255, 255, 0.5);
    }

    .map-svg {
      width: 100%;
      height: auto;
      min-height: 600px;
    }

    .location-marker {
      cursor: pointer;
      transition: transform 0.2s ease;
    }

    .location-marker:hover {
      transform: scale(1.08);
    }

    .location-marker circle {
      fill: #5a8a8a;
      stroke: #2d5a5a;
      stroke-width: 2;
      transition: all 0.3s ease;
    }

    .location-marker:hover circle {
      fill: #4a9d9d;
      filter: drop-shadow(0 0 8px rgba(74, 157, 157, 0.8));
    }

    .location-marker text {
      fill: #fff;
      font-size: 18px;
      font-weight: bold;
      text-anchor: middle;
      pointer-events: none;
    }

    /* åŸå¸‚é¸æ“‡åœ°åœ– */
    .city-select-container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .region-name {
      font-size: 3.5em;
      color: #2d5a5a;
      text-align: center;
      letter-spacing: 0.3em;
      text-shadow: 0 2px 10px rgba(255, 255, 255, 0.5);
      margin: 0 0 40px 0;
    }

    .city-select-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 30px;
      margin: 40px 0;
    }

    .city-select-card {
      height: 180px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .city-select-card:hover {
      transform: translateY(-8px);
    }

    .city-select-icon {
      font-size: 5em;
      margin-bottom: 15px;
    }

    .city-select-name {
      font-size: 2em;
      color: #2d5a5a;
      letter-spacing: 0.3em;
      text-align: center;
      text-shadow: 0 2px 5px rgba(255, 255, 255, 0.8);
    }

    /* åŸå¸‚åœ°åœ– */
    .city-map-container {
      max-width: 1600px;
      margin: 0 auto;
    }

    .city-map-header {
      text-align: center;
      margin-bottom: 30px;
    }

    .city-name {
      font-size: 3.5em;
      color: #2d5a5a;
      letter-spacing: 0.3em;
      text-shadow: 0 2px 10px rgba(255, 255, 255, 0.5);
      margin: 0 0 20px 0;
    }

    .city-locations {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 25px;
      margin: 40px 0;
    }

    .location-card {
      height: 180px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .location-card:hover {
      transform: translateY(-8px);
    }

    .location-card.locked {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .location-icon {
      font-size: 4em;
      margin-bottom: 15px;
    }

    .location-label {
      font-size: 1.6em;
      color: #2d5a5a;
      letter-spacing: 0.2em;
      text-align: center;
      text-shadow: 0 2px 5px rgba(255, 255, 255, 0.8);
    }

    .location-note {
      font-size: 1em;
      color: #666;
      margin-top: 8px;
      text-align: center;
    }

    /* è¡—å¸‚å ´æ™¯ */
    .market-scene {
      padding: 3%;
      overflow-y: auto;
    }

    .market-container {
      max-width: 1600px;
      margin: 0 auto;
    }

    .market-title {
      font-size: 3em;
      color: #2d5a5a;
      text-align: center;
      margin-bottom: 40px;
      letter-spacing: 0.3em;
      text-shadow: 0 2px 10px rgba(255, 255, 255, 0.5);
    }

    .market-shops {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 25px;
      margin: 40px 0;
    }

    .market-shop-card {
      height: 180px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .market-shop-card:hover {
      transform: translateY(-8px);
    }

    /* å•†åº—å ´æ™¯ */
    .shop-scene {
      padding: 3%;
      overflow-y: auto;
    }

    .shop-container {
      max-width: 1000px;
      margin: 0 auto;
      background: linear-gradient(135deg, rgba(139, 69, 19, 0.7) 0%, rgba(101, 67, 33, 0.7) 100%);
      border: 4px solid #d4af37;
      border-radius: 20px;
      padding: 40px;
    }

    .shop-title {
      font-size: 3em;
      color: #ffd700;
      text-align: center;
      margin-bottom: 20px;
      letter-spacing: 0.3em;
    }

    .shop-description {
      text-align: center;
      color: #b3e5d8;
      font-size: 1.4em;
      line-height: 1.8;
      margin-bottom: 25px;
      padding: 15px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 10px;
    }

    .money-display {
      text-align: center;
      font-size: 1.6em;
      color: #ffd700;
      margin: 20px 0;
      padding: 12px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 10px;
    }

    .shop-items {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 20px;
      margin: 30px 0;
    }

    .shop-item {
      background: rgba(0, 0, 0, 0.3);
      border: 2px solid #d4af37;
      border-radius: 10px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .shop-item:hover {
      background: rgba(212, 175, 55, 0.2);
      transform: scale(1.05);
    }

    .shop-item-icon {
      font-size: 3em;
      margin-bottom: 10px;
    }

    .shop-item-name {
      font-size: 1.4em;
      color: #b3e5d8;
      margin-bottom: 10px;
    }

    .shop-item-price {
      font-size: 1.2em;
      color: #ffd700;
    }

    /* è©©è©äº’  å ´æ™¯ */
    .poetry-scene {
      padding: 3%;
      overflow-y: auto;
    }

    .poetry-container {
      max-width: 1000px;
      margin: 0 auto;
    }

    .poetry-description {
      background: linear-gradient(135deg, rgba(90, 138, 138, 0.4) 0%, rgba(74, 157, 157, 0.4) 100%);
      border: 3px solid #5a8a8a;
      border-radius: 15px;
      padding: 30px;
      margin-bottom: 30px;
      color: #e0f7fa;
      font-size: 1.7em;
      line-height: 2.2;
      text-align: center;
      letter-spacing: 0.12em;
    }

    .poetry-choices {
      display: flex;
      gap: 20px;
      margin-top: 30px;
      flex-wrap: wrap;
    }

    .choice-btn {
      flex: 1;
      min-width: 200px;
      padding: 25px;
      font-size: 1.7em;
      background: linear-gradient(135deg, rgba(90, 138, 138, 0.4) 0%, rgba(74, 157, 157, 0.4) 100%);
      border: 3px solid #5a8a8a;
      color: #e0f7fa;
      border-radius: 12px;
      cursor: pointer;
      font-family: 'Noto Serif TC', 'KaiTi', serif;
      letter-spacing: 0.2em;
      transition: all 0.3s ease;
      text-align: center;
    }

    .choice-btn:hover {
      background: linear-gradient(135deg, #5a8a8a 0%, #4a9d9d 100%);
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(90, 138, 138, 0.7);
    }

    /* ç™½å¹•è©©è©é¡¯ç¤º */
    .poetry-reveal-scene {
      background: #ffffff;
    }

    .poetry-reveal-container {
      max-width: 900px;
      text-align: center;
      padding: 40px;
    }

    .poetry-reveal-title {
      font-size: 3.2em;
      color: #2d5a5a;
      margin-bottom: 25px;
      letter-spacing: 0.3em;
      opacity: 0;
    }

    .poetry-reveal-author {
      font-size: 2em;
      color: #5a8a8a;
      margin-bottom: 50px;
      opacity: 0;
    }

    .poetry-reveal-verse {
      font-size: 2.6em;
      color: #2d5a5a;
      line-height: 2.8;
      letter-spacing: 0.35em;
      margin: 35px 0;
      opacity: 0;
    }

    .poetry-reveal-verse.show {
      animation: fadeInVerse 2.5s ease forwards;
    }

    @keyframes fadeInVerse {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .continue-btn {
      margin-top: 50px;
      padding: 20px 60px;
      font-size: 1.8em;
      background: linear-gradient(135deg, #5a8a8a 0%, #4a9d9d 100%);
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-family: 'Noto Serif TC', 'KaiTi', serif;
      letter-spacing: 0.2em;
      transition: all 0.3s ease;
      box-shadow: 0 5px 20px rgba(90, 138, 138, 0.5);
    }

    .continue-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(90, 138, 138, 0.7);
    }

    .back-btn {
      margin-top: 30px;
      padding: 18px 50px;
      font-size: 1.6em;
      background: linear-gradient(135deg, rgba(90, 90, 90, 0.8) 0%, rgba(70, 70, 70, 0.8) 100%);
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-family: 'Noto Serif TC', 'KaiTi', serif;
      letter-spacing: 0.2em;
      transition: all 0.3s ease;
    }

    .back-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
    }

    .input-error {
      color: #ff6b6b;
      font-size: 1.2em;
      margin-top: 15px;
      text-align: center;
    }

    /* åº—å°äºŒå‘½åå ´æ™¯ */
    .scene-naming {
      background: linear-gradient(135deg, #8b7355 0%, #6b5742 100%);
      flex-direction: column;
    }

    .naming-container {
      max-width: 800px;
      padding: 40px;
      background: linear-gradient(135deg, rgba(245, 222, 179, 0.95) 0%, rgba(222, 184, 135, 0.95) 100%);
      border: 4px solid #8b6f47;
      border-radius: 20px;
    }

    .waiter-scene-content {
      display: flex;
      align-items: center;
      gap: 30px;
      margin-bottom: 30px;
    }

    .waiter-character {
      width: 200px;
      height: 280px;
      flex-shrink: 0;
    }

    .waiter-dialogue {
      flex: 1;
      font-size: 1.8em;
      color: #2d5a5a;
      line-height: 2.2;
      letter-spacing: 0.15em;
      text-align: left;
      padding: 25px;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 15px;
      border: 3px solid #8b6f47;
    }

    @media (max-width: 768px) {
      .quest-panel {
        width: 220px;
      }

      .round-button {
        width: 60px;
        height: 60px;
      }

      .city-locations, .city-select-grid, .market-shops {
        grid-template-columns: repeat(3, 1fr);
      }
    }
  </style> <!-- éŠæˆ²UIç–ŠåŠ å±¤ -->
  <div class="game-ui-overlay" id="gameUI" style="display: none;">
   <div class="top-bar">
    <div class="info-box" id="seasonDisplay">
     æ˜¥å­£ ä¸Šæ—¬
    </div>
    <div class="info-box" id="actionDisplay">
     è¡Œå‹•é»: 5/5
    </div>
    <div class="info-box" id="moneyDisplay">
     ğŸ’° 100å…©
    </div>
   </div>
   <div class="quest-panel">
    <div class="quest-title">
     ä»»å‹™
    </div>
    <div class="quest-section">
     <div class="quest-section-header" onclick="toggleQuestSection('main')"><span>ğŸ¯ ä¸»ç·šä»»å‹™</span> <span id="mainToggle">â–¼</span>
     </div>
     <div class="quest-list" id="mainQuestList"></div>
    </div>
    <div class="quest-section">
     <div class="quest-section-header" onclick="toggleQuestSection('side')"><span>ğŸ“‹ æ”¯ç·šä»»å‹™</span> <span id="sideToggle">â–¼</span>
     </div>
     <div class="quest-list" id="sideQuestList"></div>
    </div>
   </div>
   <div class="bottom-buttons">
    <div class="round-button save" onclick="openSaveModal()">
     <div class="button-icon">
      ğŸ’¾
     </div>
     <div class="button-label">
      å­˜  
     </div>
    </div>
    <div class="round-button" onclick="openInventory()">
     <div class="button-icon">
      ğŸ’
     </div>
     <div class="button-label">
      åŒ…è¢±
     </div>
    </div>
   </div>
  </div><!-- å­˜æª”æ¨¡æ…‹æ¡† -->
  <div class="modal-overlay" id="saveModal">
   <div class="modal-content"><button class="modal-close" onclick="closeSaveModal()">Ã—</button>
    <h2 class="modal-title">å­˜æª”</h2>
    <div class="save-input-group"><label class="save-input-label">å­˜æª”åç¨±ï¼š</label> <input type="text" class="save-input" id="saveNameInput" placeholder="è¼¸å…¥å­˜æª”åç¨±..." maxlength="30">
    </div>
    <div class="modal-buttons"><button class="modal-btn" onclick="confirmSave()">ç¢ºèªå­˜æª”</button> <button class="modal-btn cancel" onclick="closeSaveModal()">å–æ¶ˆ</button>
    </div>
   </div>
  </div><!-- è®€æª”æ¨¡æ…‹æ¡† -->
  <div class="modal-overlay" id="loadModal">
   <div class="modal-content"><button class="modal-close" onclick="closeLoadModal()">Ã—</button>
    <h2 class="modal-title">è®€å–å­˜æª”</h2>
    <div class="save-list" id="saveList"></div>
    <div class="modal-buttons"><button class="modal-btn cancel" onclick="closeLoadModal()">å–æ¶ˆ</button>
    </div>
   </div>
  </div><!-- åŒ…è¢±æ¨¡æ…‹æ¡† -->
  <div class="modal-overlay" id="inventoryModal">
   <div class="modal-content"><button class="modal-close" onclick="closeInventory()">Ã—</button>
    <h2 class="modal-title">åŒ…è¢±</h2>
    <div class="money-display">
     æŒæœ‰éŠ€å…©ï¼š<span id="modalMoneyDisplay">100</span> å…©
    </div>
    <h3 style="color: #ffd700; font-size: 1.8em; margin: 20px 0;">èº«ä¸Šç‰©å“</h3>
    <div class="inventory-grid" id="inventoryGrid"></div>
    <div style="text-align: center; margin-top: 30px;"><button class="continue-btn" onclick="closeInventory()">é—œé–‰</button>
    </div>
   </div>
  </div>
  <div class="game-container" id="gameContainer"><!-- å ´æ™¯1: é–‹å ´åŠ‡æƒ… -->
   <div class="scene scene-opening" id="sceneOpening">
    <div class="opening-text">
     <p class="opening-paragraph">å¤§å”é–‹å…ƒç››ä¸–ï¼Œå¤©å¯¶å¹´é–“ã€‚é•·å®‰åŸ   ç¹è¯å–§å›‚ï¼Œèƒ¡å•†çµ¡ç¹¹ä¸çµ•ï¼Œå››æµ·è³“æœ‹é›²é›†ã€‚ä½ è‡ªå¹¼é£½è®€è©©æ›¸ï¼Œå¿ƒæ‡·éŠæ­·å¤©ä¸‹ã€çµäº¤åå£«ä¹‹å¿—ã€‚</p>
     <p class="opening-paragraph">æŸæ—¥ï¼Œä½ æ–¼æ›¸è‚†ä¸­å¶å¾—ã€Šå”è©©é¸é›†ã€‹æ®˜å·ï¼Œå…¶ä¸­è©©å¥é›‹æ°¸å‹•äººï¼Œä»¤ä½ å¿ƒé¦³ç¥å¾€ã€‚ä½ æ±ºæ„é›¢é–‹å®¶é„‰ï¼Œè¸ä¸Šè©©å¢ƒä¹‹æ—…ï¼Œå°‹è¨ªå¤§å”å„åœ°å   ï¼Œé«”æ‚Ÿè©©äººç­†ä¸‹çš„å±±å·é¢¨   â€¦â€¦</p>
     <p class="opening-paragraph">è‡¨è¡Œå‰ï¼Œæ¯è¦ªç‚ºä½ å‚™å¥½è¡Œå›Šï¼Œçˆ¶è¦ªè´ˆä½ ç™¾å…©éŠ€å­ã€‚ä½ èƒŒèµ·åŒ…è¢±ï¼Œè¸å‡ºå®¶é–€ï¼Œé–‹å•Ÿå±¬æ–¼è‡ªå·±çš„å‚³å¥‡ã€‚</p>
     <div style="text-align: center; margin-top: 30px;"><button class="continue-btn" onclick="goToNaming()">è¸ä¸Šæ—…é€”</button>
     </div>
    </div>
   </div><!-- å ´æ™¯2: åº—å°äºŒå‘½å -->
   <div class="scene scene-naming" id="sceneNaming">
    <div class="naming-container">
     <div class="waiter-icon">
      ğŸµ
     </div>
     <p class="waiter-dialogue">ã€Œå®¢å®˜æ‚¨å¥½ï¼å°çš„æ˜¯é€™å®¢æ£§çš„åº—å°äºŒã€‚çœ‹æ‚¨é€™æ‰“  ï¼Œ  è¦å‡ºé é–€å§ï¼Ÿä¸çŸ¥å®¢å®˜   å§“å¤§  ï¼Ÿã€</p>
     <div class="name-input-container"><input type="text" id="playerNameInput" class="name-input" placeholder="å‘Š  åº—å°äºŒä½    å   ..." maxlength="10">
      <div id="nameError" class="input-error"></div>
      <div style="margin-top: 30px;"><button class="continue-btn" onclick="confirmName()">å‘Šè¨´åº—å°äºŒ</button>
      </div>
     </div>
    </div>
   </div><!-- å ´æ™¯3: å°é¢é  -->
   <div class="scene scene-cover active" id="sceneCover">
    <div class="book-cover">
     <h1 class="book-title" id="gameTitle">è¸è©©éŠå”</h1>
     <div class="cover-illustration"><!-- æ—¥è½å¤©ç©º -->
      <div class="sunset-sky">
       <div class="sun"></div>
      </div><!-- é»ƒé¶´æ¨“ SVG -->
      <svg class="yellow-crane-tower" viewbox="0 0 180 220" xmlns="http://www.w3.org/2000/svg"><!-- æ¨“èº« --> <polygon points="40,180 140,180 130,150 50,150" fill="#8B4513" stroke="#654321" stroke-width="2" /> <polygon points="35,150 145,150 135,120 45,120" fill="#A0522D" stroke="#654321" stroke-width="2" /> <polygon points="30,120 150,120 140,90 40,90" fill="#8B4513" stroke="#654321" stroke-width="2" /> <!-- å±‹é ‚ --> <polygon points="20,90 160,90 170,70 10,70" fill="#CD5C5C" stroke="#8B3A3A" stroke-width="2" /> <polygon points="15,70 165,70 175,50 5,50" fill="#DC143C" stroke="#8B3A3A" stroke-width="2" /> <polygon points="10,50 170,50 180,30 0,30" fill="#CD5C5C" stroke="#8B3A3A" stroke-width="2" /> <!-- å¡”å°– --> <polygon points="70,30 110,30 90,0" fill="#FFD700" stroke="#DAA520" stroke-width="2" /> <!--   æˆ¶ --> <rect x="60" y="125" width="20" height="20" fill="#FFF8DC" stroke="#654321" /> <rect x="100" y="125" width="20" height="20" fill="#FFF8DC" stroke="#654321" /> <rect x="70" y="95" width="15" height="15" fill="#FFF8DC" stroke="#654321" /> <rect x="95" y="95" width="15" height="15" fill="#FFF8DC" stroke="#654321" />
      </svg><!-- ç©¿è¶Šè€…å°‘å¥³å°‘å¹´ SVG -->
      <div class="travelers"><!-- å°‘å¥³ -->
       <svg class="traveler" viewbox="0 0 100 140" xmlns="http://www.w3.org/2000/svg"><!-- èº«é«” --> <ellipse cx="50" cy="120" rx="25" ry="18" fill="#FFB6C1" /> <rect x="30" y="70" width="40" height="50" rx="8" fill="#FFC0CB" /> <!-- é ­éƒ¨ --> <circle cx="50" cy="35" r="20" fill="#FFE4C4" /> <!-- é ­é«® --> <path d="M 30 35 Q 30 15 50 15 Q 70 15 70 35 L 65 40 Q 50 25 35 40 Z" fill="#2C1810" /> <!-- çœ¼ç› --> <circle cx="43" cy="35" r="3" fill="#000" /> <circle cx="57" cy="35" r="3" fill="#000" /> <!-- å¾®ç¬‘ --> <path d="M 42 42 Q 50 46 58 42" stroke="#000" stroke-width="2" fill="none" /> <!-- æ‰‹è‡‚ --> <rect x="20" y="75" width="10" height="35" rx="5" fill="#FFDAB9" /> <rect x="70" y="75" width="10" height="35" rx="5" fill="#FFDAB9" /> <!-- æ›¸å· --> <rect x="15" y="100" width="18" height="25" rx="2" fill="#F5DEB3" stroke="#8B6914" stroke-width="1" />
       </svg><!-- å°‘å¹´ -->
       <svg class="traveler" viewbox="0 0 100 140" xmlns="http://www.w3.org/2000/svg"><!-- èº«é«” --> <ellipse cx="50" cy="120" rx="25" ry="18" fill="#87CEEB" /> <rect x="30" y="70" width="40" height="50" rx="8" fill="#87CEFA" /> <!-- é ­éƒ¨ --> <circle cx="50" cy="35" r="20" fill="#FFE4C4" /> <!-- é ­é«® --> <path d="M 32 30 Q 35 18 50 15 Q 65 18 68 30 L 65 35 Q 50 22 35 35 Z" fill="#2C1810" /> <!-- çœ¼ç› --> <circle cx="43" cy="35" r="3" fill="#000" /> <circle cx="57" cy="35" r="3" fill="#000" /> <!-- å¾®ç¬‘ --> <path d="M 42 42 Q 50 46 58 42" stroke="#000" stroke-width="2" fill="none" /> <!-- æ‰‹è‡‚ --> <rect x="20" y="75" width="10" height="35" rx="5" fill="#FFDAB9" /> <rect x="70" y="75" width="10" height="35" rx="5" fill="#FFDAB9" /> <!-- æ‰‡å­ --> <path d="M 75 95 L 85 85 L 85 105 Z" fill="#FFF" stroke="#000" stroke-width="1" />
       </svg>
      </div><!--    æ±Ÿæ°´é¢ -->
      <div class="river">
       <div class="river-reflection"></div>
      </div><!-- é£›èˆæ›¸å· -->
      <div class="flying-scrolls">
       <div class="scroll"></div>
       <div class="scroll"></div>
       <div class="scroll"></div>
       <div class="scroll"></div>
      </div>
     </div>
    </div>
    <div class="menu-buttons"><button class="menu-btn" onclick="startNewGame()">é–‹å§‹éŠæˆ²</button> <button class="menu-btn secondary" onclick="openLoadModal()">è®€å–å­˜æª”</button>
    </div>
   </div><!-- å ´æ™¯4: å¤§å”åé“åœ°åœ– -->
   <div class="scene map-scene" id="sceneRegionMap">
    <div class="map-container">
     <h2 class="map-title">å¤§å”åé“</h2>
     <svg class="map-svg" viewbox="0 0 1200 800" xmlns="http://www.w3.org/2000/svg"><rect x="0" y="0" width="1200" height="800" fill="rgba(245, 235, 220, 0.2)" /> <path d="M 200 320 Q 280 290 360 310 Q 440 330 520 300 Q 600 270 680 295" fill="rgba(139, 90, 60, 0.5)" stroke="rgba(100, 60, 40, 0.6)" stroke-width="1" /> <path d="M 150 250 Q 300 240 450 255 Q 600 270 750 260" fill="none" stroke="rgba(100, 180, 200, 0.7)" stroke-width="3" /> <path d="M 100 520 Q 300 515 500 530 Q 700 545 900 535" fill="none" stroke="rgba(100, 180, 200, 0.7)" stroke-width="3" /> <g class="location-marker" onclick="enterRegion('guannei')">
       <circle cx="350" cy="280" r="32" />
       <text x="350" y="290">
        é—œå…§
       </text>
      </g> <g class="location-marker" onclick="enterRegion('hebei')">
       <circle cx="620" cy="200" r="32" />
       <text x="620" y="210">
        æ²³åŒ—
       </text>
      </g> <g class="location-marker" onclick="enterRegion('hedong')">
       <circle cx="480" cy="240" r="32" />
       <text x="480" y="250">
        æ²³æ±
       </text>
      </g> <g class="location-marker" onclick="enterRegion('henan')">
       <circle cx="550" cy="360" r="32" />
       <text x="550" y="370">
        æ²³å—
       </text>
      </g> <g class="location-marker" onclick="enterRegion('shannan')">
       <circle cx="500" cy="480" r="32" />
       <text x="500" y="490">
        å±±   
       </text>
      </g> <g class="location-marker" onclick="enterRegion('huainan')">
       <circle cx="680" cy="430" r="32" />
       <text x="680" y="440">
        æ·®å—
       </text>
      </g> <g class="location-marker" onclick="enterRegion('jiangnan')">
       <circle cx="820" cy="540" r="32" />
       <text x="820" y="550">
        æ±Ÿå—
       </text>
      </g> <g class="location-marker" onclick="enterRegion('jiannan')">
       <circle cx="280" cy="480" r="32" />
       <text x="280" y="490">
        åŠå—
       </text>
      </g> <g class="location-marker" onclick="enterRegion('longright')">
       <circle cx="200" cy="300" r="32" />
       <text x="200" y="310">
        éš´å³
       </text>
      </g> <g class="location-marker" onclick="enterRegion('lingnan')">
       <circle cx="700" cy="680" r="32" />
       <text x="700" y="690">
        å¶ºå—
       </text>
      </g>
     </svg>
    </div>
   </div><!-- å ´æ™¯5: åŸå¸‚é¸æ“‡ -->
   <div class="scene map-scene" id="sceneCitySelect">
    <div class="city-select-container">
     <h2 class="region-name" id="currentRegionName">é—œå…§é“</h2>
     <div class="city-select-grid" id="citySelectGrid"></div>
     <div style="text-align: center; margin-top: 40px;"><button class="continue-btn" onclick="backToRegionMap()">è¿”å›åé“åœ°åœ–</button>
     </div>
    </div>
   </div><!-- å ´æ™¯6: åŸå¸‚åœ°åœ– -->
   <div class="scene map-scene" id="sceneCityMap">
    <div class="city-map-container">
     <div class="city-map-header">
      <h2 class="city-name" id="currentCityName">é•·å®‰</h2>
     </div>
     <div class="city-locations" id="cityLocations"></div>
     <div style="text-align: center; margin-top: 40px;"><button class="continue-btn" onclick="backToCitySelect()">è¿”å›åŸå¸‚é¸æ“‡</button>
     </div>
    </div>
   </div><!-- å ´æ™¯7: è¡—å¸‚å ´æ™¯ -->
   <div class="scene market-scene" id="sceneMarket">
    <div class="market-container">
     <h2 class="market-title" id="marketTitle">è¡—å¸‚</h2>
     <div class="market-shops" id="marketShops"></div>
     <div style="text-align: center; margin-top: 40px;"><button class="continue-btn" onclick="backToCityMap()">è¿”å›åŸå¸‚</button>
     </div>
    </div>
   </div><!-- å ´æ™¯8: å•†åº—å ´æ™¯ -->
   <div class="scene shop-scene" id="sceneShop">
    <div class="shop-container" id="shopContainer"></div>
   </div><!-- å ´æ™¯9: è©©è©äº’å‹•å ´æ™¯ -->
   <div class="scene poetry-scene" id="scenePoetry">
    <div class="poetry-container" id="poetryContainer"></div>
   </div><!-- å ´æ™¯10: ç™½å¹•è©©è©é¡¯ç¤º -->
   <div class="scene poetry-reveal-scene" id="scenePoetryReveal">
    <div class="poetry-reveal-container" id="poetryRevealContainer"></div>
   </div><!-- å ´æ™¯11: çš‡å®®å…§éƒ¨ï¼ˆå«è¯æ¸…æ± ï¼‰ -->
   <div class="scene map-scene" id="scenePalace">
    <div class="city-map-container">
     <div class="city-map-header">
      <h2 class="city-name">å¤§æ˜å®®</h2>
     </div>
     <div class="city-locations" id="palaceLocations"></div>
     <div style="text-align: center; margin-top: 40px;"><button class="continue-btn" onclick="backToCityMapFromPalace()">è¿”å›é•·å®‰</button>
     </div>
    </div>
   </div>
  </div>
  <script>
    const defaultConfig = { game_title: "è¸è©©éŠå”" };

    let gameState = {
      playerName: '',
      money: 100,
      season: 'spring',
      day: 1,
      actionPoints: 5,
      maxActionPoints: 5,
      currentRegion: '',
      currentCity: '',
      bridgeSleepCount: 0,
      inventory: [],
      mainQuests: [
        { id: 'q1', text: 'æ¢ç´¢å¤§å”å„é“åŸå¸‚', progress: 0, target: 5, completed: false },
        { id: 'q2', text: 'æ”¶é›†è©©è©', progress: 0, target: 10, completed: false },
        { id: 'q3', text: 'çµäº¤æç™½', completed: false }
      ],
      sideQuests: [
        { id: 's1', text: 'èˆ‡èƒ¡å§¬å°è©±', completed: false },
        { id: 's2', text: 'è³¼è²·ä¸€å¥—è¯æœ', completed: false },
        { id: 's3', text: 'å“åšå„åœ°ç¾é£Ÿ', progress: 0, target: 3, completed: false }
      ],
      visitedPoetry: [],
      completedPoetry: [],
      completedEvents: [],
      merchantInvestments: [],
      visitedCities: []
    };

    let allSaveRecords = [];
    let currentPoetryKey = null;
    let currentPoetryStage = 1;
    let currentShopType = '';

    const seasons = ['spring', 'summer', 'autumn', 'winter'];
    const seasonNames = { spring: 'æ˜¥å­£', summer: 'å¤å­£', autumn: 'ç§‹å­£', winter: 'å†¬å­£' };

    // å€åŸŸèˆ‡åŸå¸‚è³‡æ–™
    const regionData = {
      guannei: {
        name: 'é—œå…§é“',
        cities: {
          changan: {
            name: 'é•·å®‰',
            hasMarket: true,
            attractions: ['æ›²æ±Ÿæ± ', 'èŠ™è“‰åœ’'],
            hasPalace: true,
            bridge: true,
            priceMultiplier: 1.3
          },
          luoyang: {
            name: 'æ´›é™½',
            hasMarket: true,
            attractions: ['ç™½é¦¬å¯º', 'é¾é–€çŸ³çªŸ', 'ç‰¡ä¸¹åœ’'],
            bridge: true,
            priceMultiplier: 1.2
          }
        }
      },
      hebei: {
        name: 'æ²³åŒ—é“',
        cities: {
          youzhou: {
            name: 'å¹½å·',
            hasMarket: true,
            attractions: ['å¹½å·å°', 'èƒ¡äººé…’è‚†', 'ç‡•å±±'],
            bridge: true,
            priceMultiplier: 0.9
          }
        }
      },
      hedong: {
        name: 'æ²³æ±é“',
        cities: {
          taiyuan: {
            name: 'å¤ªåŸ',
            hasMarket: true,
            attractions: ['æ™‰ç¥ ', 'å¤©é¾å±±'],
            bridge: true,
            priceMultiplier: 1.0
          }
        }
      },
      henan: {
        name: 'æ²³å—é“',
        cities: {
          mengjin: {
            name: 'å­Ÿæ´¥',
            hasMarket: true,
            attractions: ['é»ƒæ²³æ¸¡å£', 'é¾é–€å±±'],
            bridge: true,
            priceMultiplier: 1.0
          },
          xingyang: {
            name: 'æ»é™½',
            hasMarket: true,
            attractions: ['è™ç‰¢é—œ', 'æ»æ¾¤'],
            bridge: true,
            priceMultiplier: 1.0
          },
          yanshi: {
            name: 'åƒå¸«',
            hasMarket: true,
            attractions: ['  é‡Œé ­', 'ç„å¥˜æ•…é‡Œ'],
            bridge: true,
            priceMultiplier: 1.0
          }
        }
      },
      shannan: {
        name: 'å±±   é“',
        cities: {
          xiangyang: {
            name: 'è¥„é™½',
            hasMarket: true,
            attractions: ['è¥„é™½  ', 'éš†ä¸­'],
            bridge: true,
            priceMultiplier: 1.0
          }
        }
      },
      huainan: {
        name: 'æ·®å—é“',
        cities: {
          yangzhou: {
            name: 'æšå·',
            hasMarket: true,
            attractions: ['ç˜¦è¥¿æ¹–', 'äºŒåå››æ©‹', 'å¤§æ˜å¯º'],
            bridge: true,
            priceMultiplier: 1.2
          }
        }
      },
      jiangnan: {
        name: 'æ±Ÿå—é“',
        cities: {
          suzhou: {
            name: 'è˜‡å·',
            hasMarket: true,
            attractions: ['å¯’å±±å¯º', 'è™ä¸˜', 'æ‹™æ”¿åœ’'],
            bridge: true,
            priceMultiplier: 1.2
          }
        }
      },
      jiannan: {
        name: 'åŠå—é“',
        cities: {
          chengdu: {
            name: 'æˆéƒ½',
            hasMarket: true,
            attractions: ['æœç”«è‰å ‚', 'æ­¦ä¾¯ç¥ ', 'é’åŸå±±'],
            bridge: true,
            priceMultiplier: 1.1
          }
        }
      },
      longright: {
        name: 'éš´å³é“',
        cities: {
          liangzhou: {
            name: 'æ¶¼å·',
            hasMarket: true,
            attractions: ['è‘¡è„åœ’', 'æ²™æ¼ ç¶ æ´²'],
            bridge: true,
            priceMultiplier: 0.8
          }
        }
      },
      lingnan: {
        name: 'å¶ºå—é“',
        cities: {
          guangzhou: {
            name: 'å»£å·',
            hasMarket: true,
            attractions: ['ç æ±Ÿ', 'å…‰å­å¯º'],
            bridge: true,
            priceMultiplier: 1.3
          }
        }
      }
    };

    // è©©è©è³‡æ–™åº«
    const poetryData = {
      changan_poverty: {
        location: 'é•·å®‰è¡—   ',
        cost: 0,
        requiredCondition: () => gameState.money < 30,
        stage1: {
          description: 'ä½ èº«ä¸Šæ‰€å‰©éŠ€å…©ç„¡å¹¾ï¼Œ   é•·å®‰è¡—é ­å¾˜å¾Šã€‚æ°é€¢  å²ä¹‹äº‚å¾Œï¼ŒåŸä¸­è•­ç‘Ÿï¼Œå¾€æ—¥ç¹è¯ä¸å†ã€‚ä½ çœ‹è¦‹ä¸€ä½ç™½é«®è€è€…ï¼Œæ­£å°è‘—æ®˜ç ´çš„å®®é—•è½  â€¦â€¦',
          choices: [
            { text: 'ğŸ‘€ ä¸Šå‰è©¢å•', action: 'ask' },
            { text: 'ğŸ’­ é»˜é»˜è§€å¯Ÿ', action: 'observe' }
          ]
        },
        stage2: {
          ask: 'è€è€…è¦‹ä½ è¡£è¡«è¥¤è¤¸ï¼Œå˜†æ¯é“ï¼šã€Œå¹´è¼•äººï¼Œä½ ä¹Ÿæ˜¯æˆ°äº‚ä¸­çš„æµæ°‘å—ï¼Ÿæ›¾ç¶“çš„é•·å®‰å•Šï¼Œå¦‚ä»Šåªå‰©ç ´æ•—â€¦â€¦ã€ä»–æŒ‡å‘é è™•çš„æ®˜å£æ–·å£ï¼Œçœ¼ä¸­æ»¿æ˜¯å“€å‚·ã€‚',
          observe: 'ä½ çœ‹è‘—è€è€…ï¼Œä»–çš„çœ¼æ·šæ»´è½åœ¨å¡µåœŸä¸Šã€‚çªç„¶ï¼Œä¸€ä½ä¸­å¹´æ–‡å£«èµ°ä¾†ï¼Œæ­£æ˜¯è©©è–æœç”«ã€‚ä»–çœ‹è‘—é€™ç‰‡å±±æ²³ï¼Œä½è²åŸèª¦â€¦â€¦'
        },
        stage3: {
          title: 'æ˜¥æœ›',
          author: 'æœç”«',
          verses: [
            'åœ‹ç ´å±±æ²³åœ¨',
            'åŸæ˜¥è‰æœ¨æ·±',
            'æ„Ÿ  èŠ±æ¿ºæ·š',
            'æ¨åˆ¥é³¥é©šå¿ƒ'
          ]
        },
        stage4: {
          description: 'æœç”«åŸå®Œè©©ï¼Œçœ‹å‘ä½ ï¼šã€Œå¹´è¼•äººï¼Œå³ä½¿åœ¨äº‚ä¸–ä¸­ï¼Œä¹Ÿä¸è¦æ”¾æ£„å¸Œæœ›ã€‚ã€ä»–å¾æ‡·ä¸­æå‡ºäº›   éŠ€å…©ï¼Œé   ä½ ï¼šã€Œæ‹¿è‘—å§ï¼Œå¸Œæœ›ä½ èƒ½çœ‹åˆ°å±±æ²³    å…‰çš„é‚£ä¸€å¤©ã€‚ã€',
          choices: [
            { text: 'ğŸ™ æ‹œè¬æœç”«', reward: { money: 50, quest: 'poetry' } }
          ]
        }
      },
      changan_palace: {
        location: 'å¤§æ˜å®®',
        cost: 1,
        requiredEvent: 'met_libai',
        stage1: {
          description: 'å¤šè™§æç™½å¼•è–¦ï¼Œä½ å¾—ä»¥é€²å…¥å¤§æ˜å®®ã€‚æ­£å€¼ç‰¡ä¸¹èŠ±   é–‹ï¼Œç„å®—çš‡å¸æ”œæ¥Šè²´å¦ƒåœ¨æ²‰é¦™äº­è³èŠ±ã€‚æç™½é†‰çœ¼  å¿ªï¼Œè¢«å¬ä¸Šä¾†è³¦è©©â€¦â€¦',
          choices: [
            { text: 'ğŸ‘€ è§€çœ‹æç™½è³¦è©©', action: 'watch' },
            { text: 'ğŸ’­ æš—ä¸­  å¯Ÿè²´å¦ƒ', action: 'observe' }
          ]
        },
        stage2: {
          watch: 'æç™½å¤§æ­¥ä¸Šå‰ï¼Œçµ²æ¯«ä¸æ‡¼å¤©å¨ã€‚   å®—ç¬‘é“ï¼šã€Œæå¿ï¼Œä»Šæ—¥ç‚ºæœ•è³¦è©©åŠ©èˆˆï¼ã€æç™½æç­†ç–¾æ›¸ï¼Œç­†èµ°é¾è›‡â€¦â€¦',
          observe: 'æ¥Šè²´å¦ƒå¬Œç¾åœ°çœ‹è‘—æ»¿åœ’ç‰¡ä¸¹ï¼Œåœ‹è‰²å¤©é¦™ã€‚ç„å®—ç›®å…‰æº«   ï¼Œæç™½è¦‹æ­¤æƒ…æ™¯ï¼Œéˆæ„Ÿæ¹§ç¾â€¦â€¦'
        },
        stage3: {
          title: 'æ¸…å¹³èª¿Â·å…¶ä¸€',
          author: 'æç™½',
          verses: [
            'é›²æƒ³è¡£è£³èŠ±æƒ³å®¹',
            'æ˜¥é¢¨æ‹‚æª»éœ²è¯æ¿ƒ',
            'è‹¥éç¾¤ç‰  é ­è¦‹',
            'æœƒå‘ç‘¤å°æœˆä¸‹é€¢'
          ]
        },
        stage4: {
          description: 'è©©ç•¢ï¼Œ  åº§å–å½©ã€‚æ¥Šè²´å¦ƒå«£ç„¶ä¸€ç¬‘ï¼Œç„å®—å¤§æ‚…ï¼Œç•¶å ´è³è³œåƒé‡‘   æç™½é†‰çœ¼çœ‹å‘ä½ ï¼Œèˆ‰æ¯é“ï¼šã€Œä»Šæ—¥èˆ‡å›åŒéŠï¼Œä¸æ‰æ­¤ç”Ÿï¼ã€',
          choices: [
            { text: 'ğŸ· èˆ‡æç™½å…±é£²', reward: { money: 100, quest: 'poetry' } }
          ]
        }
      },
      changan_huaqingchi: {
        location: 'è¯æ¸…æ± ',
        cost: 1,
        requiredEvent: 'met_libai',
        stage1: {
          description: 'ä½ éš¨æç™½    åˆ°é©ªå±±è…³ä¸‹çš„è¯æ¸…æ± ï¼Œæº«æ³‰æ°¤æ°³ç¹šç¹ã€‚é€™è£¡æ˜¯çš‡   è¡Œå®®ï¼Œæç™½å¼•ä½ å…¥å…§ã€‚ä½ çœ‹è¦‹æ± ç•”ç‰¡ä¸¹ç››é–‹ï¼Œæå¦‚ä»™å¢ƒ  â€¦',
          choices: [
            { text: 'ğŸµ è†è½æç™½è©©è©±', action: 'listen' },
            { text: 'â™¨ï¸ èµ°å‘æº«æ³‰', action: 'spring' }
          ]
        },
        stage2: {
          listen: 'æç™½é†‰çœ¼æƒºå¿ªï¼šã€Œç•¶å¹´ç„å®—èˆ‡è²´å¦ƒåœ¨æ­¤ï¼Œæˆ‘å¥‰   è³¦è©©ï¼Œé‚£å¯æ˜¯åƒå¤   è©±å•Šï¼ã€ä»–æç­†å¯«ä¸‹ç•¶å¹´çš„è©©ä½œâ€¦â€¦',
          spring: 'ä½ èµ°   æº«æ³‰ï¼Œç…™éœ§ä¸­ä¼¼ä¹é‚„èƒ½çœ‹  ç•¶å¹´çš„èº«å½±ã€‚æç™½åœ¨ä½ èº«é‚Šä½åŸèµ·èˆŠä½œâ€¦â€¦'
        },
        stage3: {
          title: 'æ¸…å¹³èª¿Â·å…¶äºŒ',
          author: 'æç™½',
          verses: [
            'ä¸€æç´…è‰·éœ²  é¦™',
            'é›²é›¨å·«å±±æ‰æ–·è…¸',
            'å€Ÿå•æ¼¢å®®èª°å¾—ä¼¼',
            'å¯æ†é£›ç‡•å€š   å¦'
          ]
        },
        stage4: {
          description: 'è©©  ä¸­é‚£ç››ä¸–é¢¨è¯ä»¤ä½ åš®å¾€ä¸å·²ã€‚æç™½  è‘—ä½ çš„è‚©è†€ï¼šã€Œç››ä¸–å·²é€ï¼Œä½†è©©æ„æ°¸å­˜ã€‚ä¾†ï¼Œæˆ‘å€‘ç¹¼çºŒéŠæ­·å¤©ä¸‹ï¼ã€',
          choices: [
            { text: 'ğŸ“œ è¨˜éŒ„è©©ä½œ', reward: { money: 30, quest: 'poetry' } }
          ]
        }
      },
      changan_qujiangchi: {
        location: 'æ›²æ±Ÿæ± ',
        cost: 1,
        stage1: {
          description: 'ä½ ä¾†åˆ°é•·å®‰è‘—åçš„      æ± ï¼Œæ¹–å…‰å±±è‰²ç¾ä¸å‹æ”¶ã€‚æ˜¥æ—¥è£¡ï¼Œæ–‡äºº   å£«èš   æ–¼æ­¤ï¼Œè©©é…’æµé€£ã€‚ä½ çœ‹è¦‹ä¸€ç¾¤å£«å­æ­£åœ¨æ¹–ç•”åŸè©©ä½œå°â€¦â€¦',
          choices: [
            { text: 'ğŸ“œ ä¸Šå‰è§€è³', action: 'watch' },
            { text: 'ğŸš¶ ç¨è‡ªæ¼«æ­¥', action: 'walk' }
          ]
        },
        stage2: {
          watch: 'ä¸€ä½é’å¹´æ‰ä¿Šæ­£åœ¨åŸè©©ï¼Œä»–çš„è©©å¥æ¸…æ–°è„«ä¿—ã€‚æ—äººè´Šå˜†ä¸å·²ï¼šã€Œæ­¤ä¹ƒæœç‰§æœå…¬å­ä¹‹  ä½œï¼ã€',
          walk: 'ä½ æ²¿è‘—æ¹–ç•”æ¼«   ï¼Œæ˜¥é¢¨æ‹‚é¢ã€‚çªç„¶è½è¦‹   äººåŸèª¦æœç‰§çš„è©©ä½œâ€¦â€¦'
        },
        stage3: {
          title: 'æ¸…æ˜',
          author: 'æœç‰§',
          verses: [
            'æ¸…æ˜æ™‚ç¯€é›¨ç´›ç´›',
            'è·¯ä¸Šè¡Œäººæ¬²æ–·é­‚',
            'å€Ÿå•é…’å®¶ä½•è™•æœ‰',
            'ç‰§ç«¥é™æŒ‡æèŠ±æ‘'
          ]
        },
        stage4: {
          description: 'è©©ä¸­é‚£ä»½æ¸…æ–°èˆ‡æƒ†æ‚µè®“ä½ æ·±æœ‰æ„Ÿè§¸ã€‚æ˜¥æ—¥çš„æ›²æ±Ÿæ± ï¼Œè¦‹è­‰äº†å¤šå°‘æ–‡äººçš„æ‰æƒ…èˆ‡æµªæ¼«â€¦â€¦',
          choices: [
            { text: 'ğŸ“œ   éŒ„æ­¤æ™¯', reward: { money: 25, quest: 'poetry' } }
          ]
        }
      },
      youzhou_jiulv: {
        location: 'èƒ¡äººé…’è‚†',
        cost: 1,
        stage1: {
          description: 'å¹½å·é‚Šå¡ä¹‹åœ°ï¼Œèƒ¡æ¼¢é›œè™•ã€‚ä½ èµ°é€²ä¸€å®¶èƒ¡äººé…’è‚†ï¼Œç¢§çœ¼é‡‘é«®çš„èƒ¡å§¬æ­£åœ¨èµ·èˆï¼ŒéŠ€éˆ´èˆ¬çš„ç¬‘è²è¿´ç›ªâ€¦â€¦',
          choices: [
            { text: 'ğŸ·   ä¸€å£ºé…’', action: 'drink' },
            { text: 'ğŸ’ƒ è§€çœ‹èˆè¹ˆ', action: 'dance' }
          ]
        },
        stage2: {
          drink: 'ä½ é»äº†è‘¡è„é…’ï¼Œèƒ¡å§¬ç¬‘è‘—ç‚ºä½ æ–Ÿé…’ã€‚å¥¹çš„æ¼¢èªé›–å¸¶å£éŸ³ï¼Œå»åˆ¥æœ‰é¢¨æƒ…ã€‚è§’è½è£¡æœ‰ä½å°‘å¹´éƒ   æ­£å‡è¦–è‘—å¥¹â€¦â€¦',
          dance: 'èƒ¡å§¬èˆå§¿æ›¼å¦™ï¼Œç•°åŸŸé¢¨æƒ…æ¿ƒéƒã€‚ä½ æ³¨æ„åˆ°ä¸€ä½ç™½è¡£å°‘å¹´ï¼Œç›®ä¸  ç›åœ°çœ‹è‘—å¥¹ï¼Œçœ¼ä¸­æ»¿æ˜¯æ„›æ…•â€¦â€¦'
        },
        stage3: {
          title: 'å°‘å¹´è¡Œ',
          author: 'æç™½',
          verses: [
            'äº”é™µ   å°‘é‡‘å¸‚æ±',
            'éŠ€éç™½é¦¬åº¦  é¢¨',
            'è½èŠ±è¸ç›¡éŠä½•è™•',
            'ç¬‘å…¥èƒ¡å§¬é…’è‚†ä¸­'
          ]
        },
        stage4: {
          description: 'å°‘å¹´éƒå¤§ç¬‘ï¼Œèˆ‰æ¯é‚€ä½ å…±é£²ã€‚èƒ¡å§¬ä¹Ÿç¬‘è‘—åŠ å…¥ã€‚é€™ä¸€åˆ»ï¼Œä½ æ·±æ·±æ„Ÿå—åˆ°å¤§å”çš„é–‹æ”¾èˆ‡åŒ…å®¹â€¦â€¦',
          choices: [
            { text: 'ğŸ’¬ èˆ‡èƒ¡å§¬äº¤è«‡', reward: { money: 25, quest: 's1' } },
            { text: 'ğŸš¶ é›¢é–‹é…’è‚†', reward: { money: 15, quest: 'poetry' } }
          ]
        }
      },
      yangzhou_bridge: {
        location: 'äºŒåå››æ©‹',
        cost: 1,
        stage1: {
          description: 'æšå·æ˜     ï¼Œä½ ä¾†åˆ°è‘—åçš„äºŒåå››æ©‹ã€‚æœˆè‰²å¦‚æ°´ï¼Œæ©‹å½±å©†å¨‘ã€‚é è™•å‚³ä¾†æ‚ æšçš„ç°«è²â€¦â€¦',
          choices: [
            { text: 'ğŸµ å¾ªè²å°‹æ‰¾', action: 'find' },
            { text: 'ğŸŒ™ ç¨è‡ªè³æœˆ', action: 'moon' }
          ]
        },
        stage2: {
          find: 'ä½ èµ°è¿‘æ©‹      çœ‹è¦‹ä¸€ä½ç™½è¡£å¥³å­æ­£åœ¨å¹ç°«ã€‚æ›²çµ‚ï¼Œå¥¹è¼•å˜†ä¸€è²ï¼Œä¼¼æœ‰å¿ƒäº‹â€¦â€¦',
          moon: 'ä½ å€šåœ¨æ©‹æ¬„ä¸Šè³æœˆï¼Œçªç„¶è½è¦‹æœ‰äººåŸè©©ï¼Œé‚£è²éŸ³å……æ»¿æ‡·å¿µâ€¦â€¦'
        },
        stage3: {
          title: 'å¯„æšå·éŸ“ç¶½åˆ¤å®˜',
          author: 'æœç‰§',
          verses: [
            'é’å±±éš±éš±æ°´è¿¢è¿¢',
            'ç§‹ç›¡æ±Ÿå—è‰æœªå‡‹',
            'äºŒåå››æ©‹æ˜æœˆå¤œ',
            'ç‰äººä½•è™•æ•™å¹ç°«'
          ]
        },
        stage4: {
          description: 'è©©ä¸­é‚£ä»½æ‡·å¿µèˆ‡æƒ†æ‚µï¼Œè®“ä½ æƒ³èµ·   é æ–¹çš„æ•…é„‰ã€‚æœˆå…‰ä¸‹ï¼Œä½ é»˜é»˜è¨˜ä¸‹é€™ä¸€åˆ»â€¦â€¦',
          choices: [
            { text: 'ğŸ“œ     éŒ„æ­¤æ™¯', reward: { money: 30, quest: 'poetry' } }
          ]
        }
      },
      chengdu_caotang: {
        location: 'æœç”«è‰å ‚',
        cost: 1,
        stage1: {
          description: 'ä½ ä¾†åˆ°æˆéƒ½éƒŠå¤–çš„æœç”«è‰å ‚ã€‚é€™åº§ç°¡  çš„èŒ…å±‹ï¼Œæ›¾æ˜¯è©©è–é¿é›£ä¹‹æ‰€ã€‚ç§‹é¢¨è•­ç‘Ÿï¼Œå±‹é ‚èŒ…è‰è¢«å¹å¾—ä¸ƒé›¶å…«è½â€¦â€¦',
          choices: [
            { text: 'ğŸ  é€²å…¥è‰å ‚', action: 'enter' },
            { text: 'ğŸ‚ åœ¨å¤–è§€å¯Ÿ', action: 'watch' }
          ]
        },
        stage2: {
          enter: 'è‰å ‚å…§ç°¡é™‹ç•°å¸¸ï¼Œä½†ä½ çœ‹è¦‹ç‰†ä¸Šæ›è‘—è¨±å¤šè©©ç¨¿ã€‚ç®¡ç†è€…å‘Šè¨´ä½ ï¼Œæœç”«åœ¨æ­¤å¯«ä¸‹è¨±å¤šåç¯‡â€¦â€¦',
          watch: 'çªç„¶ä¸€é™£ç‹‚é¢¨å¹ä¾†ï¼Œ  é ‚çš„èŒ…è‰ç´›ç´›é£›èˆã€‚ä½ å½·å½¿çœ‹è¦‹ç•¶å¹´æœç”«è¿½è¶•èŒ…è‰çš„èº«å½±ï¼Œå¿ƒä¸­æ„Ÿæ…¨è¬åƒâ€¦â€¦'
        },
        stage3: {
          title: 'èŒ…å±‹ç‚ºç§‹é¢¨æ‰€ç ´æ­Œ',
          author: 'æœç”«',
          verses: [
            '   æœˆç§‹é«˜é¢¨æ€’è™Ÿ',
            'å·æˆ‘å±‹ä¸Šä¸‰é‡èŒ…',
            'å®‰å¾—å»£  åƒè¬é–“',
            'å¤§åº‡å¤©ä¸‹å¯’å£«ä¿±æ­¡é¡'
          ]
        },
        stage4: {
          description: 'ã€Œå¤§åº‡å¤©ä¸‹å¯’å£«ä¿±æ­¡é¡ã€â€”â€”å³ä½¿è‡ªå·±å±…ç„¡å®šæ‰€ï¼Œæœç”«ä»å¿ƒç¹«  ä¸‹ã€‚ä½ è¢«é€™ç¨®èƒ¸æ‡·æ·±æ·±æ‰“å‹•â€¦â€¦',
          choices: [
            { text: 'ğŸ™ ç¥­æ‹œè©©è–', reward: { money: 35, quest: 'poetry' } }
          ]
        }
      }
    };

    // è¡—å¸‚çµ±ä¸€å•†åº—  ç½®
    const marketShops = [
      { name: 'æˆè¡£é‹ª', icon: 'ğŸ‘˜' },
      { name: '   åƒæ”¤', icon: 'ğŸœ' },
      { name: 'ç•¶  ', icon: 'ğŸ¦' },
      { name: 'å®¢æ£§', icon: 'ğŸ¨' },
      { name: 'é¦–é£¾é‹ª', icon: 'ğŸ’' },
      { name: 'æœè”¬æ”¤', icon: 'ğŸ¥¬' },
      { name: 'æ›¸åº—', icon: 'ğŸ“š' },
      { name: 'é›œç³§é‹ª', icon: 'ğŸŒ¾' },
      { name: 'éµé‹ª', icon: 'âš’ï¸' }
    ];

    // å•†åº—å•†å“è³‡æ–™
    const shopData = {
      'æˆè¡£é‹ª': {
        description: 'ã€Œå®¢å®˜è£¡é‚Šè«‹ï¼å°åº—å°ˆç‡Ÿå„å¼æˆè¡£ï¼Œå¾æ£‰å¸ƒåˆ°éŒ¦ç¶¢  æœ‰ç›¡æœ‰ã€‚æ‚¨æƒ³çœ‹é»ä»€éº¼ï¼Ÿã€',
        items: [
          { id: 'cloth1', name: 'æ£‰å¸ƒè¡£', icon: 'ğŸ‘˜', basePrice: 15, desc: 'å°‹å¸¸ç™¾å§“ç©¿è‘—' },
          { id: 'cloth2', name: 'çµ²ç¶¢è¢', icon: 'ğŸ¥»', basePrice: 50, desc: 'å¯Œæˆ¶äººå®¶å–œæ„›' },
          { id: 'cloth3', name: 'éŒ¦ç¹¡è¯æœ', icon: '  ', basePrice: 120, desc: 'å®˜å®¦åäººå°ˆå±¬', quest: 's2', triggerLibai: true }
        ]
      },
      'é¦–é£¾é‹ª': {
        description: 'ã€Œæ­¡è¿å…‰è‡¨ï¼å°åº—çš„é¦–é£¾éƒ½æ˜¯ä¸Š   è²¨è‰²ï¼Œé‡‘éŠ€ç‰çŸ³æ¨£æ¨£é½Šå…¨ã€‚å§‘å¨˜çœ‹ä¸­å“ªä»¶ï¼Ÿã€',
        items: [
          { id: 'jewelry1', name: 'éŠ€ç°ª', icon: 'ğŸ“Œ', basePrice: 30, desc: 'ç´”éŠ€æ‰“é€ ' },
          { id: 'jewelry2', name: 'ç‰ä½©', icon: 'ğŸ’', basePrice: 80, desc: 'å’Œç”°ç¾ç‰' },
          { id: 'jewelry3', name: 'é‡‘é‡µ', icon: 'ğŸ‘‘', basePrice: 150, desc: 'èµ¤é‡‘é‘²å¯¶' }
        ]
      },
      'å°åƒæ”¤': {
        description: 'ã€Œä¾†ä¾†ä¾†ï¼ç†±é¨°é¨°çš„å°åƒï¼Œä¿è­‰å¥½åƒï¼å®¢å®˜   åšé»ä»€éº¼ï¼Ÿã€',
        items: [
          { id: 'food1', name: '   é¤…', icon: 'ğŸ¥™', basePrice: 5, desc: 'èŠéº»é¦™è„†', quest: 's3' },
          { id: 'food2', name: 'ç¾Šè‚‰æ³¡é¥ƒ', icon: 'ğŸ²', basePrice: 8, desc: 'æ¹¯æ¿ƒè‚‰çˆ›', quest: 's3' },
          { id: 'food3', name: 'æ«»æ¡ƒç…', icon: 'ğŸ¡', basePrice: 12, desc: 'å®®å»·é»å¿ƒ', quest: 's3' }
        ]
      },
      'ç•¶é‹ª': {
        description: 'ã€Œæœ¬  æ”¶è³¼å„é¡ç‰©å“ï¼Œ   æ ¼å…¬é“ç«¥åŸç„¡æ¬ºï¼ã€',
        items: []
      },
      'å®¢æ£§': {
        description: 'ã€Œæ­¡è¿å…¥ä½ï¼ä¸Šç­‰å®¢æˆ¿ï¼Œä¹¾æ·¨èˆ’é©ï¼Œä¸€æ™šåªéœ€åå…©éŠ€å­ã€‚ã€',
        items: [
          { id: 'inn1', name: 'ä½å®¿ä¸€æ™š', icon: 'ğŸ›ï¸', basePrice: 10, desc: 'æ¢å¾©é«”åŠ›' }
        ]
      },
      'æœè”¬æ”¤': {
        description: 'ã€Œæ–°é®®æœè”¬ï¼å‰›   åœ°è£¡æ‘˜çš„ï¼Œæ°´éˆè‘—å‘¢ï¼ã€',
        items: [
          { id: 'fruit1', name: 'æ™‚ä»¤é®®æœ', icon: 'ğŸ‘', basePrice: 3, desc: 'ç•¶å­£æ°´æœ' },
          { id: 'veg1', name: 'æ–°é®®è”¬èœ', icon: 'ğŸ¥¬', basePrice: 2, desc: 'ç¿ ç¶ æ¬²æ»´' }
        ]
      },
      'æ›¸åº—': {
        description: 'ã€Œå°åº—å°ˆè³£å„é¡æ›¸ç±ï¼Œç¶“å²å­é›†ã€è©©è©æ­Œè³¦æ‡‰æœ‰ç›¡æœ‰ï¼ã€',
        items: [
          { id: 'book1', name: 'è©©è©   é›†', icon: 'ğŸ“–', basePrice: 20, desc: 'å”è©©ç²¾é¸' },
          { id: 'book2', name: 'éŠè¨˜é›œè«‡', icon: 'ğŸ“š', basePrice: 15, desc: 'å„   é¢¨åœŸ' }
        ]
      },
      'é›œç³§é‹ª': {
        description: 'ã€Œäº”ç©€é›œç³§ï¼Œç±³éºµæ²¹  ï¼Œå®¶ä¸­å¿…å‚™ï¼ã€',
        items: [
          { id: 'grain1', name: 'ç™½ç±³', icon: 'ğŸš', basePrice: 5, desc: 'ä¸Šç­‰å¥½ç±³' },
          { id: 'grain2', name: 'éºµç²‰', icon: 'ğŸŒ¾', basePrice: 4, desc: 'æ–°ç£¨éºµç²‰' }
        ]
      },
      'éµé‹ª': {
        description: 'ã€Œéµå™¨è¾²   ã€åˆ€åŠå…µå™¨ï¼Œæ¨£æ¨£ç²¾è‰¯ï¼ã€',
        items: [
          { id: 'iron1', name: 'çŸ­åˆ€', icon: 'ğŸ”ª', basePrice: 30, desc: 'é˜²èº«ä¹‹ç”¨' },
          { id: 'iron2', name: 'è¾²å…·', icon: 'âš’ï¸', basePrice: 15, desc: 'è€•ç¨®å¿…å‚™' }
        ]
      }
    };

    // Data SDK è™•  
    const dataHandler = {
      onDataChanged(data) {
        allSaveRecords = data;
      }
    };

    async function initSDK() {
      if (window.dataSdk) {
        const result = await window.dataSdk.init(dataHandler);
        if (!result.isOk) {
          console.error('Data SDK åˆ   åŒ–å¤±æ•—');
        }
      }

      if (window.elementSdk) {
        window.elementSdk.init({
          defaultConfig,
          onConfigChange: async (config) => {
            document.getElementById('gameTitle').textContent = config.game_title || defaultConfig.game_title;
          },
          mapToCapabilities: () => ({
            recolorables: [],
            borderables: [],
            fontEditable: undefined,
            fontSizeable: undefined
          }),
          mapToEditPanelValues: (config) => new Map([
            ['game_title', config.game_title || defaultConfig.game_title]
          ])
        });
      }
    }

    function showNarration(text) {
      const existing = document.querySelector('.narration');
      if (existing) existing.remove();
      
      const narration = document.createElement('div');
      narration.className = 'narration';
      narration.textContent = text;
      document.body.appendChild(narration);
      setTimeout(() => narration.remove(), 4000);
    }

    function updateUI() {
      const xun = gameState.day <= 10 ? 'ä¸Šæ—¬' : gameState.day <= 20 ? 'ä¸­æ—¬' : 'ä¸‹æ—¬';
      document.getElementById('seasonDisplay').textContent = `${seasonNames[gameState.season]} ${xun}`;
      document.getElementById('actionDisplay').textContent = `è¡Œå‹•é»: ${gameState.actionPoints}/${gameState.maxActionPoints}`;
      document.getElementById('moneyDisplay').textContent = `ğŸ’° ${gameState.money}å…©`;
      document.getElementById('modalMoneyDisplay').textContent = gameState.money;
      
      updateBackground();
      updateQuests();
    }

    function updateBackground() {
      const container = document.getElementById('gameContainer');
      if (gameState.actionPoints >= 4) {
        container.style.background = 'linear-gradient(135deg, #87CEEB 0%, #E6E6FA 50%, #DEB887 100%)';
      } else if (gameState.actionPoints >= 2) {
        container.style.background = 'linear-gradient(135deg, #FF7F50 0%, #FF6B9D 50%, #FFA07A 100%)';
      } else {
        container.style.background = 'linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%)';
      }
    }

    function updateQuests() {
      const mainHTML = gameState.mainQuests.map(q => {
        const progressText = q.target ? ` (${q.progress}/${q.target})` : '';
        return `<div class="quest-item ${q.completed ? 'completed' : ''}">
          ${q.text}${progressText}
          ${q.completed ? '<div style="color: #4caf50; margin-top: 5px;">âœ“ å·²å®Œæˆ</div>' : ''}
        </div>`;
      }).join('');
      document.getElementById('mainQuestList').innerHTML = mainHTML;

      const sideHTML = gameState.sideQuests.map(q => {
        const progressText = q.target ? ` (${q.progress}/${q.target})` : '';
        return `<div class="quest-item ${q.completed ? 'completed' : ''}">
          ${q.text}${progressText}
          ${q.completed ? '<div style="color: #4caf50; margin-top: 5px;">âœ“ å·²å®Œæˆ</div>' : ''}
        </div>`;
      }).join('');
      document.getElementById('sideQuestList').innerHTML = sideHTML;
    }

    function toggleQuestSection(type) {
      const list = document.getElementById(type + 'QuestList');
      const toggle = document.getElementById(type + 'Toggle');
      if (list.classList.contains('expanded')) {
        list.classList.remove('expanded');
        toggle.textContent = 'â–¼';
      } else {
        list.classList.add('expanded');
        toggle.textContent = 'â–²';
      }
    }

    function consumeActionPoint() {
      gameState.actionPoints--;
      if (gameState.actionPoints <= 0) {
        gameState.actionPoints = gameState.maxActionPoints;
        gameState.day++;
        
        if (gameState.day > 30) {
          gameState.day = 1;
          const currentIndex = seasons.indexOf(gameState.season);
          gameState.season = seasons[(currentIndex + 1) % 4];
          showNarration(`å­£ç¯€æ›´æ›¿ï¼Œç¾åœ¨æ˜¯${seasonNames[gameState.season]}äº†`);
        }
      }
      updateUI();
    }

    function switchScene(from, to) {
      const fromScene = document.getElementById(from);
      const toScene = document.getElementById(to);
      
      if (fromScene) {
        fromScene.classList.remove('active');
      }
      
      setTimeout(() => {
        if (toScene) {
          toScene.classList.add('active');
        }
      }, 100);
    }

    function goToNaming() {
      switchScene('sceneOpening', 'sceneNaming');
    }

    function confirmName() {
      const nameInput = document.getElementById('playerNameInput');
      const name = nameInput.value.trim();
      const errorDiv = document.getElementById('nameError');
      
      if (!name) {
        errorDiv.textContent = 'è«‹è¼¸å…¥ä½ çš„å§“åï¼';
        return;
      }
      
      if (name.length > 10) {
        errorDiv.textContent = 'å§“åä¸å¯è¶…é10å€‹å­—ï¼';
        return;
      }
      
      gameState.playerName = name;
      document.getElementById('gameUI').style.display = 'block';
      updateUI();
      switchScene('sceneNaming', 'sceneRegionMap');
      showNarration(`   å°äºŒç¬‘é“ï¼šã€Œ${name}å®¢å®˜å¥½åå­—ï¼ç¥æ‚¨ä¸€è·¯å¹³å®‰ï¼ã€`);
    }

    function startNewGame() {
      // éš±è—å°é¢ï¼Œé¡¯ç¤ºé–‹å ´åŠ‡æƒ…
      const cover = document.getElementById('sceneCover');
      const opening = document.getElementById('sceneOpening');
      
      if (cover) cover.classList.remove('active');
      
      setTimeout(() => {
        if (opening) opening.classList.add('active');
      }, 100);
    }

    function enterRegion(regionKey) {
      const region = regionData[regionKey];
      if (!region) {
        showNarration('æ­¤é“è·¯å°šæœªé–‹é€šï¼Œè«‹ç¨å¾Œå†ä¾†ï¼');
        return;
      }

      gameState.currentRegion = regionKey;
      document.getElementById('currentRegionName').textContent = region.name;

      const cities = region.cities;
      let cityHTML = '';
      
      Object.keys(cities).forEach(cityKey => {
        const city = cities[cityKey];
        cityHTML += `
          <div class="city-select-card" onclick="enterCity('${cityKey}')">
            <div class="city-select-icon">ğŸ›ï¸</div>
            <div class="city-select-name">${city.name}</div>
          </div>
        `;
      });

      document.getElementById('citySelectGrid').innerHTML = cityHTML;
      switchScene('sceneRegionMap', 'sceneCitySelect');
    }

    function enterCity(cityKey) {
      const region = regionData[gameState.currentRegion];
      const city = region.cities[cityKey];
      if (!city) return;

      gameState.currentCity = cityKey;
      
      if (!gameState.visitedCities.includes(cityKey)) {
        gameState.visitedCities.push(cityKey);
        const quest = gameState.mainQuests.find(q => q.id === 'q1');
        if (quest && !quest.completed) {
          quest.progress++;
          if (quest.progress >= quest.target) {
            quest.completed = true;
            showNarration('ä¸»ç·šä»»å‹™å®Œæˆï¼šæ¢ç´¢å¤§å”å„é“åŸå¸‚ï¼');
          }
        }
      }

      if (cityKey === 'changan' && gameState.money < 30 && !gameState.completedPoetry.includes('changan_poverty')) {
        startPoetryInteraction('changan_poverty');
        return;
      }

      document.getElementById('currentCityName').textContent = city.name;

      let locationsHTML = '';
      
      if (city.hasMarket) {
        locationsHTML += `
          <div class="location-card" onclick="enterMarket()">
            <div class="location-icon">ğŸª</div>
            <div class="location-label">è¡—å¸‚</div>
          </div>
        `;
      }

      city.attractions.forEach(attr => {
        locationsHTML += `
          <div class="location-card" onclick="visitAttraction('${attr}')">
            <div class="location-icon">ğŸ›ï¸</div>
            <div class="location-label">${attr}</div>
          </div>
        `;
      });

      if (city.hasPalace) {
        const hasLibai = gameState.completedEvents.includes('met_libai');
        const lockedClass = hasLibai ? '' : 'locked';
        const clickHandler = hasLibai ? `enterPalace()` : `cannotEnterPalace()`;
        
        locationsHTML += `
          <div class="location-card ${lockedClass}" onclick="${clickHandler}">
            <div class="location-icon">ğŸ‘‘</div>
            <div class="location-label">çš‡å®®</div>
            ${!hasLibai ? '<div class="location-note">éœ€çµäº¤æç™½</div>' : ''}
          </div>
        `;
      }

      if (city.bridge) {
        locationsHTML += `
          <div class="location-card" onclick="sleepUnderBridge()">
            <div class="location-icon">   </div>
            <div class="location-label">æ©‹ä¸‹éå¤œ</div>
          </div>
        `;
      }

      document.getElementById('cityLocations').innerHTML = locationsHTML;
      switchScene('sceneCitySelect', 'sceneCityMap');
      updateUI();
    }

    function cannotEnterPalace() {
      showNarration('æ­¤è™•éœ€è¦ç†Ÿäººå¼•è–¦æ‰èƒ½é€²å…¥â€¦â€¦åœ¨   å¸‚è³¼è²·è¯æœæˆ–è¨±èƒ½é‡åˆ°è²´äºº');
    }

    function enterPalace() {
      if (gameState.actionPoints <= 0) {
        showNarration('ä»Šæ—¥è¡Œå‹•é»å·²ç”¨ç›¡ï¼');
        return;
      }

      let palaceHTML = `
        <div class="location-card" onclick="startPoetryInteraction('changan_palace')">
          <div class="location-icon">ğŸ‘‘</div>
          <div class="location-label">å¤§æ˜å®®</div>
        </div>
        <div class="location-card" onclick="startPoetryInteraction('changan_huaqingchi')">
          <div class="location-icon">â™¨ï¸</div>
          <div class="location-label">è¯æ¸…æ± </div>
        </div>
      `;

      document.getElementById('palaceLocations').innerHTML = palaceHTML;
      switchScene('sceneCityMap', 'scenePalace');
    }

    function backToCityMapFromPalace() {
      switchScene('scenePalace', 'sceneCityMap');
    }

    function enterMarket() {
      const city = regionData[gameState.currentRegion].cities[gameState.currentCity];
      document.getElementById('marketTitle').textContent = `${city.name} è¡—å¸‚`;

      let shopsHTML = '';
      marketShops.forEach(shop => {
        shopsHTML += `
          <div class="market-shop-card" onclick="enterShop('${shop.name}')">
            <div class="location-icon">${shop.icon}</div>
            <div class="location-label">${shop.name}</div>
          </div>
        `;
      });

      document.getElementById('marketShops').innerHTML = shopsHTML;
      switchScene('sceneCityMap', 'sceneMarket');
    }

    function enterShop(shopName) {
      if (gameState.actionPoints <= 0) {
        showNarration('ä»Šæ—¥è¡Œå‹•é»å·²ç”¨ç›¡ï¼');
        return;
      }

      currentShopType = shopName;

      if (shopName === 'ç•¶é‹ª') {
        showPawnShop();
        return;
      }

      if (shopName === 'å®¢æ£§') {
        showInn();
        return;
      }

      const shop = shopData[shopName];
      if (!shop) {
        showNarration('æ­¤åº—  æœªé–‹å¼µï¼Œè«‹ç¨å¾Œå†ä¾†ï¼');
        return;
      }

      const city = regionData[gameState.currentRegion].cities[gameState.currentCity];
      const multiplier = city.priceMultiplier;

      let html = `
        <h2 class="shop-title">${shopName}</h2>
        <div class="shop-description">${shop.description}</div>
        <div class="money-display">æŒæœ‰éŠ€å…©ï¼š<span id="shopMoneyDisplay">${gameState.money}</span> å…©</div>
        <div class="shop-items">
      `;

      if (shop.items.length > 0) {
        shop.items.forEach(item => {
          const price = Math.round(item.basePrice * multiplier);
          html += `
            <div class="shop-item" onclick='buyItem(${JSON.stringify({...item, price})})'>
              <div class="shop-item-icon">${item.icon}</div>
              <div class="shop-item-name">${item.name}</div>
              <div style="font-size: 1.1em; color: #b3e5d8; margin: 8px 0;">${item.desc}</div>
              <div class="shop-item-price">${price} å…©</div>
            </div>
          `;
        });
      } else {
        html += '<p style="color: #b3e5d8; text-align: center; grid-column: 1/-1;">æš«ç„¡å•†å“</p>';
      }

      html += `
        </div>
        <div style="text-align: center; margin-top: 30px;">
          <button class="back-btn" onclick="backToMarket()">è¿”å›è¡—å¸‚</button>
        </div>
      `;

      document.getElementById('shopContainer').innerHTML = html;
      switchScene('sceneMarket', 'sceneShop');
    }

    function showPawnShop() {
      let html = `
        <h2 class="shop-title">ç•¶é‹ª</h2>
        <div class="shop-description">ã€Œæœ¬åº—æ”¶è³¼å„é¡ç‰©å“ï¼Œåƒ¹æ ¼å…¬é“ç«¥åŸç„¡æ¬ºï¼ã€</div>
        <div class="money-display">æŒæœ‰éŠ€å…©ï¼š<span id="shopMoneyDisplay">${gameState.money}</span> å…©</div>
      `;

      if (gameState.inventory.length === 0) {
        html += '<p style="color: #b3e5d8; text-align: center; margin: 30px 0; font-size: 1.4em;">ä½ èº«ä¸Šæ²’æœ‰å¯ä»¥å…¸ç•¶çš„ç‰©å“</p>';
      } else {
        html += '<div class="shop-items">';
        gameState.inventory.forEach((item, index) => {
          html += `
            <div class="shop-item" onclick="sellItem(${index})">
              <div class="shop-item-icon">${item.icon}</div>
              <div class="shop-item-name">${item.name}</div>
              <div class="shop-item-price">è³£å‡º ${item.value}    </div>
            </div>
          `;
        });
        html += '</div>';
      }

      html += `
        <div style="text-align: center; margin-top: 30px;">
          <button class="back-btn" onclick="backToMarket()">è¿”å›è¡—å¸‚</button>
        </div>
      `;

      document.getElementById('shopContainer').innerHTML = html;
      switchScene('sceneMarket', 'sceneShop');
    }

    function sellItem(index) {
      const item = gameState.inventory[index];
      gameState.money += item.value;
      gameState.inventory.splice(index, 1);
      
      showNarration(`è³£å‡ºäº†${item.name}ï¼Œç²å¾—${item.value}å…©éŠ€å­ï¼`);
      updateUI();
      
      setTimeout(() => {
        showPawnShop();
      }, 1500);
    }

    function showInn() {
      let html = `
        <h2 class="shop-title">å®¢æ£§</h2>
        <div class="shop-description">ã€Œæ­¡è¿å…¥ä½ï¼ä¸Šç­‰å®¢æˆ¿ï¼Œä¹¾æ·¨èˆ’é©ï¼Œä¸€æ™šåªéœ€åå…©éŠ€å­ã€‚ä½å®¿å¯æ¢å¾©æ‰€æœ‰è¡Œå‹•é»ï¼ã€</div>
        <div class="money-display">æŒæœ‰éŠ€å…©ï¼š<span id="shopMoneyDisplay">${gameState.money}</span>    </div>
        <div class="shop-items">
          <div class="shop-item" onclick="stayAtInn()">
            <div class="shop-item-icon">ğŸ›ï¸</div>
            <div class="shop-item-name">ä½å®¿ä¸€æ™š</div>
            <div style="font-size: 1.1em; color: #b3e5d8; margin: 8px 0;">æ¢å¾©æ‰€æœ‰è¡Œå‹•é»</div>
            <div class="shop-item-price">10 å…©</div>
          </div>
        </div>
        <div style="text-align: center; margin-top: 30px;">
          <button class="back-btn" onclick="backToMarket()">è¿”å›è¡—å¸‚</button>
        </div>
      `;

      document.getElementById('shopContainer').innerHTML = html;
      switchScene('sceneMarket', 'sceneShop');
    }

    function stayAtInn() {
      if (gameState.money < 10) {
        showNarration('éŠ€å…©ä¸è¶³ï¼');
        return;
      }

      gameState.money -= 10;
      gameState.actionPoints = gameState.maxActionPoints;
      gameState.day++;

      if (gameState.day > 30) {
        gameState.day = 1;
        const currentIndex = seasons.indexOf(gameState.season);
        gameState.season = seasons[(currentIndex + 1) % 4];
        showNarration(`åœ¨å®¢æ£§ç¾ç¾ç¡äº†ä¸€è¦ºï¼Œå­£ç¯€æ›´æ›¿ï¼Œç¾åœ¨æ˜¯${seasonNames[gameState.season]}äº†`);
      } else {
        showNarration('åœ¨å®¢æ£§ç¾ç¾ç¡äº†ä¸€è¦ºï¼Œç²¾ç¥ç…¥ç™¼ï¼');
      }

      updateUI();
      setTimeout(() => {
        backToMarket();
      }, 2000);
    }

    function buyItem(item) {
      if (gameState.money < item.price) {
        showNarration('éŠ€å…©ä¸è¶³ï¼');
        return;
      }

      gameState.money -= item.price;
      gameState.inventory.push({ id: item.id, name: item.name, icon: item.icon, value: Math.round(item.price * 0.6) });
      
      if (item.triggerLibai && !gameState.completedEvents.includes('met_libai')) {
        gameState.completedEvents.push('met_libai');
        const quest = gameState.mainQuests.find(q => q.id === 'q3');
        if (quest) quest.completed = true;
        showNarration('ä½ ç©¿ä¸Šè¯æœå¾Œæ°£  éå‡¡ï¼Œåœ¨è¡—é ­å·§é‡æç™½ï¼æç™½å°ä½ ä¸€è¦‹å¦‚æ•…ï¼Œé‚€ä½ åŒéŠçš‡å®®ï¼');
      } else {
        showNarration(`è³¼è²·äº†${item.name}ï¼`);
      }

      consumeActionPoint();
      updateUI();

      if (item.quest) {
        const quest = [...gameState.mainQuests, ...gameState.sideQuests].find(q => q.id === item.quest);
        if (quest && !quest.completed) {
          if (quest.target) {
            quest.progress++;
            if (quest.progress >= quest.target) {
              quest.completed = true;
              showNarration(`ä»»å‹™å®Œæˆï¼š${quest.text}ï¼`);
            }
          } else {
            quest.completed = true;
            showNarration(`ä»»å‹™å®Œæˆï¼š${quest.text}ï¼`);
          }
        }
      }

      document.getElementById('shopMoneyDisplay').textContent = gameState.money;
    }

    function visitAttraction(attraction) {
      if (gameState.actionPoints <= 0) {
        showNarration('ä»Šæ—¥è¡Œå‹•é»å·²ç”¨ç›¡ï¼');
        return;
      }

      const cityKey = gameState.currentCity;
      
      if (cityKey === 'changan' && attraction === 'æ›²æ±Ÿ  ') {
        startPoetryInteraction('changan_qujiangchi');
        return;
      }
      if (cityKey === 'yangzhou' && attraction === 'äºŒåå››æ©‹') {
        startPoetryInteraction('yangzhou_bridge');
        return;
      }
      if (cityKey === 'youzhou' && attraction === 'èƒ¡äººé…’è‚†') {
        startPoetryInteraction('youzhou_jiulv');
        return;
      }
      if (cityKey === 'chengdu' && attraction === 'æœç”«è‰å ‚') {
        startPoetryInteraction('chengdu_caotang');
        return;
      }

      consumeActionPoint();
      showNarration(`ä½ æ¬£è³äº†${attraction}çš„ç¾æ™¯ï¼Œæš«ç„¡æ›´å¤šè©©è©æ•…äº‹ï¼Œæ•¬è«‹æœŸå¾…å¾ŒçºŒæ›´æ–°ï¼`);
    }

    function startPoetryInteraction(poetryKey) {
      currentPoetryKey = poetryKey;
      currentPoetryStage = 1;
      showPoetryStage1();
    }

    function showPoetryStage1() {
      const poetry = poetryData[currentPoetryKey];
      const stage = poetry.stage1;

      const choicesHTML = stage.choices.map(c => 
        `<button class="choice-btn" onclick="handlePoetryChoice('${c.action}')">${c.text}</button>`
      ).join('');

      document.getElementById('poetryContainer').innerHTML = `
        <div class="poetry-description">${stage.description}</div>
        <div class="poetry-choices">${choicesHTML}</div>
      `;
      
      const fromScene = document.querySelector('.scene.active').id;
      switchScene(fromScene, 'scenePoetry');
    }

    function handlePoetryChoice(action) {
      if (currentPoetryStage === 1) {
        showPoetryStage2(action);
      }
    }

    function showPoetryStage2(action) {
      currentPoetryStage = 2;
      const poetry = poetryData[currentPoetryKey];
      const text = poetry.stage2[action];

      document.getElementById('poetryContainer').innerHTML = `
        <div class="poetry-description">${text}</div>
        <div class="poetry-choices">
          <button class="choice-btn" onclick="revealPoetry()">âœï¸ è©©äººé–‹å§‹åŸè©©â€¦â€¦</button>
        </div>
      `;
    }

    function revealPoetry() {
      currentPoetryStage = 3;
      const poetry = poetryData[currentPoetryKey];
      const stage = poetry.stage3;

      const versesHTML = stage.verses.map((v, i) => 
        `<div class="poetry-reveal-verse" style="animation-delay: ${i * 1.8}s">${v}</div>`
      ).join('');

      document.getElementById('poetryRevealContainer').innerHTML = `
        <h2 class="poetry-reveal-title" style="animation: fadeInVerse 2s ease forwards;">ã€Š${stage.title}   </h2>
        <p class="poetry-reveal-author" style="animation: fadeInVerse 2s ease forwards; animation-delay: 0.8s;">ä½œè€…ï¼š${stage.author}</p>
        ${versesHTML}
        <button class="continue-btn" onclick="showPoetryStage4()" style="opacity: 0; animation: fadeInVerse 1.5s ease forwards; animation-delay: ${stage.verses.length * 1.8 + 1.5}s;">ç¹¼çºŒ</button>
      `;

      switchScene('scenePoetry', 'scenePoetryReveal');

      setTimeout(() => {
        document.querySelectorAll('.poetry-reveal-verse').forEach(v => v.classList.add('show'));
      }, 100);
    }

    function showPoetryStage4() {
      currentPoetryStage = 4;
      const poetry = poetryData[currentPoetryKey];
      const stage = poetry.stage4;

      const choicesHTML = stage.choices.map(c => 
        `<button class="choice-btn" onclick='completePoetry(${JSON.stringify(c.reward)})'>${c.text}</button>`
      ).join('');

      document.getElementById('poetryContainer').innerHTML = `
        <div class="poetry-description">${stage.description}</div>
        <div class="poetry-choices">${choicesHTML}</div>
      `;

      switchScene('scenePoetryReveal', 'scenePoetry');
    }

    function completePoetry(reward) {
      gameState.money += reward.money;

      if (reward.quest === 'poetry') {
        if (!gameState.completedPoetry.includes(currentPoetryKey)) {
          gameState.completedPoetry.push(currentPoetryKey);
          
          const quest = gameState.mainQuests.find(q => q.id === 'q2');
          if (quest && !quest.completed) {
            quest.progress++;
            if (quest.progress >= quest.target) {
              quest.completed = true;
              showNarration('ä¸»ç·šä»»å‹™å®Œæˆï¼šæ”¶  è©©è©ï¼');
            }
          }
        }
      } else if (reward.quest) {
        const quest = [...gameState.mainQuests, ...gameState.sideQuests].find(q => q.id === reward.quest);
        if (quest && !quest.completed) {
          if (quest.target) {
            quest.progress++;
            if (quest.progress >= quest.target) {
              quest.completed = true;
            }
          } else {
            quest.completed = true;
          }
          showNarration(`ä»»å‹™å®Œæˆï¼š${quest.text}ï¼`);
        }
      }

      consumeActionPoint();
      updateUI();
      showNarration(`ç²å¾— ${reward.money} å…©éŠ€å­ï¼`);
      
      setTimeout(() => {
        if (currentPoetryKey === 'changan_palace' || currentPoetryKey === 'changan_huaqingchi') {
          switchScene('scenePoetry', 'scenePalace');
        } else {
          switchScene('scenePoetry', 'sceneCityMap');
        }
      }, 2000);
    }

    function sleepUnderBridge() {
      if (gameState.actionPoints <= 0) {
        showNarration('ä»Šæ—¥è¡Œå‹•é»å·²ç”¨ç›¡ï¼');
        return;
      }

      if (gameState.season === 'winter') {
        gameState.bridgeSleepCount++;
        if (gameState.bridgeSleepCount >= 3) {
          showNarration('ä½ åœ¨å†¬å­£æ©‹æ´å—å‡éå¤šï¼Œä¸å¹¸ç—…é€â€¦â€¦éŠæˆ²çµ  ');
          setTimeout(() => {
            document.getElementById('gameUI').style.display = 'none';
            switchScene('sceneCityMap', 'sceneCover');
          }, 3000);
          return;
        }
        showNarration('åœ¨å¯’å†·çš„æ©‹ä¸‹ç‘Ÿç‘Ÿç™¼æŠ–â€¦â€¦');
      } else {
        const random = Math.random();
        if (random < 0.3 && gameState.inventory.length > 0) {
          const lostItem = gameState.inventory.splice(Math.floor(Math.random() * gameState.inventory.length), 1)[0];
          showNarration(`å¤œè£¡é­é‡ç›œè³Šï¼Œå¤±å»äº†${lostItem.name}ï¼`);
        } else {
          showNarration('åœ¨æ©‹ä¸‹å‹‰å¼·åº¦é  å¤œ');
        }
      }

      consumeActionPoint();
      updateUI();
    }

    function openInventory() {
      const itemsHTML = gameState.inventory.length > 0 ? 
        gameState.inventory.map(item => `
          <div class="inventory-item">
            <div class="item-icon">${item.icon}</div>
            <div class="item-name">${item.name}</div>
            <div class="item-value">åƒ¹å€¼ ${item.value} å…©</div>
          </div>
        `).join('') : 
        '<p style="color: #b3e5d8; text-align: center; grid-column: 1/-1;">      ç©ºç©ºå¦‚ä¹Ÿ</p>';

      document.getElementById('inventoryGrid').innerHTML = itemsHTML;
      document.getElementById('inventoryModal').classList.add('active');
    }

    function closeInventory() {
      document.getElementById('inventoryModal').classList.remove('active');
    }

    function openSaveModal() {
      const timestamp = new Date().toLocaleString('zh-TW');
      document.getElementById('saveNameInput').value = `${gameState.playerName}çš„å­˜æª”_${timestamp}`;
      document.getElementById('saveModal').classList.add('active');
    }

    function closeSaveModal() {
      document.getElementById('saveModal').classList.remove('active');
    }

    async function confirmSave() {
      const saveName = document.getElementById('saveNameInput').value.trim();
      if (!saveName) {
        showNarration('è«‹è¼¸å…¥å­˜æª”åç¨±ï¼');
        return;
      }

      if (allSaveRecords.length >= 999) {
        showNarration('å­˜æª”æ•¸é‡å·²é”ä¸Šé™ï¼ˆ999å€‹ï¼‰ï¼');
        return;
      }

      const saveData = {
        save_name: saveName,
        player_name: gameState.playerName,
        money: gameState.money,
        season: gameState.season,
        day: gameState.day,
        action_points: gameState.actionPoints,
        current_region: gameState.currentRegion,
        current_city: gameState.currentCity,
        bridge_sleep_count: gameState.bridgeSleepCount,
        inventory: JSON.stringify(gameState.inventory),
        main_quests: JSON.stringify(gameState.mainQuests),
        side_quests: JSON.stringify(gameState.sideQuests),
        visited_poetry: JSON.stringify(gameState.visitedPoetry),
        completed_poetry: JSON.stringify(gameState.completedPoetry),
        completed_events: JSON.stringify(gameState.completedEvents),
        merchant_investments: JSON.stringify(gameState.merchantInvestments),
        save_timestamp: new Date().toISOString()
      };

      const result = await window.dataSdk.create(saveData);
      if (result.isOk) {
        showNarration('å­˜æª”æˆåŠŸï¼');
        closeSaveModal();
      } else {
        showNarration('å­˜æª”å¤±æ•—ï¼Œè«‹ç¨  å†è©¦ï¼');
      }
    }

    function openLoadModal() {
      if (allSaveRecords.length === 0) {
        showNarration('   æœ‰å­˜æª”è¨˜éŒ„ï¼');
        return;
      }

      const savesHTML = allSaveRecords.map(save => {
        const saveDate = new Date(save.save_timestamp).toLocaleString('zh-TW');
        return `
          <div class="save-item" onclick='loadSaveFile(${JSON.stringify(save.__backendId)})'>
            <div class="save-item-name">${save.save_name}</div>
            <div class="save-item-info">
              ${save.player_name} | ğŸ’° ${save.money}å…© | ${seasonNames[save.season]}<br>
              ğŸ“… ${saveDate}
            </div>
          </div>
        `;
      }).join('');

      document.getElementById('saveList').innerHTML = savesHTML;
      document.getElementById('loadModal').classList.add('active');
    }

    function closeLoadModal() {
      document.getElementById('loadModal').classList.remove('active');
    }

    function loadSaveFile(backendId) {
      const save = allSaveRecords.find(s => s.__backendId === backendId);
      if (!save) return;

      gameState = {
        playerName: save.player_name,
        money: save.money,
        season: save.season,
        day: save.day,
        actionPoints: save.action_points,
        maxActionPoints: 5,
        currentRegion: save.current_region,
        currentCity: save.current_city,
        bridgeSleepCount: save.bridge_sleep_count,
        inventory: JSON.parse(save.inventory),
        mainQuests: JSON.parse(save.main_quests),
        sideQuests: JSON.parse(save.side_quests),
        visitedPoetry: JSON.parse(save.visited_poetry),
        completedPoetry: JSON.parse(save.completed_poetry),
        completedEvents: JSON.parse(save.completed_events || '[]'),
        merchantInvestments: JSON.parse(save.merchant_investments || '[]'),
        visitedCities: []
      };

      document.getElementById('gameUI').style.display = 'block';
      updateUI();
      closeLoadModal();
      switchScene('sceneCover', 'sceneRegionMap');
      showNarration('è®€å–å­˜æª”æˆåŠŸï¼');
    }

    function backToMarket() {
      switchScene('sceneShop', 'sceneMarket');
    }

    function backToCityMap() {
      switchScene('sceneMarket', 'sceneCityMap');
    }

    function backToCitySelect() {
      switchScene('sceneCityMap', 'sceneCitySelect');
    }

    function backToRegionMap() {
      switchScene('sceneCitySelect', 'sceneRegionMap');
    }

    initSDK();
    updateUI();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9a8899d9734a3317',t:'MTc2NDgyMjk2Ny4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
